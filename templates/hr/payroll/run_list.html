{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load custom_filters %}
{% load pricing_filters %}

{% block title %}مسيرات الرواتب{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<link rel="stylesheet" href="{% static 'css/tables.css' %}">
<!-- جميع الستايلات موجودة في shared-components.css و components.css -->
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Page Header المركزي -->
  {% include "shared/page_header.html" %}

  <div class="section-container">
    <h5 class="section-title"><i class="fas fa-chart-bar me-2"></i>الإحصائيات</h5>
    <div class="row">
      <div class="col-md-3 mb-3"><div class="stats-card stats-card-primary"><div class="stats-card-header"></div><div class="stats-card-body"><div class="stats-card-icon"><i class="fas fa-calculator"></i></div><div class="stats-card-title">إجمالي المسيرات</div><div class="stats-card-value">{{ total_runs|default:"0" }}</div><div class="stats-card-unit">مسيرة</div></div></div></div>
      <div class="col-md-3 mb-3"><div class="stats-card stats-card-success"><div class="stats-card-header"></div><div class="stats-card-body"><div class="stats-card-icon"><i class="fas fa-check-circle"></i></div><div class="stats-card-title">مكتملة</div><div class="stats-card-value">{{ completed_runs|default:"0" }}</div><div class="stats-card-unit">مسيرة</div></div></div></div>
      <div class="col-md-3 mb-3"><div class="stats-card stats-card-warning"><div class="stats-card-header"></div><div class="stats-card-body"><div class="stats-card-icon"><i class="fas fa-clock"></i></div><div class="stats-card-title">جزئية</div><div class="stats-card-value">{{ partial_runs|default:"0" }}</div><div class="stats-card-unit">مسيرة</div></div></div></div>
      <div class="col-md-3 mb-3"><div class="stats-card stats-card-info"><div class="stats-card-header"></div><div class="stats-card-body"><div class="stats-card-icon"><i class="fas fa-money-bill-wave"></i></div><div class="stats-card-title">إجمالي المبالغ</div><div class="stats-card-value">{{ total_amount|remove_trailing_zeros|default:"0" }}</div><div class="stats-card-unit">{% currency_symbol %}</div></div></div></div>
    </div>
  </div>

  <div class="section-container">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i>قائمة مسيرات الرواتب</h5>
        <div class="d-flex gap-2">
          <!-- فلتر السنة -->
          <select class="form-select form-select-sm" id="yearFilter" style="width: auto;">
            <option value="">جميع السنوات</option>
            {% for year in available_years %}
              <option value="{{ year.year }}" {% if year.year == selected_year %}selected{% endif %}>
                {{ year.year }}
              </option>
            {% endfor %}
          </select>
          <a href="{% url 'hr:payroll_run_process' %}" class="btn btn-sm btn-primary"><i class="fas fa-plus me-1"></i>إنشاء مسيرة رواتب</a>
        </div>
      </div>
      <div class="card-body">
        {% with table_id="payrollRunsTable" %}
          {% with headers=runs_headers %}
            {% with data=payroll_runs %}
              {% with action_buttons=runs_action_buttons %}
                {% with primary_key="month_str" %}
                  {% with empty_message="لا توجد مسيرات رواتب" %}
                    {% with show_currency=True %}
                      {% with clickable_rows=True %}
                        {% with row_click_url="/hr/payroll-runs/0/" %}
                          {% include "components/data_table.html" %}
                        {% endwith %}
                      {% endwith %}
                    {% endwith %}
                  {% endwith %}
                {% endwith %}
              {% endwith %}
            {% endwith %}
          {% endwith %}
        {% endwith %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/global-table.js' %}"></script>

<!-- Modal للحذف -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" id="deleteModalContent">
      <!-- المحتوى سيتم تحميله ديناميكياً -->
    </div>
  </div>
</div>

<script>
// دالة لفتح مودال الحذف
function openDeleteModal(month) {
    fetch(`/hr/payroll-runs/${month}/delete/`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('deleteModalContent').innerHTML = html;
            
            // تنفيذ السكريبت المحمل في المحتوى
            const scripts = document.getElementById('deleteModalContent').querySelectorAll('script');
            scripts.forEach(script => {
                const newScript = document.createElement('script');
                newScript.textContent = script.textContent;
                document.body.appendChild(newScript);
                document.body.removeChild(newScript);
            });
            
            var modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ في تحميل نموذج الحذف');
        });
}

$(document).ready(function() {
    if ($('#payrollRunsTable').length) {
        var table = $('#payrollRunsTable').DataTable({
            language: {
                url: "{% static 'js/datatables/ar.json' %}"
            },
            pageLength: 25,
            order: [[0, 'desc']], // ترتيب حسب الشهر - الأحدث أولاً
            dom: 'rt<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            searching: true,
            ordering: true,
            info: true,
            paging: true
        });
        
        // ربط مربع البحث الخارجي
        $('.table-search[data-table="payrollRunsTable"]').on('keyup', function() {
            table.search(this.value).draw();
        });
        
        // ربط قائمة عدد العناصر
        $('.table-length[data-table="payrollRunsTable"]').on('change', function() {
            table.page.len(parseInt(this.value)).draw();
        });
    }
    
    // فلتر السنة
    $('#yearFilter').on('change', function() {
        var year = $(this).val();
        var url = new URL(window.location.href);
        if (year) {
            url.searchParams.set('year', year);
        } else {
            url.searchParams.delete('year');
        }
        window.location.href = url.toString();
    });
});
</script>
{% endblock %}
