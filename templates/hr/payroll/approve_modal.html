{% load custom_filters %}
{% load pricing_filters %}

<!-- Modal Header -->
<div class="modal-header bg-success text-white">
    <h5 class="modal-title">
        <i class="fas fa-check-circle me-2"></i>
        اعتماد قسيمة راتب {{ payroll.employee.get_full_name_ar }}
    </h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<!-- Modal Body -->
<div class="modal-body">
    <!-- تحذير -->
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>تحذير:</strong> اعتماد قسيمة الراتب سيؤدي إلى:
        <ul class="mt-2 mb-0">
            <li>تغيير حالة الكشف إلى "معتمد"</li>
            <li>إنشاء قيد محاسبي تلقائي</li>
            <li>عدم إمكانية التعديل بعد الاعتماد</li>
        </ul>
    </div>

    <!-- تفاصيل القسيمة -->
    <div class="row g-3">
        <div class="col-md-6">
            <div class="info-box">
                <small class="text-muted">الموظف</small>
                <div class="fw-bold">{{ payroll.employee.get_full_name_ar }}</div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="info-box">
                <small class="text-muted">رقم الموظف</small>
                <div class="fw-bold">{{ payroll.employee.employee_number }}</div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="info-box">
                <small class="text-muted">القسم</small>
                <div>{{ payroll.employee.department.name_ar }}</div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="info-box">
                <small class="text-muted">الوظيفة</small>
                <div>{{ payroll.employee.job_title.title_ar }}</div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="info-box">
                <small class="text-muted">الشهر</small>
                <div class="fw-bold">{{ payroll.month|arabic_month_year }}</div>
            </div>
        </div>
    </div>

    <!-- الإجماليات -->
    <div class="mt-4">
        <div class="row g-2">
            <div class="col-md-4">
                <div class="summary-box bg-light">
                    <small class="text-muted">إجمالي الراتب</small>
                    <div class="fs-5 fw-bold text-primary">{{ payroll.gross_salary|remove_trailing_zeros }} ج.م</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="summary-box bg-light">
                    <small class="text-muted">إجمالي الخصومات</small>
                    <div class="fs-5 fw-bold text-danger">{{ payroll.total_deductions|remove_trailing_zeros }} ج.م</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="summary-box bg-success-subtle">
                    <small class="text-muted">صافي الراتب</small>
                    <div class="fs-4 fw-bold text-success">{{ payroll.net_salary|remove_trailing_zeros }} ج.م</div>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج الاعتماد -->
    <form method="post" id="approveForm" action="{% url 'hr:payroll_approve' payroll.pk %}">
        {% csrf_token %}
    </form>
</div>

<!-- Modal Footer -->
<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        <i class="fas fa-times me-2"></i>
        إلغاء
    </button>
    <button type="button" class="btn btn-success" id="confirmApproveBtn">
        <i class="fas fa-check me-2"></i>
        تأكيد الاعتماد
    </button>
</div>

<style>
.info-box {
    padding: 0.75rem;
    background: var(--gray-50);
    border-radius: 6px;
}

.summary-box {
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
}
</style>

<script>
// إضافة event listener للزر عند تحميل المحتوى
document.addEventListener('DOMContentLoaded', function() {
    const confirmBtn = document.getElementById('confirmApproveBtn');
    if (confirmBtn) {
        confirmBtn.addEventListener('click', confirmApprove);
    }
});

// أو إضافة event listener فوراً إذا كان الزر موجود
setTimeout(() => {
    const confirmBtn = document.getElementById('confirmApproveBtn');
    if (confirmBtn) {
        confirmBtn.addEventListener('click', confirmApprove);
    }
}, 100);

function confirmApprove() {
    Swal.fire({
        title: 'تأكيد الاعتماد',
        html: `
            <p class="mb-3">سيتم اعتماد قسيمة راتب <strong>{{ payroll.employee.get_full_name_ar }}</strong></p>
            <div class="alert alert-info">
                <strong>صافي الراتب: {{ payroll.net_salary|remove_trailing_zeros }} ج.م</strong>
            </div>
            <p class="text-warning mb-0"><i class="fas fa-exclamation-triangle me-2"></i>لن تتمكن من التعديل بعد الاعتماد</p>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'نعم، اعتمد القسيمة',
        cancelButtonText: 'إلغاء',
        reverseButtons: true,
        focusCancel: true
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'جاري الاعتماد...',
                html: 'يرجى الانتظار',
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            const form = document.getElementById('approveForm');
            const formData = new FormData(form);
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'تم الاعتماد!',
                        text: data.message,
                        confirmButtonColor: '#28a745'
                    }).then(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('approveModal'));
                        if (modal) modal.hide();
                        window.location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'خطأ!',
                        text: data.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ!',
                    text: 'حدث خطأ أثناء الاعتماد',
                    confirmButtonColor: '#dc3545'
                });
            });
        }
    });
}
</script>
