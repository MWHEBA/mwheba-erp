{% load widget_tweaks %}
{% load i18n %}

<form id="quickAddForm" method="post" action="{% url 'hr:salary_component_quick_add' employee.id %}">
    {% csrf_token %}
    
    <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
            <i class="fas fa-bolt me-2"></i>إضافة سريعة من قالب
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>
    
    <div class="modal-body">
        <div class="mb-3">
            <label class="form-label">{{ form.template.label }}</label>
            {{ form.template|add_class:"form-select" }}
            {% if form.template.errors %}
                <div class="invalid-feedback d-block">{{ form.template.errors.0 }}</div>
            {% endif %}
            <small class="text-muted">اختر قالب جاهز لإضافته بسرعة</small>
        </div>

        <div class="mb-3">
            <label class="form-label">{{ form.amount.label }}</label>
            {{ form.amount|add_class:"form-control" }}
            {% if form.amount.errors %}
                <div class="invalid-feedback d-block">{{ form.amount.errors.0 }}</div>
            {% endif %}
            <small class="text-muted">اتركه فارغاً لاستخدام المبلغ الافتراضي من القالب</small>
        </div>

        <div class="mb-3">
            <label class="form-label">{{ form.effective_from.label }}</label>
            {{ form.effective_from|add_class:"form-control" }}
            {% if form.effective_from.errors %}
                <div class="invalid-feedback d-block">{{ form.effective_from.errors.0 }}</div>
            {% endif %}
        </div>

        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}
    </div>
    
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>إلغاء
        </button>
        <button type="submit" class="btn btn-success">
            <i class="fas fa-bolt me-2"></i>إضافة سريعة
        </button>
    </div>
</form>

<script>
document.getElementById('quickAddForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري الإضافة...';
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ✅ إغلاق المودال الصحيح باستخدام ID محدد
            const modalElement = document.getElementById('quickAddModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
            
            // ✅ إزالة backdrop يدوياً (في حالة بقائه)
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // ✅ إزالة class من body
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
            
            Swal.fire({
                icon: 'success',
                title: 'نجح!',
                text: data.message,
                timer: 2000
            }).then(() => location.reload());
        } else {
            if (data.errors) {
                for (const [field, errors] of Object.entries(data.errors)) {
                    const fieldElement = document.querySelector(`[name="${field}"]`);
                    if (fieldElement) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback d-block';
                        errorDiv.textContent = errors.join(', ');
                        fieldElement.parentNode.appendChild(errorDiv);
                    }
                }
            }
        }
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
});
</script>
