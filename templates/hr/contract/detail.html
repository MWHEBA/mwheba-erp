{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load custom_filters %}
{% load utils_extras %}

{% block title %}ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<link rel="stylesheet" href="{% static 'css/cards.css' %}">
<style>
/* ØªØµÙ…ÙŠÙ… Ø¹Ø§Ù… */
.section-container {
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    padding: 1.5rem;
    margin-bottom: 1.8rem;
    border: 1px solid rgba(0, 0, 0, 0.05);
}

.section-title {
    color: #344767;
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 1.2rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #eee;
}

/* Tabs Ù…ÙØ­Ø³Ù‘Ù†Ø© */
.custom-tabs {
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 2rem;
}

.custom-tabs .nav-link {
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--text-muted);
    padding: 1rem 1.5rem;
    font-weight: 500;
    transition: all 0.2s;
}

.custom-tabs .nav-link:hover {
    color: var(--primary-color);
    background: transparent;
}

.custom-tabs .nav-link.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    background: transparent;
}

/* Timeline Ù…ÙØ­Ø³Ù‘Ù† */
.timeline-compact {
    position: relative;
    padding: 1rem 0;
}

.timeline-compact-item {
    position: relative;
    padding-right: 35px;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.timeline-compact-item:last-child {
    border-bottom: none;
}

.timeline-compact-marker {
    position: absolute;
    right: 0;
    top: 5px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.timeline-compact-content {
    display: flex;
    justify-content: space-between;
    align-items: start;
    gap: 1rem;
}

.timeline-compact-title {
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
}

.timeline-compact-desc {
    font-size: 0.85rem;
    color: var(--text-muted);
}

.timeline-compact-time {
    font-size: 0.75rem;
    color: var(--text-muted);
    white-space: nowrap;
}

/* Section Container */
.section-container {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.05);
}

/* Table Ù…Ø­Ø³Ù‘Ù† */
.salary-table {
    margin-bottom: 0;
}

.salary-table th {
    background: var(--bg-light);
    font-weight: 600;
    font-size: 0.85rem;
    padding: 0.75rem;
}

.salary-table td {
    padding: 0.75rem;
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© -->
    <div class="mb-4">
        <!-- Breadcrumbs -->
        <div class="mb-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}"><i class="fas fa-home me-1"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'hr:dashboard' %}"><i class="fas fa-users-cog me-1"></i>Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'hr:contract_list' %}"><i class="fas fa-file-contract me-1"></i>Ø§Ù„Ø¹Ù‚ÙˆØ¯</a></li>
                    <li class="breadcrumb-item active">{{ contract.contract_number }}</li>
                </ol>
            </nav>
        </div>
        
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center bg-white p-3 rounded shadow-sm">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="fas fa-file-contract fa-2x text-primary"></i>
                </div>
                <div>
                    <h1 class="h3 mb-1">
                        Ø¹Ù‚Ø¯ Ø±Ù‚Ù… {{ contract.contract_number }}
                        {% include 'hr/contract/cells/status.html' with value=contract.status %}
                    </h1>
                    <p class="text-muted mb-0">
                        <strong>{{ contract.employee.get_full_name_ar }} - {{ contract.employee.employee_number }}</strong> â€¢ Ù…Ù† ØªØ§Ø±ÙŠØ® {{ contract.start_date|date:"d/m/Y" }}{% if contract.end_date %} â†’ {{ contract.end_date|date:"d/m/Y" }}{% endif %}
                    </p>
                    {% if contract.status == 'renewed' and contract.renewed_to %}
                    <div class="alert alert-info mt-2 mb-0 py-2">
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯</strong> - ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ø§Ù„Ø¹Ù‚Ø¯ Ø±Ù‚Ù… 
                        <a href="{% url 'hr:contract_detail' contract.renewed_to.pk %}" class="alert-link">
                            <strong>{{ contract.renewed_to.contract_number }}</strong>
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'hr:contract_form_edit' contract.pk %}" class="btn btn-warning">
                    <i class="fas fa-edit me-2"></i>ØªØ¹Ø¯ÙŠÙ„
                </a>
                
                {% if contract.status == 'draft' %}
                <a href="{% url 'hr:contract_activate' contract.pk %}" class="btn btn-success">
                    <i class="fas fa-check me-2"></i>ØªÙØ¹ÙŠÙ„
                </a>
                
                {% elif contract.status == 'active' %}
                <a href="{% url 'hr:contract_suspend' contract.pk %}" class="btn btn-secondary">
                    <i class="fas fa-pause me-2"></i>Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª
                </a>
                {% if contract.end_date %}
                <a href="{% url 'hr:contract_renew' contract.pk %}" class="btn btn-info">
                    <i class="fas fa-redo me-2"></i>ØªØ¬Ø¯ÙŠØ¯
                </a>
                {% endif %}
                <a href="{% url 'hr:contract_terminate' contract.pk %}" class="btn btn-danger">
                    <i class="fas fa-ban me-2"></i>Ø¥Ù†Ù‡Ø§Ø¡
                </a>
                
                {% elif contract.status == 'suspended' %}
                <a href="{% url 'hr:contract_reactivate' contract.pk %}" class="btn btn-success">
                    <i class="fas fa-play me-2"></i>Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„
                </a>
                <a href="{% url 'hr:contract_renew' contract.pk %}" class="btn btn-info">
                    <i class="fas fa-redo me-2"></i>ØªØ¬Ø¯ÙŠØ¯
                </a>
                
                {% elif contract.status == 'expired' or contract.status == 'terminated' %}
                <a href="{% url 'hr:contract_renew' contract.pk %}" class="btn btn-info">
                    <i class="fas fa-redo me-2"></i>ØªØ¬Ø¯ÙŠØ¯
                </a>
                
                {% elif contract.status == 'renewed' %}
                <!-- Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø²Ø±Ø§Ø± - Ø§Ù„Ø¹Ù‚Ø¯ ØªÙ… ØªØ¬Ø¯ÙŠØ¯Ù‡ -->
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div class="section-container">
        <h5 class="section-title"><i class="fas fa-chart-bar me-2"></i>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h5>
        <div class="row">
            <div class="col-md-6 col-lg-3 mb-4">
                <div class="stats-card stats-card-primary">
                    <div class="stats-card-header"></div>
                    <div class="stats-card-body">
                        <div class="stats-card-icon">
                            <i class="fas fa-money-check"></i>
                        </div>
                        <div class="stats-card-title">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</div>
                        <div class="stats-card-value">{{ contract.basic_salary|custom_number_format }}</div>
                        <small class="text-muted">{% currency_symbol %}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3 mb-4">
                <div class="stats-card stats-card-success">
                    <div class="stats-card-header"></div>
                    <div class="stats-card-body">
                        <div class="stats-card-icon">
                            <i class="fas fa-plus-circle"></i>
                        </div>
                        <div class="stats-card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª</div>
                        <div class="stats-card-value">{{ contract.total_earnings|custom_number_format }}</div>
                        <small class="text-muted">{% currency_symbol %}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3 mb-4">
                <div class="stats-card stats-card-danger">
                    <div class="stats-card-header"></div>
                    <div class="stats-card-body">
                        <div class="stats-card-icon">
                            <i class="fas fa-minus-circle"></i>
                        </div>
                        <div class="stats-card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª</div>
                        <div class="stats-card-value">{{ contract.total_deductions|custom_number_format }}</div>
                        <small class="text-muted">{% currency_symbol %}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3 mb-4">
                <div class="stats-card stats-card-info">
                    <div class="stats-card-header"></div>
                    <div class="stats-card-body">
                        <div class="stats-card-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <div class="stats-card-title">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨</div>
                        <div class="stats-card-value">{{ contract.net_salary|custom_number_format }}</div>
                        <small class="text-muted">{% currency_symbol %}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Ù„Ù„Ù…Ø­ØªÙˆÙ‰ -->
    <ul class="nav nav-tabs custom-tabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#details-tab">
                <i class="fas fa-info-circle me-1"></i>Ø§Ù„ØªÙØ§ØµÙŠÙ„
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#salary-tab">
                <i class="fas fa-money-bill-wave me-1"></i>Ø§Ù„Ø±Ø§ØªØ¨
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#increases-tab">
                <i class="fas fa-chart-line me-1"></i>Ø§Ù„Ø²ÙŠØ§Ø¯Ø§Øª
                {% if scheduled_increases.count > 0 %}
                <span class="badge bg-success ms-1">{{ scheduled_increases.count }}</span>
                {% endif %}
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#documents-tab">
                <i class="fas fa-paperclip me-1"></i>Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#amendments-tab">
                <i class="fas fa-history me-1"></i>Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                {% if contract.amendments.count > 0 %}
                <span class="badge bg-primary ms-1">{{ contract.amendments.count }}</span>
                {% endif %}
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#terms-tab">
                <i class="fas fa-file-alt me-1"></i>Ø§Ù„Ø´Ø±ÙˆØ·
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
        <div class="tab-pane fade show active" id="details-tab">
            <div class="row">
                <div class="col-lg-8">
                    <div class="section-container">
                        <h5 class="mb-3"><i class="fas fa-file-contract me-2"></i>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯</h5>
                        <table class="table table-bordered">
                            <tr>
                                <th width="30%">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
                                <td><strong>{{ contract.contract_number }}</strong></td>
                            </tr>
                            <tr>
                                <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                <td>
                                    <strong>{{ contract.employee.get_full_name_ar }}</strong><br>
                                    <small class="text-muted">{{ contract.employee.employee_number }}</small>
                                </td>
                            </tr>
                            <tr>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø¯</th>
                                <td>{% include 'hr/contract/cells/contract_type.html' with value=contract.contract_type object=contract %}</td>
                            </tr>
                            {% if contract.job_title %}
                            <tr>
                                <th>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                                <td>
                                    <i class="fas fa-briefcase me-1 text-primary"></i>
                                    <strong>{{ contract.job_title }}</strong>
                                </td>
                            </tr>
                            {% endif %}
                            {% if contract.department %}
                            <tr>
                                <th>Ø§Ù„Ù‚Ø³Ù…</th>
                                <td>
                                    <i class="fas fa-building me-1 text-info"></i>
                                    {{ contract.department }}
                                </td>
                            </tr>
                            {% endif %}
                            <tr>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
                                <td>{{ contract.start_date|date:"d/m/Y" }}</td>
                            </tr>
                            <tr>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th>
                                <td>
                                    {% if contract.end_date %}
                                        {{ contract.end_date|date:"d/m/Y" }}
                                    {% else %}
                                        <span class="badge bg-secondary">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if contract.probation_period_months %}
                            <tr>
                                <th>ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±Ø¨Ø©</th>
                                <td>{{ contract.probation_period_months }} Ø´Ù‡Ø±</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="section-container">
                        <h5 class="mb-3"><i class="fas fa-chart-line me-2"></i>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h5>
                        <div class="mb-3">
                            <small class="text-muted d-block mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</small>
                            <strong>{{ contract.created_at|date:"d/m/Y" }}</strong>
                        </div>
                        {% if contract.created_by %}
                        <div class="mb-3">
                            <small class="text-muted d-block mb-1">Ø£Ù†Ø´Ø¦ Ø¨ÙˆØ§Ø³Ø·Ø©</small>
                            <strong>{{ contract.created_by.get_full_name }}</strong>
                        </div>
                        {% endif %}
                        {% if contract.end_date %}
                        <div class="mb-3">
                            <small class="text-muted d-block mb-1">Ù…Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø¯</small>
                            <strong>{{ contract.duration_months|default:"ØºÙŠØ± Ù…Ø­Ø¯Ø¯" }} Ø´Ù‡Ø±</strong>
                        </div>
                        {% endif %}
                        {% if contract.days_until_expiry and contract.status == 'active' %}
                        <div class="mb-3">
                            <small class="text-muted d-block mb-1">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</small>
                            <h4 class="mb-0 {% if contract.days_until_expiry < 30 %}text-warning{% else %}text-info{% endif %}">
                                {{ contract.days_until_expiry }} ÙŠÙˆÙ…
                            </h4>
                        </div>
                        {% endif %}
                        {% if contract.employee.biometric_user_id %}
                        <div class="mb-3">
                            <small class="text-muted d-block mb-1">Ø±Ù‚Ù… Ø§Ù„Ø¨ØµÙ…Ø©</small>
                            <strong>
                                <i class="fas fa-fingerprint me-1 text-success"></i>
                                {{ contract.employee.biometric_user_id }}
                            </strong>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ø±Ø§ØªØ¨ -->
        <div class="tab-pane fade" id="salary-tab">
            <div class="section-container">
            <h5 class="mb-3"><i class="fas fa-money-bill-wave me-2"></i>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø§ØªØ¨</h5>
            
            <!-- Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ -->
            <div class="mb-4">
                <h6 class="text-primary mb-2"><i class="fas fa-money-check me-2"></i>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</h6>
                <div class="p-3 bg-light rounded">
                    <strong class="h4 text-success">{{ contract.basic_salary|custom_number_format }} {{ system_settings.currency_symbol|default:'Ø¬Ù†ÙŠÙ‡' }}</strong>
                </div>
            </div>

            <!-- Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ© -->
            {% if contract.has_annual_increase %}
            <div class="mb-4">
                <h6 class="text-info mb-2"><i class="fas fa-chart-line me-2"></i>Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©</h6>
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <small class="text-muted d-block">Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØ§Ø¯Ø©</small>
                                <strong>
                                    {% if contract.annual_increase_type == 'percentage' %}
                                        <i class="fas fa-percentage me-1 text-primary"></i>Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ©
                                    {% elif contract.annual_increase_type == 'fixed' %}
                                        <i class="fas fa-coins me-1 text-success"></i>Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª
                                    {% endif %}
                                </strong>
                            </div>
                            <div class="col-md-6 mb-3">
                                <small class="text-muted d-block">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø²ÙŠØ§Ø¯Ø©</small>
                                <strong class="text-success">
                                    {% if contract.annual_increase_type == 'percentage' %}
                                        {{ contract.annual_increase_percentage|custom_number_format }}%
                                    {% elif contract.annual_increase_type == 'fixed' %}
                                        {{ contract.annual_increase_amount|custom_number_format }} {{ system_settings.currency_symbol|default:'Ø¬Ù†ÙŠÙ‡' }}
                                    {% endif %}
                                </strong>
                            </div>
                            <div class="col-md-6 mb-3">
                                <small class="text-muted d-block">Ø´Ù‡Ø± ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø²ÙŠØ§Ø¯Ø©</small>
                                <strong>
                                    <i class="fas fa-calendar me-1 text-info"></i>
                                    {{ contract.get_annual_increase_month_display }}
                                </strong>
                            </div>
                            <div class="col-md-6 mb-3">
                                <small class="text-muted d-block">Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©</small>
                                <strong class="text-primary">
                                    {{ contract.calculated_annual_increase|custom_number_format }} {{ system_settings.currency_symbol|default:'Ø¬Ù†ÙŠÙ‡' }}
                                </strong>
                            </div>
                            <div class="col-md-6 mb-3">
                                <small class="text-muted d-block">Ø§Ù„Ø±Ø§ØªØ¨ Ø¨Ø¹Ø¯ Ø§Ù„Ø²ÙŠØ§Ø¯Ø©</small>
                                <strong class="text-success h5 mb-0">
                                    {{ contract.salary_after_increase|custom_number_format }} {{ system_settings.currency_symbol|default:'Ø¬Ù†ÙŠÙ‡' }}
                                </strong>
                            </div>
                            {% if contract.next_increase_date %}
                            <div class="col-md-6 mb-3">
                                <small class="text-muted d-block">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</small>
                                <strong>
                                    <i class="fas fa-calendar-check me-1 text-warning"></i>
                                    {{ contract.next_increase_date|date:"d/m/Y" }}
                                    {% if contract.days_until_next_increase %}
                                        <span class="badge bg-warning text-dark ms-1">
                                            Ø¨Ø¹Ø¯ {{ contract.days_until_next_increase }} ÙŠÙˆÙ…
                                        </span>
                                    {% endif %}
                                </strong>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª -->
            {% with earnings=contract.employee.salary_components.all|dictsort:"order" %}
            {% if earnings %}
            <div class="mb-4">
                <h6 class="text-success mb-2"><i class="fas fa-plus-circle me-2"></i>Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Ø§Ù„Ø¨Ù†Ø¯</th>
                                <th width="200">Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ©</th>
                                <th width="150" class="text-center">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for component in earnings %}
                            {% if component.component_type == 'earning' %}
                            <tr>
                                <td>{{ component.name }}</td>
                                <td>
                                    {% if component.formula %}
                                        <code class="text-muted small">{{ component.formula|translate_formula }}</code>
                                    {% else %}
                                        <span class="text-muted small">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <strong>{{ component.amount|custom_number_format }}</strong>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
            {% endwith %}

            <!-- Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª -->
            {% with deductions=contract.employee.salary_components.all|dictsort:"order" %}
            {% if deductions %}
            <div class="mb-4">
                <h6 class="text-danger mb-2"><i class="fas fa-minus-circle me-2"></i>Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Ø§Ù„Ø¨Ù†Ø¯</th>
                                <th width="200">Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ©</th>
                                <th width="150" class="text-center">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for component in deductions %}
                            {% if component.component_type == 'deduction' %}
                            <tr>
                                <td>{{ component.name }}</td>
                                <td>
                                    {% if component.formula %}
                                        <code class="text-muted small">{{ component.formula|translate_formula }}</code>
                                    {% else %}
                                        <span class="text-muted small">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <strong>{{ component.amount|custom_number_format }}</strong>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
            {% endwith %}

            </div>
        </div>

        <!-- Ø§Ù„Ø²ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ø³Ù†ÙˆÙŠØ© -->
        <div class="tab-pane fade" id="increases-tab">
            <div class="section-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Ø§Ù„Ø²ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ø³Ù†ÙˆÙŠØ© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</h5>
                </div>
                
                {% if contract.has_annual_increase %}
                    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ© -->
                    <div class="alert alert-success">
                        <h6 class="alert-heading"><i class="fas fa-check-circle me-2"></i>Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ© Ù…ÙØ¹Ù„Ø©</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <small class="text-muted d-block">Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©</small>
                                <strong class="h5">{{ contract.annual_increase_percentage }}%</strong>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted d-block">Ø§Ù„ØªÙƒØ±Ø§Ø±</small>
                                <strong>{{ contract.get_increase_frequency_display }}</strong>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted d-block">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø§Ø­ØªØ³Ø§Ø¨</small>
                                <strong>{{ contract.get_increase_start_reference_display }}</strong>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted d-block">Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</small>
                                <strong class="text-primary">
                                    {% if contract.next_increase_date %}
                                        {{ contract.next_increase_date|date:"d/m/Y" }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </strong>
                            </div>
                        </div>
                    </div>

                    <!-- ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ø¨Ù‚Ø© -->
                    <h6 class="mb-3"><i class="fas fa-history me-2"></i>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ø¨Ù‚Ø©</h6>
                    {% with annual_increases=contract.employee.salary_components.filter|dictsort:"created_at" %}
                    {% if annual_increases %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø¨Ù†Ø¯</th>
                                    <th class="text-center">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th class="text-center">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th>
                                    <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for component in annual_increases %}
                                {% if "Ø²ÙŠØ§Ø¯Ø© Ø³Ù†ÙˆÙŠØ©" in component.name %}
                                <tr>
                                    <td>
                                        <i class="fas fa-chart-line text-success me-2"></i>
                                        <strong>{{ component.name }}</strong>
                                    </td>
                                    <td class="text-center">
                                        <strong class="text-success">{{ component.amount|floatformat:2 }} Ø¬Ù†ÙŠÙ‡</strong>
                                    </td>
                                    <td class="text-center">
                                        {{ component.created_at|date:"d/m/Y" }}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ component.notes|default:"-" }}</small>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Ù„Ù… ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø£ÙŠ Ø²ÙŠØ§Ø¯Ø§Øª Ø¨Ø¹Ø¯. Ø³ÙŠØªÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ: <strong>{{ contract.next_increase_date|date:"d/m/Y" }}</strong>
                    </div>
                    {% endif %}
                    {% endwith %}

                {% else %}
                    <div class="alert alert-warning">
                        <h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ© ØºÙŠØ± Ù…ÙØ¹Ù„Ø©</h6>
                        <p class="mb-0">Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©ØŒ Ù‚Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØªÙØ¹ÙŠÙ„ Ø®ÙŠØ§Ø± "ÙŠØ³ØªØ­Ù‚ Ø²ÙŠØ§Ø¯Ø© Ø³Ù†ÙˆÙŠØ©".</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª -->
        <div class="tab-pane fade" id="documents-tab">
            <div class="section-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-paperclip me-2"></i>Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙˆØ§Ù„ÙˆØ«Ø§Ø¦Ù‚</h5>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadDocumentModal">
                        <i class="fas fa-upload me-1"></i>Ø±ÙØ¹ Ù…Ø±ÙÙ‚
                    </button>
                </div>
                
                {% if contract.documents.all %}
                {% include 'components/data_table.html' with headers=documents_headers data=contract.documents.all table_id='documents-table' empty_message='Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª' show_search=True show_length_menu=True show_controls=True %}
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª -->
        <div class="tab-pane fade" id="amendments-tab">
            <div class="section-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</h5>
                </div>
                
                {% if contract.amendments.all %}
                <div class="timeline-compact">
                    {% for amendment in contract.amendments.all|slice:":10" %}
                    <div class="timeline-compact-item">
                        <div class="timeline-compact-marker {% if amendment.is_automatic %}bg-success{% else %}bg-primary{% endif %}"></div>
                        <div class="timeline-compact-content">
                            <div>
                                <div class="timeline-compact-title">
                                    {{ amendment.get_amendment_type_display }}
                                    {% if amendment.is_automatic %}
                                    <span class="badge bg-success ms-1" style="font-size: 0.7rem;">ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
                                    {% endif %}
                                </div>
                                <div class="timeline-compact-desc">{{ amendment.description }}</div>
                                {% if amendment.old_value or amendment.new_value %}
                                <div class="mt-1 small">
                                    <span class="text-danger">{{ amendment.old_value|default:"-" }}</span>
                                    <i class="fas fa-arrow-left mx-1"></i>
                                    <span class="text-success">{{ amendment.new_value|default:"-" }}</span>
                                </div>
                                {% endif %}
                            </div>
                            <div class="timeline-compact-time">
                                {{ amendment.created_at|date:"d/m/Y H:i" }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø¯
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Ø§Ù„Ø´Ø±ÙˆØ· -->
        <div class="tab-pane fade" id="terms-tab">
            <div class="section-container">
                <h5 class="mb-3"><i class="fas fa-file-alt me-2"></i>Ø§Ù„Ø¨Ù†ÙˆØ¯ ÙˆØ§Ù„Ø´Ø±ÙˆØ·</h5>
                {% if contract.terms_and_conditions %}
                <div class="p-3 bg-light rounded">
                    {{ contract.terms_and_conditions|linebreaks }}
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ø£Ùˆ Ø´Ø±ÙˆØ· Ù…Ø³Ø¬Ù„Ø©
                </div>
                {% endif %}
                
                {% if contract.notes %}
                <h5 class="mb-3 mt-4"><i class="fas fa-sticky-note me-2"></i>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h5>
                <div class="p-3 bg-light rounded">
                    {{ contract.notes|linebreaks }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal: Ø±ÙØ¹ Ù…Ø±ÙÙ‚ -->
<div class="modal fade" id="uploadDocumentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'hr:contract_document_upload' contract.pk %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-upload me-2"></i>Ø±ÙØ¹ Ù…Ø±ÙÙ‚ Ø¬Ø¯ÙŠØ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© <span class="text-danger">*</span></label>
                        <select name="document_type" class="form-select" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                            <option value="signed_contract">Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</option>
                            <option value="id_copy">ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙˆÙŠØ©</option>
                            <option value="certificate">Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</option>
                            <option value="medical_report">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠ</option>
                            <option value="bank_account">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ</option>
                            <option value="other">Ø£Ø®Ø±Ù‰</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† <span class="text-danger">*</span></label>
                        <input type="text" name="title" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„ÙˆØµÙ</label>
                        <textarea name="description" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ù…Ù„Ù <span class="text-danger">*</span></label>
                        <input type="file" name="file" class="form-control" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
                        <small class="text-muted">Ø§Ù„ØµÙŠØº Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©: PDF, DOC, DOCX, JPG, PNG</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload me-1"></i>Ø±ÙØ¹
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Lightbox CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet">

<style>
.timeline {
    position: relative;
    padding: 20px 0;
}
.timeline-item {
    position: relative;
    padding-right: 40px;
    margin-bottom: 20px;
}
.timeline-marker {
    position: absolute;
    right: 0;
    top: 0;
    width: 12px;
    height: 12px;
    border-radius: 50%;
}
.timeline-item:not(:last-child)::before {
    content: '';
    position: absolute;
    right: 5px;
    top: 12px;
    bottom: -20px;
    width: 2px;
    background: #dee2e6;
}
.timeline-content {
    background: #f8f9fa;
    padding: 10px 12px;
    border-radius: 6px;
    font-size: 0.9rem;
}
.timeline-content h6 {
    font-size: 0.95rem;
    margin-bottom: 0.25rem;
}
.timeline-content p {
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
}
.timeline-content .small {
    font-size: 0.8rem;
}

/* ØªØ®ØµÙŠØµ Lightbox Ù„Ù„Ø¹Ø±Ø¨ÙŠØ© */
.lb-data .lb-caption {
    font-family: 'Tajawal', sans-serif;
    direction: rtl;
    text-align: right;
}
</style>

<!-- Lightbox JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Lightbox
lightbox.option({
    'resizeDuration': 200,
    'wrapAround': true,
    'albumLabel': 'ØµÙˆØ±Ø© %1 Ù…Ù† %2',
    'fadeDuration': 300,
    'imageFadeDuration': 300
});

// ØªÙ‡ÙŠØ¦Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
document.addEventListener('DOMContentLoaded', function() {
    const documentsTable = document.getElementById('documents-table');
    if (documentsTable && typeof initializeTable === 'function') {
        console.log('ğŸ”§ ØªÙ‡ÙŠØ¦Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª...');
        initializeTable('documents-table', {
            pageLength: 10,
            order: [[4, 'desc']], // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±ÙØ¹
            searching: true,
            lengthChange: true
        });
    }
});

function deleteDocument(docId) {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙÙ‚ØŸ')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `{% url 'hr:contract_document_delete' contract.pk 0 %}`.replace('0', docId);
        
        const csrf = document.createElement('input');
        csrf.type = 'hidden';
        csrf.name = 'csrfmiddlewaretoken';
        csrf.value = '{{ csrf_token }}';
        form.appendChild(csrf);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø²ÙŠØ§Ø¯Ø§Øª
function applyIncrease(increaseId) {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ù‡Ø°Ù‡ Ø§Ù„Ø²ÙŠØ§Ø¯Ø©ØŸ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø¹Ù‚Ø¯.')) {
        fetch(`/hr/contracts/increases/${increaseId}/apply/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Ø®Ø·Ø£: ' + data.message);
            }
        })
        .catch(error => {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            console.error(error);
        });
    }
}

function cancelIncrease(increaseId) {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø²ÙŠØ§Ø¯Ø©ØŸ')) {
        fetch(`/hr/contracts/increases/${increaseId}/cancel/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Ø®Ø·Ø£: ' + data.message);
            }
        })
        .catch(error => {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            console.error(error);
        });
    }
}
</script>

{% endblock %}
