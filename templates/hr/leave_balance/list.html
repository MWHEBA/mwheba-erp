{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load custom_filters %}

{% block title %}أرصدة الإجازات{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<link rel="stylesheet" href="{% static 'css/tables.css' %}">
<style>
  .section-container {background-color: #fff;border-radius: 12px;box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);padding: 1.5rem;margin-bottom: 1.8rem;border: 1px solid rgba(0, 0, 0, 0.05);}
  .section-title {color: #344767;font-size: 1.2rem;font-weight: 600;margin-bottom: 1.2rem;padding-bottom: 0.75rem;border-bottom: 1px solid #eee;}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="mb-4">
      <div class="mb-2">
          <nav aria-label="breadcrumb">
              <ol class="breadcrumb mb-0">
                  <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}"><i class="fas fa-home me-1"></i>الرئيسية</a></li>
                  <li class="breadcrumb-item"><a href="{% url 'hr:dashboard' %}"><i class="fas fa-users-cog me-1"></i>الموارد البشرية</a></li>
                  <li class="breadcrumb-item"><a href="{% url 'hr:hr_settings' %}"><i class="fas fa-cog me-1"></i>الإعدادات</a></li>
                  <li class="breadcrumb-item active"><i class="fas fa-chart-pie me-1"></i>أرصدة الإجازات</li>
              </ol>
          </nav>
      </div>
      <div class="d-flex justify-content-between align-items-center bg-white p-3 rounded shadow-sm">
          <div class="d-flex align-items-center">
              <div class="me-3"><i class="fas fa-chart-pie fa-2x text-primary"></i></div>
              <div>
                  <h1 class="h3 mb-1">أرصدة الإجازات - {{ selected_year }}</h1>
                  <p class="text-muted mb-0">متابعة أرصدة إجازات الموظفين</p>
              </div>
          </div>
          <div>
              <select class="form-select me-2" style="width:120px;display:inline-block;" onchange="window.location.href='?year='+this.value">
                  {% for y in years %}<option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>{% endfor %}
              </select>
              <a href="{% url 'hr:leave_balance_update' %}" class="btn btn-primary me-2"><i class="fas fa-edit me-2"></i>تحديث</a>
              {% if rollover_enabled %}
              <a href="{% url 'hr:leave_balance_rollover' %}" class="btn btn-success" title="ترحيل الأرصدة للسنة الجديدة">
                  <i class="fas fa-sync me-2"></i>ترحيل
              </a>
              {% else %}
              <button class="btn btn-secondary" disabled title="الترحيل معطل - يجب التفعيل من الإعدادات">
                  <i class="fas fa-lock me-2"></i>ترحيل (معطل)
              </button>
              {% endif %}
          </div>
      </div>
  </div>

  <div class="section-container">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i>أرصدة الموظفين ({{ stats.total_employees }} موظف)</h5>
        <div>
          <button class="btn btn-sm btn-outline-primary" onclick="$('.accordion-collapse').collapse('show')">
            <i class="fas fa-expand me-1"></i>فتح الكل
          </button>
          <button class="btn btn-sm btn-outline-secondary" onclick="$('.accordion-collapse').collapse('hide')">
            <i class="fas fa-compress me-1"></i>إغلاق الكل
          </button>
        </div>
      </div>
      <div class="card-body">
        {% if grouped_balances %}
        <div class="accordion" id="employeeBalancesAccordion">
            {% for item in grouped_balances %}
            <div class="accordion-item mb-2">
                <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}">
                        <div class="d-flex justify-content-between align-items-center w-100 me-3">
                            <div>
                                <i class="fas fa-user me-2 text-primary"></i>
                                <strong>{{ item.employee.get_full_name_ar }}</strong>
                                <span class="badge bg-secondary ms-2">{{ item.employee.employee_number }}</span>
                                <small class="text-muted ms-2">{{ item.employee.department.name_ar|default:"-" }}</small>
                            </div>
                            <div>
                                <span class="badge bg-success me-2">متبقي: {{ item.total_remaining }} يوم</span>
                                <span class="badge bg-warning">مستخدم: {{ item.total_used }} يوم</span>
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#employeeBalancesAccordion">
                    <div class="accordion-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>نوع الإجازة</th>
                                        <th>الإجمالي</th>
                                        <th>المستحق</th>
                                        <th>المستخدم</th>
                                        <th>المتبقي</th>
                                        <th>النسبة</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for balance in item.balances %}
                                    <tr>
                                        <td><span class="badge bg-info">{{ balance.leave_type.name_ar }}</span></td>
                                        <td><strong>{{ balance.total_days }}</strong> يوم</td>
                                        <td><strong class="text-success">{{ balance.accrued_days }}</strong> يوم</td>
                                        <td>{{ balance.used_days }} يوم</td>
                                        <td><strong class="text-primary">{{ balance.remaining_days }}</strong> يوم</td>
                                        <td>
                                            {% if balance.accrued_days > 0 %}
                                                {% widthratio balance.remaining_days balance.accrued_days 100 as percentage %}
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar {% if percentage < 25 %}bg-danger{% elif percentage < 50 %}bg-warning{% else %}bg-success{% endif %}" style="width: {{ percentage }}%">{{ percentage }}%</div>
                                                </div>
                                            {% else %}
                                                <span class="badge bg-secondary">لم يستحق بعد</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="text-end mt-2">
                            <a href="{% url 'hr:leave_balance_employee' item.employee.pk %}" class="btn btn-sm btn-primary">
                                <i class="fas fa-eye me-1"></i>عرض التفاصيل
                            </a>
                            <a href="{% url 'hr:leave_balance_accrual_status' item.employee.pk %}" class="btn btn-sm btn-info">
                                <i class="fas fa-chart-line me-1"></i>حالة الاستحقاق
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
          {% include 'partials/empty_state.html' with message="لا توجد أرصدة للسنة المحددة" icon="chart-pie" %}
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // لا حاجة لـ DataTables - نستخدم Bootstrap Accordion
    console.log('✅ تم تحميل {{ grouped_balances|length }} موظف');
});
</script>
{% endblock %}
