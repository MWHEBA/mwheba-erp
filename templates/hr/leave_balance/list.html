{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load custom_filters %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<!-- جميع الستايلات موجودة في shared-components.css و components.css -->
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Page Header المركزي -->
  {% include "shared/page_header.html" %}
  
  <!-- Year Selector -->
  <div class="mb-3">
      <select class="form-select" style="width:150px;" onchange="window.location.href='?year='+this.value">
          {% for y in years %}<option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>{% endfor %}
      </select>
  </div>

  <div class="section-container">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i>أرصدة الموظفين ({{ stats.total_employees }} موظف)</h5>
        <div>
          <button class="btn btn-sm btn-outline-primary" onclick="$('.accordion-collapse').collapse('show')">
            <i class="fas fa-expand me-1"></i>فتح الكل
          </button>
          <button class="btn btn-sm btn-outline-secondary" onclick="$('.accordion-collapse').collapse('hide')">
            <i class="fas fa-compress me-1"></i>إغلاق الكل
          </button>
        </div>
      </div>
      <div class="card-body">
        {% if grouped_balances %}
        <div class="accordion" id="employeeBalancesAccordion">
            {% for item in grouped_balances %}
            <div class="accordion-item mb-2">
                <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}">
                        <div class="d-flex justify-content-between align-items-center w-100 me-3">
                            <div>
                                <i class="fas fa-user me-2 text-primary"></i>
                                <strong>{{ item.employee.get_full_name_ar }}</strong>
                                <span class="badge bg-secondary ms-2">{{ item.employee.employee_number }}</span>
                                <small class="text-muted ms-2">{{ item.employee.department.name_ar|default:"-" }}</small>
                            </div>
                            <div>
                                <span class="badge bg-success me-2">متبقي: {{ item.total_remaining }} يوم</span>
                                <span class="badge bg-warning">مستخدم: {{ item.total_used }} يوم</span>
                            </div>
                        </div>
                    </button>
                </h2>
                <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#employeeBalancesAccordion">
                    <div class="accordion-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>نوع الإجازة</th>
                                        <th>الإجمالي</th>
                                        <th>المستحق</th>
                                        <th>المستخدم</th>
                                        <th>المتبقي</th>
                                        <th>النسبة</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for balance in item.balances %}
                                    <tr>
                                        <td><span class="badge bg-info">{{ balance.leave_type.name_ar }}</span></td>
                                        <td><strong>{{ balance.total_days }}</strong> يوم</td>
                                        <td><strong class="text-success">{{ balance.accrued_days }}</strong> يوم</td>
                                        <td>{{ balance.used_days }} يوم</td>
                                        <td><strong class="text-primary">{{ balance.remaining_days }}</strong> يوم</td>
                                        <td>
                                            {% if balance.accrued_days > 0 %}
                                                {% widthratio balance.remaining_days balance.accrued_days 100 as percentage %}
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar {% if percentage < 25 %}bg-danger{% elif percentage < 50 %}bg-warning{% else %}bg-success{% endif %}" style="width: {{ percentage }}%">{{ percentage }}%</div>
                                                </div>
                                            {% else %}
                                                <span class="badge bg-secondary">لم يستحق بعد</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="text-end mt-2">
                            <a href="{% url 'hr:leave_balance_employee' item.employee.pk %}" class="btn btn-sm btn-primary">
                                <i class="fas fa-eye me-1"></i>عرض التفاصيل
                            </a>
                            <a href="{% url 'hr:leave_balance_accrual_status' item.employee.pk %}" class="btn btn-sm btn-info">
                                <i class="fas fa-chart-line me-1"></i>حالة الاستحقاق
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
          {% include 'partials/empty_state.html' with message="لا توجد أرصدة للسنة المحددة" icon="chart-pie" %}
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // لا حاجة لـ DataTables - نستخدم Bootstrap Accordion
    console.log('✅ تم تحميل {{ grouped_balances|length }} موظف');
});
</script>
{% endblock %}
