{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load custom_filters %}
{% load pricing_filters %}

{% block title %}تفاصيل ماكينة البصمة{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<link rel="stylesheet" href="{% static 'css/tables.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Breadcrumb + Header -->
  <div class="mb-4">
      <div class="mb-2">
          <nav aria-label="breadcrumb">
              <ol class="breadcrumb mb-0">
                  <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}"><i class="fas fa-home me-1"></i>الرئيسية</a></li>
                  <li class="breadcrumb-item"><a href="{% url 'hr:dashboard' %}"><i class="fas fa-users me-1"></i>الموارد البشرية</a></li>
                  <li class="breadcrumb-item"><a href="{% url 'hr:biometric_device_list' %}"><i class="fas fa-fingerprint me-1"></i>ماكينات البصمة</a></li>
                  <li class="breadcrumb-item active"><i class="fas fa-info-circle me-1"></i>تفاصيل</li>
              </ol>
          </nav>
      </div>
      
      <div class="d-flex justify-content-between align-items-center bg-white p-3 rounded shadow-sm">
          <div class="d-flex align-items-center">
              <div class="me-3">
                  <i class="fas fa-fingerprint fa-2x text-primary"></i>
              </div>
              <div>
                  <h1 class="h3 mb-1">{{ device.device_name }}</h1>
                  <p class="text-muted mb-0">تفاصيل ماكينة البصمة</p>
              </div>
          </div>
          <div>
                <div>
                    <a href="{% url 'hr:biometric_agent_setup' device.pk %}" class="btn btn-info">
                        <i class="fas fa-cog me-2"></i>
                        إعداد Bridge Agent
                    </a>
                    <a href="{% url 'hr:biometric_device_form_edit' device.pk %}" class="btn btn-warning">
                        <i class="fas fa-edit me-2"></i>
                        تعديل
                    </a>
          </div>
      </div>
  </div>

  <!-- معلومات الماكينة -->
  <div class="row">
      <div class="col-md-6">
          <div class="section-container">
              <h5 class="section-title"><i class="fas fa-info-circle me-2"></i>معلومات الماكينة</h5>
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>للربط مع جهازك المحلي:</strong>
                        <a href="{% url 'hr:biometric_device_download_agent' device.pk %}" class="alert-link">
                            حمل Bridge Agent
                        </a>
                    </div>
                    
                    <table class="table table-bordered">
                        <tr>
                            <th width="40%">كود الماكينة</th>
                            <td>
                                <code>{{ device.device_code }}</code>
                            </td>
                        </tr>
                        <tr>
                            <th>النوع</th>
                            <td>{{ device.get_device_type_display }}</td>
                        </tr>
                        <tr>
                            <th>الرقم التسلسلي</th>
                            <td>{{ device.serial_number }}</td>
                        </tr>
                        <tr>
                            <th>عنوان IP</th>
                            <td><code>{{ device.connection_string }}</code></td>
                        </tr>
                        <tr>
                            <th>الموقع</th>
                            <td>{{ device.location }}</td>
                        </tr>
                        <tr>
                            <th>القسم</th>
                            <td>{{ device.department.name_ar|default:"-" }}</td>
                        </tr>
                        <tr>
                            <th>الحالة</th>
                            <td>
                                {% if device.status == 'active' %}
                                    <span class="badge bg-success">نشط</span>
                                {% elif device.status == 'error' %}
                                    <span class="badge bg-danger">خطأ</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ device.get_status_display }}</span>
                                {% endif %}
                                
                            </td>
                        </tr>
                    </table>
          </div>
      </div>

      <div class="col-md-6">
          <div class="section-container">
              <h5 class="section-title">
                  <i class="fas fa-signal me-2"></i>حالة الاتصال
                  {% load tz %}
                  {% if device.last_connection %}
                      {% now "U" as current_timestamp %}
                      {% with device.last_connection|date:"U"|add:"0" as last_connection_timestamp %}
                          {% with current_timestamp|add:"0"|add:"-3600" as one_hour_ago %}
                              {% if last_connection_timestamp > one_hour_ago %}
                                  <span class="badge bg-success float-end">
                                      <i class="fas fa-robot me-1"></i>Bridge Agent نشط
                                  </span>
                              {% elif last_connection_timestamp > 0 %}
                                  <span class="badge bg-secondary float-end">
                                      <i class="fas fa-robot me-1"></i>Bridge Agent متوقف
                                  </span>
                              {% endif %}
                          {% endwith %}
                      {% endwith %}
                  {% else %}
                      <span class="badge bg-warning text-dark float-end">
                          <i class="fas fa-robot me-1"></i>Bridge Agent غير مفعل
                      </span>
                  {% endif %}
              </h5>
              
              <!-- الإحصائيات الرئيسية -->
              <div class="row text-center mb-3">
                  <div class="col-6">
                      <div class="stats-card">
                          <i class="fas fa-users text-primary mb-2" style="font-size: 2rem;"></i>
                          <h4 class="mb-0 text-primary">{{ device.total_users }}</h4>
                          <small class="text-muted">المستخدمين المسجلين</small>
                      </div>
                  </div>
                  <div class="col-6">
                      <div class="stats-card">
                          <i class="fas fa-list text-success mb-2" style="font-size: 2rem;"></i>
                          <h4 class="mb-0 text-success">{{ device.total_records }}</h4>
                          <small class="text-muted">إجمالي السجلات</small>
                      </div>
                  </div>
              </div>
              
              <hr class="my-3">
              
              <!-- معلومات الاتصال -->
              <div class="row text-center">
                  <div class="col-12 mb-3">
                      <button type="button" class="btn btn-primary w-100" onclick="refreshData()">
                          <i class="fas fa-sync-alt me-2"></i>
                          تحديث البيانات
                      </button>
                  </div>
                  <div class="col-6">
                      <small class="text-muted">آخر اتصال</small>
                      <p class="mb-0"><strong>{{ device.last_connection|date:"Y-m-d g:i A"|default:"-" }}</strong></p>
                  </div>
                  <div class="col-6">
                      <small class="text-muted">آخر مزامنة</small>
                      <p class="mb-0"><strong>{{ device.last_sync|date:"Y-m-d g:i A"|default:"-" }}</strong></p>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- آخر السجلات -->
  <div class="section-container">
      <h5 class="section-title" id="logsTitle"><i class="fas fa-list me-2"></i>آخر {{ logs_count }} سجلات بصمة</h5>
      <div id="logsTableContainer">
          {% include 'components/data_table.html' with data=recent_logs headers=log_headers empty_message='لا توجد سجلات بصمة' empty_icon='fingerprint' primary_key='id' table_id='biometric-logs-table' length_options='5,10,20,50' default_length='10' %}
      </div>
  </div>

  <!-- Timeline المزامنة -->
  <div class="section-container">
      <h5 class="section-title">
          <i class="fas fa-history me-2"></i>
          سجل المزامنة التلقائية (آخر 10 عمليات)
      </h5>
      {% if sync_logs %}
      <div class="timeline">
          {% for sync in sync_logs %}
          <div class="timeline-item">
              <div class="timeline-marker {% if sync.status == 'success' %}bg-success{% elif sync.status == 'error' %}bg-danger{% else %}bg-warning{% endif %}">
                  <i class="fas fa-{% if sync.status == 'success' %}check{% elif sync.status == 'error' %}times{% else %}clock{% endif %}"></i>
              </div>
              <div class="timeline-content">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                      <strong>{{ sync.started_at|date:"Y-m-d g:i:s A" }}</strong>
                      <span class="badge bg-{% if sync.status == 'success' %}success{% elif sync.status == 'error' %}danger{% else %}warning text-dark{% endif %}">
                          {{ sync.get_status_display }}
                      </span>
                  </div>
                  <small class="text-muted">
                      <i class="fas fa-download me-1"></i>{{ sync.records_fetched }} سجل
                      <i class="fas fa-check-circle ms-2 me-1"></i>{{ sync.records_processed }} معالج
                      {% if sync.records_failed %}
                          <i class="fas fa-exclamation-triangle ms-2 me-1 text-danger"></i>{{ sync.records_failed }} فاشل
                      {% endif %}
                      <i class="fas fa-clock ms-2 me-1"></i>{{ sync.duration|remove_trailing_zeros }}s
                  </small>
                  {% if sync.error_message %}
                  <div class="alert alert-danger alert-sm mt-2 mb-0">
                      <small><i class="fas fa-exclamation-circle me-1"></i>{{ sync.error_message }}</small>
                  </div>
                  {% endif %}
              </div>
          </div>
          {% endfor %}
      </div>
      {% else %}
      <p class="text-muted text-center py-4">
          <i class="fas fa-info-circle me-2"></i>
          لا توجد عمليات مزامنة بعد. سيتم عرض السجلات هنا بعد تفعيل Bridge Agent.
      </p>
      {% endif %}
  </div>

  <!-- الجدول القديم للمزامنة (مخفي) -->
  <div class="section-container d-none">
      <h5 class="section-title"><i class="fas fa-sync me-2"></i>آخر عمليات المزامنة (جدول)</h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>وقت البداية</th>
                                    <th>الحالة</th>
                                    <th>السجلات المجلوبة</th>
                                    <th>المعالجة</th>
                                    <th>الفاشلة</th>
                                    <th>المدة</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sync in recent_syncs %}
                                <tr>
                                    <td>{{ sync.started_at|date:"Y-m-d H:i:s" }}</td>
                                    <td>
                                        {% if sync.status == 'success' %}
                                            <span class="badge bg-success">نجحت</span>
                                        {% elif sync.status == 'failed' %}
                                            <span class="badge bg-danger">فشلت</span>
                                        {% else %}
                                            <span class="badge bg-warning">جزئية</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ sync.records_fetched }}</td>
                                    <td>{{ sync.records_processed }}</td>
                                    <td>{{ sync.records_failed }}</td>
                                    <td>{{ sync.duration|default:"-" }} ثانية</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center">لا توجد عمليات مزامنة</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
  </div>

  <div class="mt-3">
      <a href="{% url 'hr:biometric_device_list' %}" class="btn btn-secondary">
          <i class="fas fa-arrow-right me-2"></i>العودة
      </a>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<style>
/* Timeline Styles */
.timeline {
    position: relative;
    padding: 20px 0;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 20px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--border-color, #dee2e6);
}

.timeline-item {
    position: relative;
    padding-left: 50px;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: 10px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    z-index: 1;
}

.timeline-content {
    background: var(--card-bg, #fff);
    padding: 12px;
    border: 1px solid var(--border-color, #dee2e6);
}

/* Pulse - Removed for minimal effects */

/* Alert Small */
.alert-sm {
    padding: 0.5rem;
    font-size: 0.875rem;
}

/* Stats Card - Override global styles */
.stats-card {
    padding: 1rem 0.5rem;
    transition: none !important;
    transform: none !important;
    box-shadow: none !important;
    border-radius: 0 !important;
    background: transparent !important;
    border: none !important;
}

.stats-card:hover {
    transform: none !important;
    box-shadow: none !important;
}

.stats-card h4 {
    font-weight: bold;
    font-size: 1.75rem;
}
</style>

<script>
function refreshData() {
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري التحديث...';
    
    setTimeout(() => {
        location.reload();
    }, 1000);
}

// ربط dropdown عدد السجلات بالـ backend
document.addEventListener('DOMContentLoaded', function() {
    const deviceId = {{ device.pk }};
    const container = document.getElementById('logsTableContainer');
    const titleElement = document.getElementById('logsTitle');
    
    // تفعيل البحث في الجدول
    function initTableSearch() {
        const searchInput = document.querySelector('.table-search[data-table="biometric-logs-table"]');
        const table = document.querySelector('#biometric-logs-table');
        
        if (searchInput && table) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                const rows = table.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }
    }
    
    // تفعيل البحث عند التحميل الأول
    initTableSearch();
    
    // الاستماع لتغيير الـ dropdown
    document.addEventListener('change', function(e) {
        if (e.target.matches('.table-length[data-table="biometric-logs-table"]')) {
            const limit = e.target.value;
            
            console.log('تغيير عدد السجلات إلى:', limit);
            
            // تحديث العنوان
            titleElement.innerHTML = `<i class="fas fa-list me-2"></i>آخر ${limit} سجلات بصمة`;
            
            // إظهار مؤشر التحميل
            container.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="mt-2">جاري التحميل...</p></div>';
            
            // جلب البيانات الجديدة
            fetch(`/hr/biometric-devices/${deviceId}/logs/?limit=${limit}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(html => {
                container.innerHTML = html;
                console.log('تم تحميل', limit, 'سجل بنجاح');
                
                // إعادة تفعيل البحث بعد تحميل الجدول الجديد
                setTimeout(initTableSearch, 100);
            })
            .catch(error => {
                console.error('Error:', error);
                container.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>حدث خطأ أثناء تحميل البيانات</div>';
            });
        }
    });
});
</script>
{% endblock %}
