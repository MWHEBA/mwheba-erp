{% load static %}
{% load i18n %}

<header class="header">
    <div class="header-container">
        <!-- الجانب الأيمن للهيدر (بدءًا من اليمين): المستخدم، التنبيهات، البحث، الإجراءات -->
        <div class="header-right">
            <!-- زر إظهار/إخفاء القائمة الجانبية (للموبايل) -->
            <button type="button" class="mobile-sidebar-btn d-lg-none">
                <i class="fas fa-bars"></i>
            </button>
            
            <!-- عنوان الصفحة مع الأيقونة -->
            <div class="page-title-wrapper">
                <div class="page-icon">
                    <i class="{% if page_icon %}{{ page_icon }}{% elif icon %}{{ icon }}{% else %}
                        {% with page_header=page_title|default:'' %}
                        {% if 'إضافة عميل' in page_header %}fas fa-user-plus
                        {% elif 'إضافة مورد' in page_header %}fas fa-handshake
                        {% elif 'إضافة منتج' in page_header %}fas fa-box-open
                        {% elif 'إضافة فاتورة' in page_header or 'فاتورة جديدة' in page_header %}fas fa-file-invoice
                        {% elif 'إضافة مستخدم' in page_header %}fas fa-user-plus
                        {% elif 'إضافة' in page_header and 'عميل' in page_header %}fas fa-user-plus
                        {% elif 'إضافة' in page_header and 'مورد' in page_header %}fas fa-handshake
                        {% elif 'إضافة' in page_header and 'منتج' in page_header %}fas fa-box-open
                        {% elif 'إضافة' in page_header and 'مستخدم' in page_header %}fas fa-user-plus
                        {% elif 'إضافة' in page_header and 'مخزون' in page_header %}fas fa-warehouse
                        {% elif 'إضافة' in page_header and 'صنف' in page_header %}fas fa-boxes
                        {% elif 'إضافة' in page_header and 'فاتورة' in page_header %}fas fa-file-invoice
                        {% elif 'إضافة' in page_header %}fas fa-plus-circle
                        {% elif 'العملاء' in page_header %}fas fa-users
                        {% elif 'المنتجات' in page_header %}fas fa-box
                        {% elif 'المبيعات' in page_header %}fas fa-shopping-cart
                        {% elif 'المشتريات' in page_header %}fas fa-truck
                        {% elif 'المالية' in page_header %}fas fa-money-bill-wave
                        {% elif 'التقارير' in page_header %}fas fa-chart-bar
                        {% elif 'الإشعارات' in page_header %}fas fa-bell
                        {% elif 'الإعدادات' in page_header %}fas fa-cog
                        {% elif 'الملف الشخصي' in page_header %}fas fa-user
                        {% elif 'الأنواع' in page_header %}fas fa-tag
                        {% elif 'الأصناف' in page_header %}fas fa-boxes
                        {% elif 'المخزون' in page_header %}fas fa-warehouse
                        {% elif 'الموردين' in page_header %}fas fa-handshake
                        {% elif 'المصروفات' in page_header %}fas fa-file-invoice-dollar
                        {% elif 'الإيرادات' in page_header %}fas fa-hand-holding-usd
                        {% else %}fas fa-home{% endif %}
                        {% endwith %}
                    {% endif %}"></i>
                </div>
                <h1 class="page-title">{% if page_title %}{{ page_title }}{% else %}لوحة التحكم{% endif %}</h1>
            </div>
        </div>

        <!-- الجانب الأيسر للهيدر: اسم الصفحة مع الأيقونة -->
        <div class="header-left">
            <!-- الإجراءات السريعة -->
            <div class="quick-actions dropdown">
                <button class="quick-action-btn" type="button" id="quickActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-bolt"></i>
                    <span>إجراء سريع</span>
                </button>
                <div class="dropdown-menu dropdown-menu-end quick-actions-dropdown shadow-lg" aria-labelledby="quickActionsDropdown">
                    <div class="quick-actions-header">
                        <h6 class="dropdown-header">
                            <i class="fas fa-bolt me-2 text-primary"></i>
                            <span>إجراءات سريعة</span>
                        </h6>
                    </div>
                    
                    <div class="quick-actions-body">
                        <!-- المبيعات -->
                        <div class="quick-actions-category">
                            <h6 class="dropdown-header text-primary">
                                <i class="fas fa-shopping-cart me-2"></i>
                                <span>المبيعات</span>
                            </h6>
                            <a class="dropdown-item quick-action-item" href="{% url 'core:dashboard' %}">
                                <div class="quick-action-icon bg-soft-primary">
                                    <i class="fas fa-cart-plus text-primary"></i>
                                </div>
                                <div class="quick-action-content">
                                    <div class="quick-action-title">فاتورة بيع جديدة</div>
                                    <div class="quick-action-desc">إنشاء فاتورة بيع جديدة للعملاء</div>
                                </div>
                                <div class="quick-action-shortcut">
                                    <span class="badge rounded-pill bg-soft-primary text-primary">Alt+S</span>
                                </div>
                            </a>
                        </div>
                        
                        <!-- المشتريات -->
                        <div class="quick-actions-category">
                            <h6 class="dropdown-header text-success">
                                <i class="fas fa-truck me-2"></i>
                                <span>المشتريات</span>
                            </h6>
                            <a class="dropdown-item quick-action-item" href="{% url 'core:dashboard' %}">
                                <div class="quick-action-icon bg-soft-success">
                                    <i class="fas fa-shopping-bag text-success"></i>
                                </div>
                                <div class="quick-action-content">
                                    <div class="quick-action-title">فاتورة شراء جديدة</div>
                                    <div class="quick-action-desc">إنشاء فاتورة شراء جديدة من الموردين</div>
                                </div>
                                <div class="quick-action-shortcut">
                                    <span class="badge rounded-pill bg-soft-success text-success">Alt+P</span>
                                </div>
                            </a>
                        </div>
                        
                        <!-- المنتجات والمخزون -->
                        <div class="quick-actions-category">
                            <h6 class="dropdown-header text-info">
                                <i class="fas fa-box-open me-2"></i>
                                <span>المنتجات والمخزون</span>
                            </h6>
                            <a class="dropdown-item quick-action-item" href="{% url 'core:dashboard' %}">
                                <div class="quick-action-icon bg-soft-info">
                                    <i class="fas fa-box text-info"></i>
                                </div>
                                <div class="quick-action-content">
                                    <div class="quick-action-title">منتج جديد</div>
                                    <div class="quick-action-desc">إضافة منتج جديد للمخزون</div>
                                </div>
                            </a>
                            <a class="dropdown-item quick-action-item" href="{% url 'core:dashboard' %}">
                                <div class="quick-action-icon bg-soft-secondary">
                                    <i class="fas fa-exchange-alt text-secondary"></i>
                                </div>
                                <div class="quick-action-content">
                                    <div class="quick-action-title">تحويل مخزني</div>
                                    <div class="quick-action-desc">تحويل منتجات بين المخازن</div>
                                </div>
                            </a>
                            <a class="dropdown-item quick-action-item" href="{% url 'core:dashboard' %}">
                                <div class="quick-action-icon bg-soft-dark">
                                    <i class="fas fa-barcode text-dark"></i>
                                </div>
                                <div class="quick-action-content">
                                    <div class="quick-action-title">جرد المخزون</div>
                                    <div class="quick-action-desc">إجراء عملية جرد للمخزون</div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- حقل البحث -->
            <div class="search-box">
                <form class="search-form" action="#" method="GET">
                    <div class="input-group">
                        <input type="text" class="form-control" name="q" placeholder="بحث..." aria-label="بحث">
                        <span class="input-group-text">
                            <button type="submit" class="btn-search border-0 bg-transparent p-0">
                                <i class="fas fa-search"></i>
                            </button>
                        </span>
                    </div>
                </form>
            </div>
            <!-- التنبيهات -->
            <div class="notifications dropdown">
                <button class="btn-icon notification-btn" type="button" id="notificationsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-bell"></i>
                    {% with unread_count=0 %}
                    {% for notification in notifications %}
                        {% if not notification.read %}
                            {% with unread_count=unread_count|add:1 %}{% endwith %}
                        {% endif %}
                    {% endfor %}
                    <span class="badge bg-danger badge-counter notification-badge {% if unread_count == 0 %}d-none{% endif %}">
                        {{ unread_count }}
                    </span>
                    {% endwith %}
                </button>
                <div class="dropdown-menu dropdown-menu-end notifications-dropdown shadow-lg" aria-labelledby="notificationsDropdown">
                    <div class="dropdown-header d-flex justify-content-between align-items-center py-3">
                        <span class="fw-bold">
                            <i class="fas fa-bell me-2 text-primary"></i>
                            {% trans "التنبيهات" %}
                            {% with unread_count=0 %}
                            {% for notification in notifications %}
                                {% if not notification.read %}
                                    {% with unread_count=unread_count|add:1 %}{% endwith %}
                                {% endif %}
                            {% endfor %}
                            {% if unread_count > 0 %}
                            <span class="badge bg-danger rounded-pill ms-2">{{ unread_count }}</span>
                            {% endif %}
                            {% endwith %}
                        </span>
                        {% with unread_count=0 %}
                        {% for notification in notifications %}
                            {% if not notification.read %}
                                {% with unread_count=unread_count|add:1 %}{% endwith %}
                            {% endif %}
                        {% endfor %}
                        {% if unread_count > 0 %}
                        <button type="button" class="btn btn-sm btn-outline-primary mark-all-read" data-url="{% url 'core:mark_all_notifications_read' %}">
                            <i class="fas fa-check-double"></i>
                            <span class="d-none d-md-inline-block">{% trans "تعليم الكل كمقروء" %}</span>
                        </button>
                        {% endif %}
                        {% endwith %}
                    </div>
                    
                    <div class="notification-list ps-custom">
                        {% if notifications %}
                            <!-- الإشعارات غير المقروءة -->
                            {% with unread_notifications='' %}
                            {% with has_unread=False %}
                            <div class="notification-category">
                                <div class="notification-category-title">
                                    <span>{% trans "جديدة" %}</span>
                                </div>
                                {% for notification in notifications %}
                                    {% if not notification.read %}
                                        {% with has_unread=True %}{% endwith %}
                                        <a href="{{ notification.link }}" class="notification-item unread" data-id="{{ notification.id }}">
                                            <div class="notification-icon bg-{{ notification.notification_type }}">
                                                <i class="fas 
                                                    {% if notification.notification_type == 'info' %}fa-info
                                                    {% elif notification.notification_type == 'warning' %}fa-exclamation-triangle
                                                    {% elif notification.notification_type == 'success' %}fa-check
                                                    {% elif notification.notification_type == 'danger' %}fa-times
                                                    {% elif notification.notification_type == 'inventory_alert' %}fa-box
                                                    {% elif notification.notification_type == 'payment_received' %}fa-money-bill-wave
                                                    {% elif notification.notification_type == 'new_invoice' %}fa-file-invoice
                                                    {% elif notification.notification_type == 'return_request' %}fa-undo
                                                    {% else %}fa-bell
                                                    {% endif %}">
                                                </i>
                                </div>
                                <div class="notification-content">
                                    <div class="notification-title">{{ notification.title }}</div>
                                    <div class="notification-text">{{ notification.message }}</div>
                                                <div class="notification-time">
                                                    <i class="far fa-clock me-1"></i>
                                                    {{ notification.created_at|timesince }}
                                                </div>
                                            </div>
                                            <button type="button" class="btn-mark-read" data-id="{{ notification.id }}" data-url="{% url 'core:mark_notification_read' notification.id %}">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </a>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            {% if not has_unread %}
                                <style>.notification-category:first-child { display: none; }</style>
                            {% endif %}
                            {% endwith %}
                            {% endwith %}
                            
                            <!-- الإشعارات المقروءة مؤخرًا -->
                            {% with has_read=False %}
                            <div class="notification-category">
                                <div class="notification-category-title">
                                    <span>{% trans "سابقة" %}</span>
                                </div>
                                {% for notification in notifications %}
                                    {% if notification.read %}
                                        {% with has_read=True %}{% endwith %}
                                        <a href="{{ notification.link }}" class="notification-item">
                                            <div class="notification-icon bg-light text-{{ notification.notification_type }}">
                                                <i class="fas 
                                                    {% if notification.notification_type == 'info' %}fa-info
                                                    {% elif notification.notification_type == 'warning' %}fa-exclamation-triangle
                                                    {% elif notification.notification_type == 'success' %}fa-check
                                                    {% elif notification.notification_type == 'danger' %}fa-times
                                                    {% elif notification.notification_type == 'inventory_alert' %}fa-box
                                                    {% elif notification.notification_type == 'payment_received' %}fa-money-bill-wave
                                                    {% elif notification.notification_type == 'new_invoice' %}fa-file-invoice
                                                    {% elif notification.notification_type == 'return_request' %}fa-undo
                                                    {% else %}fa-bell
                                                    {% endif %}">
                                                </i>
                                            </div>
                                            <div class="notification-content">
                                                <div class="notification-title">{{ notification.title }}</div>
                                                <div class="notification-text">{{ notification.message }}</div>
                                                <div class="notification-time">
                                                    <i class="far fa-clock me-1"></i>
                                                    {{ notification.created_at|timesince }}
                                                </div>
                                </div>
                            </a>
                                    {% endif %}
                            {% endfor %}
                            </div>
                            {% if not has_read %}
                                <style>.notification-category:last-child { display: none; }</style>
                            {% endif %}
                            {% endwith %}
                        {% else %}
                            <div class="dropdown-item text-center py-5">
                                <div class="empty-notifications">
                                    <i class="far fa-bell-slash fa-3x text-muted mb-3"></i>
                                    <p class="text-muted mb-0">{% trans "لا توجد إشعارات جديدة" %}</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <div class="dropdown-footer py-2 text-center">
                        <a href="{% url 'core:notifications_list' %}" class="btn btn-sm btn-light w-100">
                            <i class="fas fa-list me-1"></i>
                            {% trans "عرض كل الإشعارات" %}
                        </a>
                    </div>
                </div>
            </div>
            <!-- قائمة المستخدم -->
            <div class="user-menu dropdown">
                <button class="user-dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <div class="avatar-wrapper">
                        <div class="avatar">
                            {% if user.profile_image %}
                                <img src="{{ user.profile_image.url }}" alt="{{ user.get_full_name }}" class="avatar-img">
                            {% else %}
                                <img src="{% static 'img/user.png' %}" alt="{{ user.get_full_name }}" class="avatar-img">
                            {% endif %}
                        </div>
                        <span class="user-name-short d-none d-md-inline-block">{{ user.get_full_name|default:"المستخدم" }}</span>
                        <i class="fas fa-chevron-down ms-1 user-dropdown-icon"></i>
                    </div>
                </button>
                <div class="dropdown-menu dropdown-menu-end user-dropdown">
                    <div class="user-dropdown-header">
                        <div class="user-dropdown-profile">
                            <div class="user-avatar-large">
                                {% if user.profile_image %}
                                    <img src="{{ user.profile_image.url }}" alt="{{ user.get_full_name }}" class="user-avatar-img">
                                {% else %}
                                    <img src="{% static 'img/user.png' %}" alt="{{ user.get_full_name }}" class="user-avatar-img">
                                {% endif %}
                            </div>
                            <div class="user-info-wrapper">
                                <h5 class="user-name">{{ user.get_full_name|default:"المستخدم" }}</h5>
                                <p class="user-email">{{ user.email|default:"user@example.com" }}</p>
                                <span class="user-role">{{ user.role|default:"مدير النظام" }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="user-dropdown-divider"></div>
                    
                    <div class="user-dropdown-menu-items">
                        <a href="#" class="user-dropdown-item">
                            <div class="dropdown-item-icon bg-soft-primary">
                                <i class="fas fa-user-circle text-primary"></i>
                            </div>
                            <div class="dropdown-item-text">
                                <span>الملف الشخصي</span>
                                <small>إدارة معلوماتك الشخصية</small>
                            </div>
                        </a>
                        
                        <a href="#" class="user-dropdown-item">
                            <div class="dropdown-item-icon bg-soft-success">
                                <i class="fas fa-cog text-success"></i>
                            </div>
                            <div class="dropdown-item-text">
                                <span>الإعدادات</span>
                                <small>تخصيص إعدادات النظام</small>
                            </div>
                        </a>
                        
                        <a href="#" class="user-dropdown-item">
                            <div class="dropdown-item-icon bg-soft-info">
                                <i class="fas fa-bell text-info"></i>
                            </div>
                            <div class="dropdown-item-text">
                                <span>الإشعارات</span>
                                <small>إدارة تفضيلات الإشعارات</small>
                            </div>
                            <span class="badge rounded-pill bg-danger ms-auto">3</span>
                        </a>
                        
                        <a href="#" class="user-dropdown-item">
                            <div class="dropdown-item-icon bg-soft-warning">
                                <i class="fas fa-history text-warning"></i>
                            </div>
                            <div class="dropdown-item-text">
                                <span>النشاط</span>
                                <small>مشاهدة سجل النشاط الخاص بك</small>
                            </div>
                        </a>
                        
                        {% if user.is_superuser %}
                        <a href="#" class="user-dropdown-item" onclick="resetSystem(event)">
                            <div class="dropdown-item-icon bg-soft-danger">
                                <i class="fas fa-undo-alt text-danger"></i>
                            </div>
                            <div class="dropdown-item-text">
                                <span>إعادة تهيئة النظام</span>
                                <small>استعادة ضبط مصنع للنظام</small>
                            </div>
                        </a>
                        {% endif %}
                    </div>
                    
                    <div class="user-dropdown-divider"></div>
                    
                    <div class="user-dropdown-footer">
                        <a href="{% url 'logout' %}" class="user-dropdown-item">
                            <div class="dropdown-item-icon bg-soft-danger">
                                <i class="fas fa-sign-out-alt text-danger"></i>
                            </div>
                            <div class="dropdown-item-text">
                                <span>تسجيل الخروج</span>
                            </div>
                        </a>
                    </div>
                    
                    <div class="user-dropdown-info">
                        <small>آخر تسجيل دخول: اليوم، {{ now|time:"h:i a" }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<script>
function resetSystem(event) {
    event.preventDefault();
    
    // SweetAlert تحذيري احترافي
    Swal.fire({
        title: '⚠️ تحذير هام!',
        html: `
            <div style="text-align: right; direction: rtl;">
                <p style="font-size: 16px; margin-bottom: 15px;">
                    <strong>هذا الإجراء سيقوم بـ:</strong>
                </p>
                <ul style="text-align: right; list-style: none; padding: 0;">
                    <li style="margin-bottom: 8px;">🗑️ حذف جميع البيانات الموجودة</li>
                    <li style="margin-bottom: 8px;">🔄 إعادة إنشاء قاعدة البيانات</li>
                    <li style="margin-bottom: 8px;">👥 إنشاء المستخدمين الافتراضيين</li>
                    <li style="margin-bottom: 8px;">📊 تحميل البيانات التجريبية</li>
                    <li style="margin-bottom: 8px;">⚙️ إعادة تهيئة جميع الإعدادات</li>
                </ul>
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-top: 20px;">
                    <p style="color: #856404; margin: 0; font-weight: bold;">
                        ⚠️ لا يمكن التراجع عن هذا الإجراء!
                    </p>
                </div>
            </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '🔄 نعم، أعد تهيئة النظام',
        cancelButtonText: '❌ إلغاء',
        reverseButtons: true,
        customClass: {
            popup: 'swal-rtl',
            title: 'swal-title-rtl',
            content: 'swal-content-rtl'
        },
        showLoaderOnConfirm: true,
        preConfirm: () => {
            // الحصول على CSRF token
            let csrfToken = '';
            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            const csrfMeta = document.querySelector('meta[name="csrf-token"]');
            
            if (csrfInput) {
                csrfToken = csrfInput.value;
            } else if (csrfMeta) {
                csrfToken = csrfMeta.getAttribute('content');
            } else {
                // محاولة الحصول على CSRF من cookies
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'csrftoken') {
                        csrfToken = value;
                        break;
                    }
                }
            }
            
            // التحقق من وجود CSRF token
            if (!csrfToken) {
                throw new Error('لم يتم العثور على CSRF token. يرجى إعادة تحميل الصفحة.');
            }
            
            return fetch('{% url "core:reset_system_with_progress" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    throw new Error(data.message || 'حدث خطأ غير معروف');
                }
                
                // بدء تتبع التقدم
                return trackResetProgress(data.operation_id);
            })
            .catch(error => {
                console.error('Reset system error:', error);
                Swal.showValidationMessage(`خطأ: ${error.message}`);
                return false;
            });
        },
        allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
        if (result.isConfirmed && result.value) {
            // عرض رسالة النجاح
            Swal.fire({
                title: '✅ تم بنجاح!',
                text: result.value.message,
                icon: 'success',
                timer: 3000,
                timerProgressBar: true,
                showConfirmButton: false,
                customClass: {
                    popup: 'swal-rtl'
                }
            }).then(() => {
                // إعادة التوجيه لصفحة تسجيل الدخول
                if (result.value.redirect) {
                    window.location.href = result.value.redirect;
                } else {
                    window.location.reload();
                }
            });
        }
    });
}

// دالة تتبع التقدم
function trackResetProgress(operationId) {
    return new Promise((resolve, reject) => {
        // إظهار مودال التقدم
        Swal.fire({
            title: '🔄 جاري إعادة تهيئة النظام',
            html: `
                <div style="text-align: right; direction: rtl;">
                    <div class="progress mb-3" style="height: 25px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%; background: linear-gradient(45deg, #007bff, #0056b3);">
                            <span id="progressText" style="font-weight: bold; color: white;">0%</span>
                        </div>
                    </div>
                    <div id="currentStep" style="font-size: 16px; margin-bottom: 10px; color: #495057;">
                        بدء العملية...
                    </div>
                    <div id="stepDetails" style="font-size: 14px; color: #6c757d; max-height: 200px; overflow-y: auto;">
                        <div>⏳ جاري التحضير...</div>
                    </div>
                </div>
            `,
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            customClass: {
                popup: 'swal-rtl swal-progress',
                title: 'swal-title-rtl'
            }
        });
        
        // تتبع التقدم كل ثانية
        const progressInterval = setInterval(() => {
            fetch(`{% url "core:get_reset_progress" "OPERATION_ID" %}`.replace('OPERATION_ID', operationId))
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'not_found') {
                        clearInterval(progressInterval);
                        reject(new Error('لم يتم العثور على العملية'));
                        return;
                    }
                    
                    // تحديث شريط التقدم
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');
                    const currentStep = document.getElementById('currentStep');
                    const stepDetails = document.getElementById('stepDetails');
                    
                    if (progressBar && progressText && currentStep) {
                        progressBar.style.width = `${data.percentage}%`;
                        progressText.textContent = `${data.percentage}%`;
                        currentStep.textContent = `المرحلة ${data.current_step}/${data.total_steps}: ${data.step_name}`;
                        
                        // إضافة الرسائل الجديدة
                        if (data.messages && data.messages.length > 0) {
                            stepDetails.innerHTML = data.messages.map(msg => 
                                `<div style="margin-bottom: 5px;">${msg}</div>`
                            ).join('');
                            stepDetails.scrollTop = stepDetails.scrollHeight;
                        }
                    }
                    
                    // التحقق من انتهاء العملية
                    if (data.status === 'completed') {
                        clearInterval(progressInterval);
                        setTimeout(() => {
                            resolve({
                                success: true,
                                message: data.message,
                                redirect: '/login/'
                            });
                        }, 1000);
                    } else if (data.status === 'failed') {
                        clearInterval(progressInterval);
                        let errorMessage = data.message || 'حدث خطأ غير معروف';
                        if (data.error_details) {
                            console.error('Error details:', data.error_details);
                        }
                        if (data.stderr) {
                            console.error('Script stderr:', data.stderr);
                        }
                        if (data.return_code) {
                            console.error('Return code:', data.return_code);
                        }
                        reject(new Error(errorMessage));
                    }
                })
                .catch(error => {
                    console.error('Progress tracking error:', error);
                    clearInterval(progressInterval);
                    
                    // عرض خطأ في المودال
                    const currentStep = document.getElementById('currentStep');
                    if (currentStep) {
                        currentStep.textContent = `خطأ في التتبع: ${error.message}`;
                        currentStep.style.color = '#dc3545';
                    }
                    
                    // إعطاء فرصة أخرى بعد 3 ثوان
                    setTimeout(() => {
                        reject(error);
                    }, 3000);
                });
        }, 1000);
        
        // timeout بعد 10 دقائق
        setTimeout(() => {
            clearInterval(progressInterval);
            reject(new Error('انتهت مهلة العملية'));
        }, 600000);
    });
}

// إضافة CSS للـ RTL support في SweetAlert
if (!document.getElementById('swal-rtl-styles')) {
    const style = document.createElement('style');
    style.id = 'swal-rtl-styles';
    style.textContent = `
        .swal-rtl {
            direction: rtl !important;
            text-align: right !important;
        }
        .swal-title-rtl {
            text-align: center !important;
        }
        .swal-content-rtl {
            text-align: right !important;
        }
        .swal2-html-container {
            text-align: right !important;
        }
        .swal-progress .swal2-popup {
            width: 600px !important;
            max-width: 90vw !important;
        }
        .swal-progress .progress {
            background-color: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        .swal-progress .progress-bar {
            transition: width 0.3s ease;
            font-size: 14px;
            line-height: 25px;
            border-radius: 12px;
        }
        .swal-progress #stepDetails {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            font-family: 'Tajawal', sans-serif;
        }
        .swal-progress #currentStep {
            font-weight: bold;
            font-family: 'Tajawal', sans-serif;
        }
    `;
    document.head.appendChild(style);
}
</script> 