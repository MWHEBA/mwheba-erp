{% load static %}
{% load i18n %}

<header class="header">
    <div class="header-container">
        <!-- Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠÙ…Ù† Ù„Ù„Ù‡ÙŠØ¯Ø± (Ø¨Ø¯Ø¡Ù‹Ø§ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ†): Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§ØªØŒ Ø§Ù„Ø¨Ø­Ø«ØŒ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
        <div class="header-right">
            <!-- Ø²Ø± Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„) -->
            <button type="button" class="mobile-sidebar-btn d-lg-none">
                <i class="fas fa-bars"></i>
            </button>
            
            <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© Ù…Ø¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© -->
            <div class="page-title-wrapper">
                <div class="page-icon">
                    <i class="{% if page_icon %}{{ page_icon }}{% elif icon %}{{ icon }}{% else %}
                        {% with page_header=page_title|default:'' %}
                        {% if 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„' in page_header %}fas fa-user-plus
                        {% elif 'Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯' in page_header %}fas fa-handshake
                        {% elif 'Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬' in page_header %}fas fa-box-open
                        {% elif 'Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø©' in page_header or 'ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©' in page_header %}fas fa-file-invoice
                        {% elif 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…' in page_header %}fas fa-user-plus
                        {% elif 'Ø¥Ø¶Ø§ÙØ©' in page_header and 'Ø¹Ù…ÙŠÙ„' in page_header %}fas fa-user-plus
                        {% elif 'Ø¥Ø¶Ø§ÙØ©' in page_header and 'Ù…ÙˆØ±Ø¯' in page_header %}fas fa-handshake
                        {% elif 'Ø¥Ø¶Ø§ÙØ©' in page_header and 'Ù…Ù†ØªØ¬' in page_header %}fas fa-box-open
                        {% elif 'Ø¥Ø¶Ø§ÙØ©' in page_header and 'Ù…Ø³ØªØ®Ø¯Ù…' in page_header %}fas fa-user-plus
                        {% elif 'Ø¥Ø¶Ø§ÙØ©' in page_header and 'Ù…Ø®Ø²ÙˆÙ†' in page_header %}fas fa-warehouse
                        {% elif 'Ø¥Ø¶Ø§ÙØ©' in page_header and 'ØµÙ†Ù' in page_header %}fas fa-boxes
                        {% elif 'Ø¥Ø¶Ø§ÙØ©' in page_header and 'ÙØ§ØªÙˆØ±Ø©' in page_header %}fas fa-file-invoice
                        {% elif 'Ø¥Ø¶Ø§ÙØ©' in page_header %}fas fa-plus-circle
                        {% elif 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡' in page_header %}fas fa-users
                        {% elif 'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª' in page_header %}fas fa-box
                        {% elif 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª' in page_header %}fas fa-shopping-cart
                        {% elif 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª' in page_header %}fas fa-truck
                        {% elif 'Ø§Ù„Ù…Ø§Ù„ÙŠØ©' in page_header %}fas fa-money-bill-wave
                        {% elif 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±' in page_header %}fas fa-chart-bar
                        {% elif 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª' in page_header %}fas fa-bell
                        {% elif 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª' in page_header %}fas fa-cog
                        {% elif 'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ' in page_header %}fas fa-user
                        {% elif 'Ø§Ù„Ø£Ù†ÙˆØ§Ø¹' in page_header %}fas fa-tag
                        {% elif 'Ø§Ù„Ø£ØµÙ†Ø§Ù' in page_header %}fas fa-boxes
                        {% elif 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†' in page_header %}fas fa-warehouse
                        {% elif 'Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†' in page_header %}fas fa-handshake
                        {% elif 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª' in page_header %}fas fa-file-invoice-dollar
                        {% elif 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª' in page_header %}fas fa-hand-holding-usd
                        {% else %}fas fa-home{% endif %}
                        {% endwith %}
                    {% endif %}"></i>
                </div>
                <h1 class="page-title">{% if page_title %}{{ page_title }}{% else %}Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…{% endif %}</h1>
            </div>
        </div>

        <!-- Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø± Ù„Ù„Ù‡ÙŠØ¯Ø±: Ø§Ø³Ù… Ø§Ù„ØµÙØ­Ø© Ù…Ø¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© -->
        <div class="header-left">
            <!-- Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
            <div class="quick-actions dropdown">
                <button class="quick-action-btn" type="button" id="quickActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-bolt"></i>
                    <span>Ø¥Ø¬Ø±Ø§Ø¡ Ø³Ø±ÙŠØ¹</span>
                </button>
                <div class="dropdown-menu dropdown-menu-end quick-actions-dropdown shadow-lg" aria-labelledby="quickActionsDropdown">
                    <div class="quick-actions-header">
                        <h6 class="dropdown-header">
                            <i class="fas fa-bolt me-2 text-primary"></i>
                            <span>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</span>
                        </h6>
                    </div>
                    
                    <div class="quick-actions-body">
                        <!-- Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª -->
                        <div class="quick-actions-category">
                            <h6 class="dropdown-header text-primary">
                                <i class="fas fa-shopping-cart me-2"></i>
                                <span>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
                            </h6>
                            <a class="dropdown-item quick-action-item" href="{% url 'core:dashboard' %}">
                                <div class="quick-action-icon bg-soft-primary">
                                    <i class="fas fa-cart-plus text-primary"></i>
                                </div>
                                <div class="quick-action-content">
                                    <div class="quick-action-title">ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯Ø©</div>
                                    <div class="quick-action-desc">Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                                </div>
                                <div class="quick-action-shortcut">
                                    <span class="badge rounded-pill bg-soft-primary text-primary">Alt+S</span>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª -->
                        <div class="quick-actions-category">
                            <h6 class="dropdown-header text-success">
                                <i class="fas fa-truck me-2"></i>
                                <span>Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</span>
                            </h6>
                            <a class="dropdown-item quick-action-item" href="{% url 'core:dashboard' %}">
                                <div class="quick-action-icon bg-soft-success">
                                    <i class="fas fa-shopping-bag text-success"></i>
                                </div>
                                <div class="quick-action-content">
                                    <div class="quick-action-title">ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©</div>
                                    <div class="quick-action-desc">Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</div>
                                </div>
                                <div class="quick-action-shortcut">
                                    <span class="badge rounded-pill bg-soft-success text-success">Alt+P</span>
                                </div>
                            </a>
                        </div>
                        
                        <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ† -->
                        <div class="quick-actions-category">
                            <h6 class="dropdown-header text-info">
                                <i class="fas fa-box-open me-2"></i>
                                <span>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
                            </h6>
                            <a class="dropdown-item quick-action-item" href="{% url 'core:dashboard' %}">
                                <div class="quick-action-icon bg-soft-info">
                                    <i class="fas fa-box text-info"></i>
                                </div>
                                <div class="quick-action-content">
                                    <div class="quick-action-title">Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</div>
                                    <div class="quick-action-desc">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</div>
                                </div>
                            </a>
                            <a class="dropdown-item quick-action-item" href="{% url 'core:dashboard' %}">
                                <div class="quick-action-icon bg-soft-secondary">
                                    <i class="fas fa-exchange-alt text-secondary"></i>
                                </div>
                                <div class="quick-action-content">
                                    <div class="quick-action-title">ØªØ­ÙˆÙŠÙ„ Ù…Ø®Ø²Ù†ÙŠ</div>
                                    <div class="quick-action-desc">ØªØ­ÙˆÙŠÙ„ Ù…Ù†ØªØ¬Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ù…Ø®Ø§Ø²Ù†</div>
                                </div>
                            </a>
                            <a class="dropdown-item quick-action-item" href="{% url 'core:dashboard' %}">
                                <div class="quick-action-icon bg-soft-dark">
                                    <i class="fas fa-barcode text-dark"></i>
                                </div>
                                <div class="quick-action-content">
                                    <div class="quick-action-title">Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</div>
                                    <div class="quick-action-desc">Ø¥Ø¬Ø±Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¬Ø±Ø¯ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« -->
            <div class="search-box">
                <form class="search-form" action="#" method="GET">
                    <div class="input-group">
                        <input type="text" class="form-control" name="q" placeholder="Ø¨Ø­Ø«..." aria-label="Ø¨Ø­Ø«">
                        <span class="input-group-text">
                            <button type="submit" class="btn-search border-0 bg-transparent p-0">
                                <i class="fas fa-search"></i>
                            </button>
                        </span>
                    </div>
                </form>
            </div>
            <!-- Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
            <div class="notifications dropdown">
                <button class="btn-icon notification-btn" type="button" id="notificationsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-bell"></i>
                    {% with unread_count=0 %}
                    {% for notification in notifications %}
                        {% if not notification.read %}
                            {% with unread_count=unread_count|add:1 %}{% endwith %}
                        {% endif %}
                    {% endfor %}
                    <span class="badge bg-danger badge-counter notification-badge {% if unread_count == 0 %}d-none{% endif %}">
                        {{ unread_count }}
                    </span>
                    {% endwith %}
                </button>
                <div class="dropdown-menu dropdown-menu-end notifications-dropdown shadow-lg" aria-labelledby="notificationsDropdown">
                    <div class="dropdown-header d-flex justify-content-between align-items-center py-3">
                        <span class="fw-bold">
                            <i class="fas fa-bell me-2 text-primary"></i>
                            {% trans "Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª" %}
                            {% with unread_count=0 %}
                            {% for notification in notifications %}
                                {% if not notification.read %}
                                    {% with unread_count=unread_count|add:1 %}{% endwith %}
                                {% endif %}
                            {% endfor %}
                            {% if unread_count > 0 %}
                            <span class="badge bg-danger rounded-pill ms-2">{{ unread_count }}</span>
                            {% endif %}
                            {% endwith %}
                        </span>
                        {% with unread_count=0 %}
                        {% for notification in notifications %}
                            {% if not notification.read %}
                                {% with unread_count=unread_count|add:1 %}{% endwith %}
                            {% endif %}
                        {% endfor %}
                        {% if unread_count > 0 %}
                        <button type="button" class="btn btn-sm btn-outline-primary mark-all-read" data-url="{% url 'core:mark_all_notifications_read' %}">
                            <i class="fas fa-check-double"></i>
                            <span class="d-none d-md-inline-block">{% trans "ØªØ¹Ù„ÙŠÙ… Ø§Ù„ÙƒÙ„ ÙƒÙ…Ù‚Ø±ÙˆØ¡" %}</span>
                        </button>
                        {% endif %}
                        {% endwith %}
                    </div>
                    
                    <div class="notification-list ps-custom">
                        {% if notifications %}
                            <!-- Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© -->
                            {% with unread_notifications='' %}
                            {% with has_unread=False %}
                            <div class="notification-category">
                                <div class="notification-category-title">
                                    <span>{% trans "Ø¬Ø¯ÙŠØ¯Ø©" %}</span>
                                </div>
                                {% for notification in notifications %}
                                    {% if not notification.read %}
                                        {% with has_unread=True %}{% endwith %}
                                        <a href="{{ notification.link }}" class="notification-item unread" data-id="{{ notification.id }}">
                                            <div class="notification-icon bg-{{ notification.notification_type }}">
                                                <i class="fas 
                                                    {% if notification.notification_type == 'info' %}fa-info
                                                    {% elif notification.notification_type == 'warning' %}fa-exclamation-triangle
                                                    {% elif notification.notification_type == 'success' %}fa-check
                                                    {% elif notification.notification_type == 'danger' %}fa-times
                                                    {% elif notification.notification_type == 'inventory_alert' %}fa-box
                                                    {% elif notification.notification_type == 'payment_received' %}fa-money-bill-wave
                                                    {% elif notification.notification_type == 'new_invoice' %}fa-file-invoice
                                                    {% elif notification.notification_type == 'return_request' %}fa-undo
                                                    {% else %}fa-bell
                                                    {% endif %}">
                                                </i>
                                </div>
                                <div class="notification-content">
                                    <div class="notification-title">{{ notification.title }}</div>
                                    <div class="notification-text">{{ notification.message }}</div>
                                                <div class="notification-time">
                                                    <i class="far fa-clock me-1"></i>
                                                    {{ notification.created_at|timesince }}
                                                </div>
                                            </div>
                                            <button type="button" class="btn-mark-read" data-id="{{ notification.id }}" data-url="{% url 'core:mark_notification_read' notification.id %}">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </a>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            {% if not has_unread %}
                                <style>.notification-category:first-child { display: none; }</style>
                            {% endif %}
                            {% endwith %}
                            {% endwith %}
                            
                            <!-- Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© Ù…Ø¤Ø®Ø±Ù‹Ø§ -->
                            {% with has_read=False %}
                            <div class="notification-category">
                                <div class="notification-category-title">
                                    <span>{% trans "Ø³Ø§Ø¨Ù‚Ø©" %}</span>
                                </div>
                                {% for notification in notifications %}
                                    {% if notification.read %}
                                        {% with has_read=True %}{% endwith %}
                                        <a href="{{ notification.link }}" class="notification-item">
                                            <div class="notification-icon bg-light text-{{ notification.notification_type }}">
                                                <i class="fas 
                                                    {% if notification.notification_type == 'info' %}fa-info
                                                    {% elif notification.notification_type == 'warning' %}fa-exclamation-triangle
                                                    {% elif notification.notification_type == 'success' %}fa-check
                                                    {% elif notification.notification_type == 'danger' %}fa-times
                                                    {% elif notification.notification_type == 'inventory_alert' %}fa-box
                                                    {% elif notification.notification_type == 'payment_received' %}fa-money-bill-wave
                                                    {% elif notification.notification_type == 'new_invoice' %}fa-file-invoice
                                                    {% elif notification.notification_type == 'return_request' %}fa-undo
                                                    {% else %}fa-bell
                                                    {% endif %}">
                                                </i>
                                            </div>
                                            <div class="notification-content">
                                                <div class="notification-title">{{ notification.title }}</div>
                                                <div class="notification-text">{{ notification.message }}</div>
                                                <div class="notification-time">
                                                    <i class="far fa-clock me-1"></i>
                                                    {{ notification.created_at|timesince }}
                                                </div>
                                </div>
                            </a>
                                    {% endif %}
                            {% endfor %}
                            </div>
                            {% if not has_read %}
                                <style>.notification-category:last-child { display: none; }</style>
                            {% endif %}
                            {% endwith %}
                        {% else %}
                            <div class="dropdown-item text-center py-5">
                                <div class="empty-notifications">
                                    <i class="far fa-bell-slash fa-3x text-muted mb-3"></i>
                                    <p class="text-muted mb-0">{% trans "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©" %}</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <div class="dropdown-footer py-2 text-center">
                        <a href="{% url 'core:notifications_list' %}" class="btn btn-sm btn-light w-100">
                            <i class="fas fa-list me-1"></i>
                            {% trans "Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª" %}
                        </a>
                    </div>
                </div>
            </div>
            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
            <div class="user-menu dropdown">
                <button class="user-dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <div class="avatar-wrapper">
                        <div class="avatar">
                            {% if user.profile_image %}
                                <img src="{{ user.profile_image.url }}" alt="{{ user.get_full_name }}" class="avatar-img">
                            {% else %}
                                <img src="{% static 'img/user.png' %}" alt="{{ user.get_full_name }}" class="avatar-img">
                            {% endif %}
                        </div>
                        <span class="user-name-short d-none d-md-inline-block">{{ user.get_full_name|default:"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" }}</span>
                        <i class="fas fa-chevron-down ms-1 user-dropdown-icon"></i>
                    </div>
                </button>
                <div class="dropdown-menu dropdown-menu-end user-dropdown">
                    <div class="user-dropdown-header">
                        <div class="user-dropdown-profile">
                            <div class="user-avatar-large">
                                {% if user.profile_image %}
                                    <img src="{{ user.profile_image.url }}" alt="{{ user.get_full_name }}" class="user-avatar-img">
                                {% else %}
                                    <img src="{% static 'img/user.png' %}" alt="{{ user.get_full_name }}" class="user-avatar-img">
                                {% endif %}
                            </div>
                            <div class="user-info-wrapper">
                                <h5 class="user-name">{{ user.get_full_name|default:"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" }}</h5>
                                <p class="user-email">{{ user.email|default:"user@example.com" }}</p>
                                <span class="user-role">{{ user.role|default:"Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…" }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="user-dropdown-divider"></div>
                    
                    <div class="user-dropdown-menu-items">
                        <a href="#" class="user-dropdown-item">
                            <div class="dropdown-item-icon bg-soft-primary">
                                <i class="fas fa-user-circle text-primary"></i>
                            </div>
                            <div class="dropdown-item-text">
                                <span>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</span>
                                <small>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©</small>
                            </div>
                        </a>
                        
                        <a href="#" class="user-dropdown-item">
                            <div class="dropdown-item-icon bg-soft-success">
                                <i class="fas fa-cog text-success"></i>
                            </div>
                            <div class="dropdown-item-text">
                                <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
                                <small>ØªØ®ØµÙŠØµ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</small>
                            </div>
                        </a>
                        
                        <a href="#" class="user-dropdown-item">
                            <div class="dropdown-item-icon bg-soft-info">
                                <i class="fas fa-bell text-info"></i>
                            </div>
                            <div class="dropdown-item-text">
                                <span>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
                                <small>Ø¥Ø¯Ø§Ø±Ø© ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</small>
                            </div>
                            <span class="badge rounded-pill bg-danger ms-auto">3</span>
                        </a>
                        
                        <a href="#" class="user-dropdown-item">
                            <div class="dropdown-item-icon bg-soft-warning">
                                <i class="fas fa-history text-warning"></i>
                            </div>
                            <div class="dropdown-item-text">
                                <span>Ø§Ù„Ù†Ø´Ø§Ø·</span>
                                <small>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</small>
                            </div>
                        </a>
                        
                        {% if user.is_superuser %}
                        <a href="#" class="user-dropdown-item" onclick="resetSystem(event)">
                            <div class="dropdown-item-icon bg-soft-danger">
                                <i class="fas fa-undo-alt text-danger"></i>
                            </div>
                            <div class="dropdown-item-text">
                                <span>Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</span>
                                <small>Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ù…ØµÙ†Ø¹ Ù„Ù„Ù†Ø¸Ø§Ù…</small>
                            </div>
                        </a>
                        {% endif %}
                    </div>
                    
                    <div class="user-dropdown-divider"></div>
                    
                    <div class="user-dropdown-footer">
                        <a href="{% url 'logout' %}" class="user-dropdown-item">
                            <div class="dropdown-item-icon bg-soft-danger">
                                <i class="fas fa-sign-out-alt text-danger"></i>
                            </div>
                            <div class="dropdown-item-text">
                                <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
                            </div>
                        </a>
                    </div>
                    
                    <div class="user-dropdown-info">
                        <small>Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„: Ø§Ù„ÙŠÙˆÙ…ØŒ {{ now|time:"h:i a" }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<script>
function resetSystem(event) {
    event.preventDefault();
    
    // SweetAlert ØªØ­Ø°ÙŠØ±ÙŠ Ø§Ø­ØªØ±Ø§ÙÙŠ
    Swal.fire({
        title: 'âš ï¸ ØªØ­Ø°ÙŠØ± Ù‡Ø§Ù…!',
        html: `
            <div style="text-align: right; direction: rtl;">
                <p style="font-size: 16px; margin-bottom: 15px;">
                    <strong>Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ù€:</strong>
                </p>
                <ul style="text-align: right; list-style: none; padding: 0;">
                    <li style="margin-bottom: 8px;">ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©</li>
                    <li style="margin-bottom: 8px;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</li>
                    <li style="margin-bottom: 8px;">ğŸ‘¥ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠÙŠÙ†</li>
                    <li style="margin-bottom: 8px;">ğŸ“Š ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©</li>
                    <li style="margin-bottom: 8px;">âš™ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</li>
                </ul>
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-top: 20px;">
                    <p style="color: #856404; margin: 0; font-weight: bold;">
                        âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!
                    </p>
                </div>
            </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'ğŸ”„ Ù†Ø¹Ù…ØŒ Ø£Ø¹Ø¯ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…',
        cancelButtonText: 'âŒ Ø¥Ù„ØºØ§Ø¡',
        reverseButtons: true,
        customClass: {
            popup: 'swal-rtl',
            title: 'swal-title-rtl',
            content: 'swal-content-rtl'
        },
        showLoaderOnConfirm: true,
        preConfirm: () => {
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ CSRF token
            let csrfToken = '';
            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            const csrfMeta = document.querySelector('meta[name="csrf-token"]');
            
            if (csrfInput) {
                csrfToken = csrfInput.value;
            } else if (csrfMeta) {
                csrfToken = csrfMeta.getAttribute('content');
            } else {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ CSRF Ù…Ù† cookies
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'csrftoken') {
                        csrfToken = value;
                        break;
                    }
                }
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ CSRF token
            if (!csrfToken) {
                throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ CSRF token. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
            }
            
            return fetch('{% url "core:reset_system_with_progress" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    throw new Error(data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');
                }
                
                // Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù…
                return trackResetProgress(data.operation_id);
            })
            .catch(error => {
                console.error('Reset system error:', error);
                Swal.showValidationMessage(`Ø®Ø·Ø£: ${error.message}`);
                return false;
            });
        },
        allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
        if (result.isConfirmed && result.value) {
            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
            Swal.fire({
                title: 'âœ… ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!',
                text: result.value.message,
                icon: 'success',
                timer: 3000,
                timerProgressBar: true,
                showConfirmButton: false,
                customClass: {
                    popup: 'swal-rtl'
                }
            }).then(() => {
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                if (result.value.redirect) {
                    window.location.href = result.value.redirect;
                } else {
                    window.location.reload();
                }
            });
        }
    });
}

// Ø¯Ø§Ù„Ø© ØªØªØ¨Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù…
function trackResetProgress(operationId) {
    return new Promise((resolve, reject) => {
        // Ø¥Ø¸Ù‡Ø§Ø± Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªÙ‚Ø¯Ù…
        Swal.fire({
            title: 'ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…',
            html: `
                <div style="text-align: right; direction: rtl;">
                    <div class="progress mb-3" style="height: 25px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%; background: linear-gradient(45deg, #007bff, #0056b3);">
                            <span id="progressText" style="font-weight: bold; color: white;">0%</span>
                        </div>
                    </div>
                    <div id="currentStep" style="font-size: 16px; margin-bottom: 10px; color: #495057;">
                        Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©...
                    </div>
                    <div id="stepDetails" style="font-size: 14px; color: #6c757d; max-height: 200px; overflow-y: auto;">
                        <div>â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...</div>
                    </div>
                </div>
            `,
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            customClass: {
                popup: 'swal-rtl swal-progress',
                title: 'swal-title-rtl'
            }
        });
        
        // ØªØªØ¨Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù… ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
        const progressInterval = setInterval(() => {
            fetch(`{% url "core:get_reset_progress" "OPERATION_ID" %}`.replace('OPERATION_ID', operationId))
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'not_found') {
                        clearInterval(progressInterval);
                        reject(new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©'));
                        return;
                    }
                    
                    // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                    const progressBar = document.getElementById('progressBar');
                    const progressText = document.getElementById('progressText');
                    const currentStep = document.getElementById('currentStep');
                    const stepDetails = document.getElementById('stepDetails');
                    
                    if (progressBar && progressText && currentStep) {
                        progressBar.style.width = `${data.percentage}%`;
                        progressText.textContent = `${data.percentage}%`;
                        currentStep.textContent = `Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${data.current_step}/${data.total_steps}: ${data.step_name}`;
                        
                        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                        if (data.messages && data.messages.length > 0) {
                            stepDetails.innerHTML = data.messages.map(msg => 
                                `<div style="margin-bottom: 5px;">${msg}</div>`
                            ).join('');
                            stepDetails.scrollTop = stepDetails.scrollHeight;
                        }
                    }
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                    if (data.status === 'completed') {
                        clearInterval(progressInterval);
                        setTimeout(() => {
                            resolve({
                                success: true,
                                message: data.message,
                                redirect: '/login/'
                            });
                        }, 1000);
                    } else if (data.status === 'failed') {
                        clearInterval(progressInterval);
                        let errorMessage = data.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                        if (data.error_details) {
                            console.error('Error details:', data.error_details);
                        }
                        if (data.stderr) {
                            console.error('Script stderr:', data.stderr);
                        }
                        if (data.return_code) {
                            console.error('Return code:', data.return_code);
                        }
                        reject(new Error(errorMessage));
                    }
                })
                .catch(error => {
                    console.error('Progress tracking error:', error);
                    clearInterval(progressInterval);
                    
                    // Ø¹Ø±Ø¶ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
                    const currentStep = document.getElementById('currentStep');
                    if (currentStep) {
                        currentStep.textContent = `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØªØ¨Ø¹: ${error.message}`;
                        currentStep.style.color = '#dc3545';
                    }
                    
                    // Ø¥Ø¹Ø·Ø§Ø¡ ÙØ±ØµØ© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
                    setTimeout(() => {
                        reject(error);
                    }, 3000);
                });
        }, 1000);
        
        // timeout Ø¨Ø¹Ø¯ 10 Ø¯Ù‚Ø§Ø¦Ù‚
        setTimeout(() => {
            clearInterval(progressInterval);
            reject(new Error('Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©'));
        }, 600000);
    });
}

// Ø¥Ø¶Ø§ÙØ© CSS Ù„Ù„Ù€ RTL support ÙÙŠ SweetAlert
if (!document.getElementById('swal-rtl-styles')) {
    const style = document.createElement('style');
    style.id = 'swal-rtl-styles';
    style.textContent = `
        .swal-rtl {
            direction: rtl !important;
            text-align: right !important;
        }
        .swal-title-rtl {
            text-align: center !important;
        }
        .swal-content-rtl {
            text-align: right !important;
        }
        .swal2-html-container {
            text-align: right !important;
        }
        .swal-progress .swal2-popup {
            width: 600px !important;
            max-width: 90vw !important;
        }
        .swal-progress .progress {
            background-color: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }
        .swal-progress .progress-bar {
            transition: width 0.3s ease;
            font-size: 14px;
            line-height: 25px;
            border-radius: 12px;
        }
        .swal-progress #stepDetails {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            font-family: 'Tajawal', sans-serif;
        }
        .swal-progress #currentStep {
            font-weight: bold;
            font-family: 'Tajawal', sans-serif;
        }
    `;
    document.head.appendChild(style);
}
</script> 