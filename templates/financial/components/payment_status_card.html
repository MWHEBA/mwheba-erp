{% load payment_status_tags %}

<div class="card payment-status-card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="card-title mb-0">
            <i class="fas fa-credit-card me-2"></i>
            دفعة #{{ payment.id }}
            {% if payment.sale %}
                - فاتورة مبيعات {{ payment.sale.number }}
            {% elif payment.purchase %}
                - فاتورة مشتريات {{ payment.purchase.number }}
            {% endif %}
        </h6>
        
        <div class="payment-status-badges">
            {% payment_posting_status_badge payment %}
            {% payment_financial_status_badge payment %}
        </div>
    </div>
    
    <div class="card-body">
        <div class="row">
            <!-- معلومات الدفعة الأساسية -->
            <div class="col-md-6">
                <h6 class="text-muted mb-2">
                    <i class="fas fa-info-circle me-1"></i>
                    معلومات الدفعة
                </h6>
                <ul class="list-unstyled mb-0">
                    <li><strong>المبلغ:</strong> {{ payment.amount|floatformat:2 }} ج.م</li>
                    <li><strong>تاريخ الدفع:</strong> {{ payment.payment_date }}</li>
                    <li><strong>طريقة الدفع:</strong> {{ payment.get_payment_method_display }}</li>
                    {% if payment.reference_number %}
                        <li><strong>رقم المرجع:</strong> {{ payment.reference_number }}</li>
                    {% endif %}
                </ul>
            </div>
            
            <!-- معلومات الربط المالي -->
            <div class="col-md-6">
                <h6 class="text-muted mb-2">
                    <i class="fas fa-link me-1"></i>
                    الربط المالي
                </h6>
                
                {% if payment.financial_account %}
                    <div class="mb-2">
                        <span class="badge badge-outline-primary">
                            <i class="fas fa-university me-1"></i>
                            {{ payment.financial_account.name }}
                        </span>
                    </div>
                {% endif %}
                
                {% if payment.financial_transaction %}
                    <div class="mb-2">
                        <span class="badge badge-outline-success">
                            <i class="fas fa-file-invoice me-1"></i>
                            القيد: {{ payment.financial_transaction.number }}
                        </span>
                    </div>
                {% endif %}
                
                {% if payment.financial_status == 'failed' and payment.financial_error %}
                    <div class="alert alert-danger alert-sm mb-2">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>خطأ:</strong> {{ payment.financial_error|truncatechars:100 }}
                    </div>
                {% endif %}
                
                {% if payment.posted_at %}
                    <small class="text-muted d-block">
                        <i class="fas fa-clock me-1"></i>
                        رُحّل في: {{ payment.posted_at|date:"Y-m-d H:i" }}
                        {% if payment.posted_by %}
                            بواسطة {{ payment.posted_by.get_full_name|default:payment.posted_by.username }}
                        {% endif %}
                    </small>
                {% endif %}
            </div>
        </div>
        
        {% if payment.notes %}
            <div class="mt-3">
                <h6 class="text-muted mb-2">
                    <i class="fas fa-sticky-note me-1"></i>
                    ملاحظات
                </h6>
                <p class="text-muted mb-0">{{ payment.notes }}</p>
            </div>
        {% endif %}
    </div>
    
    {% if show_actions and user %}
        <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
                <div class="payment-actions">
                    {% if can_edit %}
                        <button class="btn btn-sm btn-outline-primary me-2" 
                                onclick="editPayment({{ payment.id }})" 
                                title="تعديل الدفعة">
                            <i class="fas fa-edit me-1"></i>
                            تعديل
                        </button>
                    {% endif %}
                    
                    {% if can_unpost and user.has_perm:'financial.can_unpost_payments' %}
                        <button class="btn btn-sm btn-outline-warning me-2" 
                                onclick="unpostPayment({{ payment.id }})" 
                                title="إلغاء الترحيل">
                            <i class="fas fa-undo me-1"></i>
                            إلغاء الترحيل
                        </button>
                    {% endif %}
                    
                    <button class="btn btn-sm btn-outline-info me-2" 
                            onclick="showPaymentHistory({{ payment.id }})" 
                            title="تاريخ التغييرات">
                        <i class="fas fa-history me-1"></i>
                        التاريخ
                    </button>
                    
                    {% if can_delete %}
                        <button class="btn btn-sm btn-outline-danger" 
                                onclick="deletePayment({{ payment.id }})" 
                                title="حذف الدفعة">
                            <i class="fas fa-trash me-1"></i>
                            حذف
                        </button>
                    {% endif %}
                </div>
                
                <div class="payment-links">
                    {% if payment.financial_transaction %}
                        <a href="{% url 'financial:journal_entry_detail' payment.financial_transaction.id %}" 
                           class="btn btn-sm btn-link" 
                           target="_blank" 
                           title="عرض القيد المحاسبي">
                            <i class="fas fa-external-link-alt me-1"></i>
                            عرض القيد
                        </a>
                    {% endif %}
                    
                    {% if payment.sale %}
                        <a href="{% url 'sale:sale_detail' payment.sale.id %}" 
                           class="btn btn-sm btn-link" 
                           target="_blank" 
                           title="عرض فاتورة المبيعات">
                            <i class="fas fa-file-invoice me-1"></i>
                            الفاتورة
                        </a>
                    {% elif payment.purchase %}
                        <a href="{% url 'purchase:purchase_detail' payment.purchase.id %}" 
                           class="btn btn-sm btn-link" 
                           target="_blank" 
                           title="عرض فاتورة المشتريات">
                            <i class="fas fa-file-invoice me-1"></i>
                            الفاتورة
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}
</div>

<style>
.payment-status-card {
    border: 1px solid #e3e6f0;
    border-radius: 0.35rem;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    transition: all 0.3s;
}

.payment-status-card:hover {
    box-shadow: 0 0.25rem 2rem 0 rgba(58, 59, 69, 0.2);
    transform: translateY(-2px);
}

.payment-status-badges .badge {
    margin-left: 0.25rem;
}

.badge-outline-primary {
    color: var(--bs-primary);
    border: 1px solid var(--bs-primary);
    background-color: transparent;
}

.badge-outline-success {
    color: var(--bs-success);
    border: 1px solid var(--bs-success);
    background-color: transparent;
}

.alert-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

.payment-actions .btn {
    font-size: 0.875rem;
}

.payment-links .btn-link {
    font-size: 0.875rem;
    text-decoration: none;
}

.payment-links .btn-link:hover {
    text-decoration: underline;
}
</style>
