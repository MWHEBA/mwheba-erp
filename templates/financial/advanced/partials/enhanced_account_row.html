{% load utils_extras %}
<!-- صف الحساب في الجدول مع ديناميكية -->
<tr class="account-row level-{{ level }} {% if account.is_leaf %}leaf-row{% endif %} {% if not account.is_active %}text-muted{% endif %} {% if account.children.exists %}expandable-row{% endif %}" 
    data-account-id="{{ account.id }}" 
    data-level="{{ level }}"
    {% if account.is_leaf %}data-href="{% url 'financial:account_detail' account.pk %}"{% endif %}
    id="account-{{ account.id }}"
    {% if account.children.exists %}onclick="toggleAccountChildren({{ account.id }})" style="cursor: pointer;"{% endif %}>
    
    <!-- كود الحساب -->
    <td>{{ account.code }}</td>
    
    <td>
        <div class="d-flex align-items-center indent">
            <!-- أيقونة التوسع/الطي -->
            {% if account.children.exists %}
                <button type="button" class="btn btn-sm btn-link p-0 me-2 expand-btn" 
                        title="توسيع/طي">
                    <i class="fas fa-chevron-left" id="icon-{{ account.id }}"></i>
                </button>
            {% else %}
                <span class="me-4"></span>
            {% endif %}
            
            {% if account.is_leaf %}
                <i class="fas fa-file text-info me-2"></i>
                <!-- اسم الحساب كـ رابط للحسابات النهائية -->
                <a href="{% url 'financial:account_detail' account.pk %}" class="account-name text-decoration-none">{{ account.name }}</a>
            {% else %}
                <i class="fas fa-folder text-warning me-2"></i>
                <!-- اسم الحساب نص فقط للحسابات الأب -->
                <span class="account-name">{{ account.name }}</span>
            {% endif %}
            
            <!-- شارات إضافية -->
            {% if account.is_cash_account %}
                <small class="badge bg-success ms-2">نقدي</small>
            {% endif %}
            {% if account.is_bank_account %}
                <small class="badge bg-info ms-2">بنكي</small>
            {% endif %}
        </div>
    </td>
    
    <!-- نوع الحساب - للحسابات النهائية فقط -->
    <td>
        {% if account.is_leaf %}
            {{ account.account_type.name }}
        {% else %}
            <span class="text-muted">-</span>
        {% endif %}
    </td>
    
    <!-- الرصيد - للحسابات النهائية فقط -->
    <td class="text-end">
        {% if account.is_leaf %}
            {% if account.current_balance %}
                <span class="{% if account.current_balance > 0 %}text-success{% elif account.current_balance < 0 %}text-danger{% endif %}">
                    {{ account.current_balance|remove_trailing_zeros }}
                </span>
            {% else %}
                <span class="text-muted">0.00</span>
            {% endif %}
        {% else %}
            <span class="text-muted">-</span>
        {% endif %}
    </td>
    
    <!-- الحالة -->
    <td class="text-center">
        {% if account.is_active %}
            <span class="badge bg-success">نشط</span>
        {% else %}
            <span class="badge bg-secondary">غير نشط</span>
        {% endif %}
    </td>
    
    <!-- الإجراءات -->
    <td onclick="event.stopPropagation();">
        <div class="btn-group btn-group-sm">
            <a href="{% url 'financial:account_detail' account.pk %}" 
               class="btn btn-outline-primary btn-sm" 
               title="عرض التفاصيل">
                <i class="fas fa-eye"></i>
            </a>
            <a href="{% url 'financial:account_edit' account.pk %}" 
               class="btn btn-outline-warning btn-sm" 
               title="تعديل">
                <i class="fas fa-edit"></i>
            </a>
        </div>
    </td>
</tr>

<!-- الحسابات الفرعية (مخفية افتراضياً) -->
{% for child in account.children.all %}
    {% if child.is_active or show_inactive %}
        {% include 'financial/advanced/partials/enhanced_account_row.html' with account=child level=level|add:"1" %}
    {% endif %}
{% endfor %}
