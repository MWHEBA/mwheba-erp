{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<link href="{% static 'css/components.css' %}" rel="stylesheet">
<link href="{% static 'css/dynamic_services.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© -->
    <div class="mb-4">
        <!-- Breadcrumbs -->
        <div class="mb-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item">
                        <a href="{% url 'core:dashboard' %}">
                            <i class="fas fa-home me-1"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'supplier:supplier_list' %}">
                            <i class="fas fa-truck me-1"></i>Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'supplier:supplier_detail' supplier.pk %}">
                            <i class="fas fa-building me-1"></i>{{ supplier.name }}
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page" id="breadcrumb-title">
                        <i class="{{ page_icon }} me-1"></i>
                        {% if is_edit %}
                            ØªØ¹Ø¯ÙŠÙ„ Ø®Ø¯Ù…Ø© - {{ service.name }}
                        {% elif selected_category == 'paper' %}
                            Ø¥Ø¶Ø§ÙØ© ÙˆØ±Ù‚
                        {% elif request.GET.category == 'offset_printing' %}
                            Ø¥Ø¶Ø§ÙØ© Ù…Ø§ÙƒÙŠÙ†Ø© Ø£ÙˆÙØ³Øª
                        {% elif request.GET.category == 'digital_printing' %}
                            Ø¥Ø¶Ø§ÙØ© Ù…Ø§ÙƒÙŠÙ†Ø© Ø¯ÙŠØ¬ÙŠØªØ§Ù„
                        {% elif request.GET.category == 'finishing' %}
                            Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø© Ø·Ø¨Ø§Ø¹Ø©
                        {% elif request.GET.category == 'plates' %}
                            Ø¥Ø¶Ø§ÙØ© Ù†ÙˆØ¹ Ø²Ù†Ùƒ CTP
                        {% else %}
                            Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø© Ù…ØªØ®ØµØµØ©
                        {% endif %}
                    </li>
                </ol>
            </nav>
        </div>

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center bg-white p-3 rounded shadow-sm">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="{{ page_icon }} fa-2x text-primary"></i>
                </div>
                <div>
                    <h1 class="h3 mb-1" id="page-title">
                        {% if is_edit %}
                            ØªØ¹Ø¯ÙŠÙ„ Ø®Ø¯Ù…Ø©: {{ service.name }}
                        {% elif selected_category == 'paper' %}
                            Ø¥Ø¶Ø§ÙØ© ÙˆØ±Ù‚
                        {% elif selected_category == 'offset_printing' %}
                            Ø¥Ø¶Ø§ÙØ© Ù…Ø§ÙƒÙŠÙ†Ø© Ø£ÙˆÙØ³Øª
                        {% elif selected_category == 'digital_printing' %}
                            Ø¥Ø¶Ø§ÙØ© Ù…Ø§ÙƒÙŠÙ†Ø© Ø¯ÙŠØ¬ÙŠØªØ§Ù„
                        {% elif selected_category == 'finishing' %}
                            Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø© Ø·Ø¨Ø§Ø¹Ø©
                        {% elif selected_category == 'plates' %}
                            Ø¥Ø¶Ø§ÙØ© Ù†ÙˆØ¹ Ø²Ù†Ùƒ CTP
                        {% else %}
                            Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø© Ù…ØªØ®ØµØµØ©
                        {% endif %}
                        {% if not is_edit %}
                        <a href="#" id="change-category-link" class="text-decoration-none ms-2" 
                           style="font-size: 12px; color: var(--gray-500);"
                           onclick="toggleCategorySelection()">
                            (ØªØºÙŠÙŠØ±)
                        </a>
                        {% endif %}
                    </h1>
                    <p class="text-muted mb-0">
                        <i class="fas fa-building me-1"></i>
                        Ø§Ù„Ù…ÙˆØ±Ø¯: <strong>{{ supplier.name }}</strong>
                    </p>
                </div>
            </div>
            <div>
                <a href="{% url 'supplier:supplier_detail' supplier.pk %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Ø±Ø¬ÙˆØ¹
                </a>
            </div>
        </div>
    </div>

    <form id="dynamic-service-form" method="post">
        {% csrf_token %}
        <input type="hidden" name="supplier_id" value="{{ supplier.id }}">
        {% if is_edit and service %}
        <input type="hidden" name="service_id" value="{{ service.id }}">
        {% endif %}
        
        <!-- Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø© -->
        <div class="form-section" id="category-selection-section" {% if selected_category %}style="display: none;"{% else %}style="display: block;"{% endif %}>
            <div class="form-section-header">
                <h5 class="mb-0">
                    <i class="fas fa-tags me-2"></i>
                    Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©
                </h5>
            </div>
            <div class="form-section-body">
                <div class="row g-3">
                    {% for category in categories %}
                    <div class="col-md-4 col-lg-3">
                        <div class="category-card p-3 text-center h-100" 
                             data-category="{{ category.code }}" 
                             data-name="{{ category.name }}"
                             data-color="{{ category.color|default:'#6c757d' }}"
                             onclick="selectCategory(this)">
                            <i class="{{ category.icon }} fa-2x mb-2 category-icon"></i>
                            <h6 class="mb-1">{{ category.name }}</h6>
                            <small class="text-muted">{{ category.description|default:"" }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <input type="hidden" id="selected-category" name="category_code" value="{{ selected_category }}">
                
                <div class="alert alert-info mt-3" id="category-help" style="display: none;">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="category-help-text"></span>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ -->
        <div class="form-section" id="dynamic-form-section" {% if is_edit or selected_category %}style="display: block;"{% else %}style="display: none;"{% endif %}>
            <div class="form-section-header">
                <h5 class="mb-0">
                    <i class="fas fa-edit me-2"></i>
                    <span id="form-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©</span>
                </h5>
            </div>
            <div class="form-section-body">
                <!-- Loading Spinner -->
                <div class="loading-spinner" id="form-loading" {% if is_edit or selected_category %}style="display: none;"{% else %}style="display: block;"{% endif %}>
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                    </div>
                    <p class="mt-2 text-muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...</p>
                </div>
                
                <!-- Dynamic Form Container -->
                <div id="dynamic-form-container">
                    {% if is_edit %}
                        {% include form_template %}
                    {% elif selected_category and form_template %}
                        {% include form_template %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­ÙØ¸ -->
        <div class="form-section" id="save-section" {% if is_edit or selected_category %}style="display: block;"{% else %}style="display: none;"{% endif %}>
            <div class="form-section-body text-center">
                <button type="submit" class="btn btn-save btn-lg me-3">
                    <i class="fas fa-save me-2"></i>
                    Ø­ÙØ¸ Ø§Ù„Ø®Ø¯Ù…Ø©
                </button>
                <button type="button" class="btn btn-outline-secondary btn-lg" onclick="resetForm()">
                    <i class="fas fa-undo me-2"></i>
                    Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
                </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/universal_form_handler.js' %}"></script>
<script>
// Ù…ØªØºÙŠØ±Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©
let selectedCategory = {% if is_edit %}'{{ service.category.code }}'{% elif selected_category %}'{{ selected_category }}'{% else %}null{% endif %};
let priceTiers = [];
let tierCounter = 0;

// Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ­Ø¯ ÙÙ‚Ø·

// Ø¯ÙˆØ§Ù„ Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
async function selectCategory(element) {
    document.querySelectorAll('.category-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    element.classList.add('selected');
    selectedCategory = element.dataset.category;
    
    document.getElementById('selected-category').value = selectedCategory;
    
    // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†ÙˆØ¹
    document.getElementById('category-selection-section').style.display = 'none';
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…Ø¹ loading
    const formSection = document.getElementById('dynamic-form-section');
    const formContainer = document.getElementById('dynamic-form-container');
    const formLoading = document.getElementById('form-loading');
    const saveSection = document.getElementById('save-section');
    
    formSection.style.display = 'block';
    formLoading.style.display = 'block';
    formContainer.innerHTML = '';
    
    try {
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
        const response = await fetch(`/supplier/api/get-category-form/?category=${selectedCategory}&supplier_id={{ supplier.id }}`);
        const data = await response.json();
        
        if (data.success) {
            formLoading.style.display = 'none';
            formContainer.innerHTML = data.html;
            saveSection.style.display = 'block';
            
            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ­Ø¯ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
            if (typeof UniversalFormHandler !== 'undefined') {
                console.log(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†ÙˆØ¹: ${selectedCategory}`);
                window.universalHandler = new UniversalFormHandler(selectedCategory, null, '{{ supplier.id }}');
                window.universalHandler.initialize();
            }
            
            // ØªÙØ¹ÙŠÙ„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            initializeAutoNameGeneration(selectedCategory);
        } else {
            formLoading.style.display = 'none';
            formContainer.innerHTML = '<div class="alert alert-danger">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</div>';
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:', error);
        formLoading.style.display = 'none';
        formContainer.innerHTML = '<div class="alert alert-danger">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…</div>';
    }
}

function toggleCategorySelection() {
    const section = document.getElementById('category-selection-section');
    const link = document.getElementById('change-category-link');
    
    if (section.style.display === 'none') {
        section.style.display = 'block';
        link.textContent = '(Ø¥Ø®ÙØ§Ø¡)';
    } else {
        section.style.display = 'none';
        link.textContent = '(ØªØºÙŠÙŠØ±)';
    }
}

// Ø¯ÙˆØ§Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
function initializeAutoNameGeneration(categoryCode) {
    if (categoryCode === 'offset_printing') {
        initializeOffsetServiceNameGeneration();
    } else if (categoryCode === 'digital_printing') {
        initializeDigitalServiceNameGeneration();
    } else if (categoryCode === 'paper') {
        initializePaperServiceNameGeneration();
    }
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø®Ø¯Ù…Ø© Ø§Ù„Ø£ÙˆÙØ³Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
function initializeOffsetServiceNameGeneration() {
    function generateServiceName() {
        const machineType = document.getElementById('machine-type');
        const sheetSize = document.getElementById('sheet-size');
        const maxColors = document.getElementById('max-colors');
        const serviceNameField = document.getElementById('service-name');
        
        if (machineType && sheetSize && maxColors && serviceNameField) {
            const machineText = machineType.options[machineType.selectedIndex]?.text || '';
            const sizeText = sheetSize.options[sheetSize.selectedIndex]?.text || '';
            const colorsValue = maxColors.value || '1';
            
            if (machineText && sizeText) {
                const serviceName = `Ù…Ø§ÙƒÙŠÙ†Ø© ${sizeText} - ${colorsValue} Ù„ÙˆÙ† - ${machineText}`;
                serviceNameField.value = serviceName;
                console.log('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©:', serviceName);
            }
        }
    }
    
    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    setTimeout(() => {
        const machineType = document.getElementById('machine-type');
        const sheetSize = document.getElementById('sheet-size');
        const maxColors = document.getElementById('max-colors');
        
        if (machineType) {
            machineType.addEventListener('change', generateServiceName);
        }
        if (sheetSize) {
            sheetSize.addEventListener('change', generateServiceName);
        }
        if (maxColors) {
            maxColors.addEventListener('change', generateServiceName);
            maxColors.addEventListener('input', generateServiceName);
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø³Ù… Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        generateServiceName();
    }, 500);
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø®Ø¯Ù…Ø© Ø§Ù„Ø¯ÙŠØ¬ÙŠØªØ§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ - ØªÙ… ØªØ¹Ø·ÙŠÙ„Ù‡ Ù„ØµØ§Ù„Ø­ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ­Ø¯
function initializeDigitalServiceNameGeneration() {
    // ØªÙ… Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ­Ø¯ universal_form_handler.js
    // Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¶Ø§Ø±Ø¨ ÙˆØ¶Ù…Ø§Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠØ­
    console.log('ØªÙ… ØªØ®Ø·ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø¯ÙŠØ¬ÙŠØªØ§Ù„ - ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ­Ø¯');
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø®Ø¯Ù…Ø© Ø§Ù„ÙˆØ±Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ - ØªÙ… ØªØ¹Ø·ÙŠÙ„Ù‡ Ù„ØµØ§Ù„Ø­ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ­Ø¯
function initializePaperServiceNameGeneration() {
    // ØªÙ… Ù†Ù‚Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ­Ø¯ universal_form_handler.js
    // Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¶Ø§Ø±Ø¨ ÙˆØ¶Ù…Ø§Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµØ­ÙŠØ­
    console.log('ØªÙ… ØªØ®Ø·ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³Ù… Ø®Ø¯Ù…Ø© Ø§Ù„ÙˆØ±Ù‚ - ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ­Ø¯');
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
document.addEventListener('DOMContentLoaded', function() {
    // ØªØ·Ø¨ÙŠÙ‚ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
    document.querySelectorAll('.category-card').forEach(card => {
        const icon = card.querySelector('.category-icon');
        const color = card.dataset.color;
        if (icon && color) {
            icon.style.color = color;
        }
    });
    
    if (typeof UniversalFormHandler !== 'undefined') {
        console.log('ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ­Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯...');
        
        const isEditMode = window.location.pathname.includes('/edit/');
        const pathParts = window.location.pathname.split('/');
        const supplierId = pathParts[2];
        let serviceId = null;
        
        if (isEditMode) {
            const serviceIndex = pathParts.indexOf('specialized-services');
            if (serviceIndex !== -1 && pathParts[serviceIndex + 1]) {
                serviceId = pathParts[serviceIndex + 1];
            }
        }
        
        if (selectedCategory) {
            console.log(`Ø¥Ù†Ø´Ø§Ø¡ UniversalFormHandler: ${selectedCategory}, Service ID: ${serviceId}, Supplier ID: ${supplierId}`);
            
            window.universalHandler = new UniversalFormHandler(selectedCategory, serviceId, supplierId);
            
            window.universalHandler.initialize().then(success => {
                if (success) {
                    console.log('âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ­Ø¯ Ø¬Ø§Ù‡Ø² ÙˆÙŠØ¹Ù…Ù„ Ø¨Ù…Ø«Ø§Ù„ÙŠØ©');
                    
                    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¹Ù…Ù„
                    if (isEditMode) {
                        console.log('ğŸ¯ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù†Ø´Ø· - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù…Ù„Ø©');
                    }
                } else {
                    console.warn('âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„Ù… ÙŠÙ‡ÙŠØ¦ Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„');
                }
            }).catch(error => {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ­Ø¯:', error);
            });
        }
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†ÙˆØ¹ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¶Ø§ÙØ© (ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ category Ù…Ø­Ø¯Ø¯)
    {% if not is_edit and not selected_category %}
    const categorySection = document.getElementById('category-selection-section');
    if (categorySection) {
        categorySection.style.display = 'block';
    }
    {% endif %}
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ category Ù…Ø­Ø¯Ø¯ Ù…Ù† URLØŒ Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    {% if selected_category and not is_edit %}
    if (selectedCategory && !document.getElementById('dynamic-form-container').innerHTML.trim()) {
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒØ±Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ ÙƒÙ…Ø®ØªØ§Ø±
        document.querySelectorAll('.category-card').forEach(card => {
            if (card.dataset.category === selectedCategory) {
                card.classList.add('selected');
            }
        });
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        const formSection = document.getElementById('dynamic-form-section');
        const formContainer = document.getElementById('dynamic-form-container');
        const formLoading = document.getElementById('form-loading');
        const saveSection = document.getElementById('save-section');
        
        if (formSection && formContainer && !formContainer.innerHTML.trim()) {
            formSection.style.display = 'block';
            formLoading.style.display = 'block';
            
            fetch(`/supplier/api/get-category-form/?category=${selectedCategory}&supplier_id={{ supplier.id }}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        formLoading.style.display = 'none';
                        formContainer.innerHTML = data.html;
                        saveSection.style.display = 'block';
                        
                        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ­Ø¯
                        if (typeof UniversalFormHandler !== 'undefined') {
                            console.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ù†ÙˆØ¹: ${selectedCategory}`);
                            window.universalHandler = new UniversalFormHandler(selectedCategory, null, '{{ supplier.id }}');
                            window.universalHandler.initialize();
                        }
                        
                        // ØªÙØ¹ÙŠÙ„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                        initializeAutoNameGeneration(selectedCategory);
                    } else {
                        formLoading.style.display = 'none';
                        formContainer.innerHTML = '<div class="alert alert-danger">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</div>';
                    }
                })
                .catch(error => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:', error);
                    formLoading.style.display = 'none';
                    formContainer.innerHTML = '<div class="alert alert-danger">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…</div>';
                });
        }
    }
    {% endif %}
});
</script>
{% endblock %}
