{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load pricing_filters %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
.comparison-card {
    transition: all 0.3s ease;
    border: 1px solid #e3e6f0;
    border-radius: 0.35rem;
    margin-bottom: 1rem;
}

.comparison-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.price-badge {
    font-size: 1.2rem;
    font-weight: bold;
    padding: 0.5rem 1rem;
    border-radius: 0.25rem;
}

.best-price {
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
}

.good-price {
    background: linear-gradient(45deg, #17a2b8, #6f42c1);
    color: white;
}

.high-price {
    background: linear-gradient(45deg, #ffc107, #fd7e14);
    color: white;
}

.tier-info {
    background: #f8f9fc;
    border-radius: 0.25rem;
    padding: 0.5rem;
    margin-top: 0.5rem;
}

.savings-badge {
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
    font-size: 0.9rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
}

.filter-section {
    background: #f8f9fc;
    border-radius: 0.35rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.category-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.category-btn {
    padding: 0.5rem 1rem;
    border: 2px solid #e3e6f0;
    background: white;
    border-radius: 0.25rem;
    text-decoration: none;
    color: #5a5c69;
    transition: all 0.3s ease;
}

.category-btn:hover {
    border-color: #4e73df;
    color: #4e73df;
    text-decoration: none;
}

.category-btn.active {
    background: #4e73df;
    border-color: #4e73df;
    color: white;
}

.quantity-input {
    max-width: 150px;
}

.comparison-stats {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 0.35rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.stat-item {
    text-align: center;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    display: block;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="{{ page_icon }} fa-fw"></i> {{ page_title }}
        </h1>
        <div>
            <a href="{% url 'supplier:service_calculator' %}" class="btn btn-primary">
                <i class="fas fa-calculator fa-sm"></i> حاسبة الخدمات
            </a>
            <a href="{% url 'supplier:bulk_price_calculator' %}" class="btn btn-success">
                <i class="fas fa-list fa-sm"></i> حاسبة مجمعة
            </a>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <h5 class="mb-3"><i class="fas fa-filter"></i> فلترة وبحث</h5>
        
        <!-- Category Selection -->
        <div class="category-selector">
            <a href="{% url 'supplier:price_comparison' %}" 
               class="category-btn {% if not selected_category %}active{% endif %}">
                <i class="fas fa-th-large"></i> جميع التصنيفات
            </a>
            {% for category in categories %}
            <a href="{% url 'supplier:price_comparison' %}?category={{ category.code }}&quantity={{ quantity }}" 
               class="category-btn {% if selected_category.code == category.code %}active{% endif %}">
                <i class="{{ category.icon }}"></i> {{ category.name }}
            </a>
            {% endfor %}
        </div>
        
        <!-- Quantity Input -->
        <form method="GET" class="d-inline-flex align-items-center">
            {% if selected_category %}
            <input type="hidden" name="category" value="{{ selected_category.code }}">
            {% endif %}
            <label for="quantity" class="me-2">الكمية:</label>
            <input type="number" name="quantity" id="quantity" value="{{ quantity }}" 
                   class="form-control quantity-input me-2" min="1">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i> بحث
            </button>
        </form>
    </div>

    {% if selected_category and services %}
    <!-- Comparison Stats -->
    <div class="comparison-stats">
        <div class="row">
            <div class="col-md-3 stat-item">
                <span class="stat-number">{{ services|length }}</span>
                <span class="stat-label">خدمة متاحة</span>
            </div>
            <div class="col-md-3 stat-item">
                <span class="stat-number">{{ quantity }}</span>
                <span class="stat-label">الكمية المطلوبة</span>
            </div>
            <div class="col-md-3 stat-item">
                <span class="stat-number">{% if services %}{{ services.0.total_cost|remove_trailing_zeros }}{% else %}0{% endif %}</span>
                <span class="stat-label">أفضل سعر (ج.م)</span>
            </div>
            <div class="col-md-3 stat-item">
                <span class="stat-number">{% if services %}{% with services|last as last_service %}{{ last_service.total_cost|remove_trailing_zeros }}{% endwith %}{% else %}0{% endif %}</span>
                <span class="stat-label">أعلى سعر (ج.م)</span>
            </div>
        </div>
    </div>
    <div class="row">
        {% for service in services %}
        <div class="col-lg-6 col-xl-4">
            <div class="comparison-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">{{ service.name }}</h6>
                    {% if forloop.counter == 1 %}
                        <span class="badge bg-success">أفضل سعر</span>
                    {% elif forloop.counter <= 3 %}
                        <span class="badge bg-info">سعر جيد</span>
                    {% else %}
                        <span class="badge bg-warning">سعر مرتفع</span>
                    {% endif %}
                </div>
                
                <div class="card-body">
                    <!-- Supplier Info -->
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                <a href="{% url 'supplier:supplier_detail' service.supplier.id %}" 
                                   class="text-decoration-none">
                                    {{ service.supplier.name }}
                                </a>
                            </h6>
                            <small class="text-muted">
                                {{ service.supplier.get_rating_stars }} • 
                                {{ service.supplier.delivery_time }} أيام تسليم
                            </small>
                        </div>
                    </div>
                    
                    <!-- Price Breakdown -->
                    <div class="price-breakdown">
                        <div class="d-flex justify-content-between mb-2">
                            <span>سعر الوحدة:</span>
                            <span class="fw-bold">{{ service.calculated_price }} ج.م</span>
                        </div>
                        
                        {% if service.calculated_price != service.base_price %}
                        <div class="d-flex justify-content-between mb-2 text-success">
                            <span>السعر الأساسي:</span>
                            <span><del>{{ service.base_price }} ج.م</del></span>
                        </div>
                        {% endif %}
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>المجموع الفرعي:</span>
                            <span>{{ service.subtotal|remove_trailing_zeros }} ج.م</span>
                        </div>
                        
                        {% if service.setup_cost > 0 %}
                        <div class="d-flex justify-content-between mb-2">
                            <span>تكلفة الإعداد:</span>
                            <span>{{ service.setup_cost|remove_trailing_zeros }} ج.م</span>
                        </div>
                        {% endif %}
                        
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <span class="fw-bold">الإجمالي:</span>
                            <span class="fw-bold text-primary fs-5">{{ service.total_cost }} ج.م</span>
                        </div>
                    </div>
                    
                    <!-- Tier Info -->
                    {% if service.applicable_tier %}
                    <div class="tier-info">
                        <small class="text-muted">
                            <i class="fas fa-layer-group"></i>
                            شريحة: {{ service.applicable_tier.tier_name }} 
                            (خصم {{ service.discount_percentage }}%)
                        </small>
                        {% if service.savings > 0 %}
                        <div class="mt-1">
                            <span class="savings-badge">
                                <i class="fas fa-piggy-bank"></i>
                                توفير {{ service.savings|remove_trailing_zeros }} ج.م
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Actions -->
                    <div class="mt-3">
                        <a href="{% url 'supplier:service_calculator' %}?service_id={{ service.id }}&quantity={{ quantity }}" 
                           class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-calculator"></i> حساب تفصيلي
                        </a>
                        <a href="{% url 'supplier:supplier_detail' service.supplier.id %}" 
                           class="btn btn-sm btn-outline-info">
                            <i class="fas fa-info-circle"></i> تفاصيل المورد
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% elif selected_category %}
    <!-- No Services Found -->
    <div class="text-center py-5">
        <i class="fas fa-search fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">لا توجد خدمات في فئة {{ selected_category.name }}</h4>
        <p class="text-muted">جرب اختيار فئة أخرى أو تغيير معايير البحث</p>
        <a href="{% url 'supplier:price_comparison' %}" class="btn btn-primary">
            <i class="fas fa-arrow-left"></i> العودة لجميع التصنيفات
        </a>
    </div>

    {% else %}
    <!-- Welcome Message -->
    <div class="text-center py-5">
        <i class="fas fa-balance-scale fa-3x text-primary mb-3"></i>
        <h4>مرحباً بك في مقارنة الأسعار</h4>
        <p class="text-muted mb-4">اختر فئة خدمة لبدء مقارنة الأسعار والعثور على أفضل العروض</p>
        
        <div class="row justify-content-center">
            {% for category in categories|slice:":6" %}
            <div class="col-md-4 col-lg-2 mb-3">
                <a href="{% url 'supplier:price_comparison' %}?category={{ category.code }}" 
                   class="btn btn-outline-primary btn-lg w-100">
                    <i class="{{ category.icon }} fa-2x d-block mb-2"></i>
                    {{ category.name }}
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>

<script>
// تحديث الكمية تلقائياً
document.getElementById('quantity').addEventListener('change', function() {
    this.form.submit();
});
</script>
{% endblock %}
