{% extends "base.html" %}
{% load i18n %}
{% load django_bootstrap5 %}
{% load static %}
{% load custom_filters %}
{% load app_tags %}

{% block title %}{{ title }} | نظام تسعير الطباعة{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<link rel="stylesheet" href="{% static 'css/tables.css' %}">
<link rel="stylesheet" href="{% static 'css/pricing_form.css' %}">
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% include "pricing/partials/pricing_form_styles.html" %}
<style>
  /* تصميم عام */
  .section-container {
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    padding: 1.5rem;
    margin-bottom: 1.8rem;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }
  
  .section-title {
    color: #344767;
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 1.2rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #eee;
  }
  
  /* تأثير التحديث للحقول */
  .updated {
    background-color: #d4edda !important;
    border-color: #c3e6cb !important;
    transition: all 0.3s ease;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- عنوان الصفحة (مضمن مباشرة) -->
  <div class="mb-4">
      <!-- Breadcrumbs -->
      {% if breadcrumb_items %}
      <div class="mb-2">
          <nav aria-label="breadcrumb">
              <ol class="breadcrumb mb-0">
                  {% for item in breadcrumb_items %}
                      {% if forloop.last or item.active %}
                          <li class="breadcrumb-item active" aria-current="page">
                              {% if item.icon %}<i class="{{ item.icon }} me-1"></i>{% endif %}
                              {{ item.title }}
                          </li>
                      {% else %}
                          <li class="breadcrumb-item">
                              <a href="{{ item.url }}">
                                  {% if item.icon %}<i class="{{ item.icon }} me-1"></i>{% endif %}
                                  {{ item.title }}
                              </a>
                          </li>
                      {% endif %}
                  {% endfor %}
              </ol>
          </nav>
      </div>
      {% endif %}
      
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center bg-white p-3 rounded shadow-sm">
          <div class="d-flex align-items-center">
              {% if page_icon %}
                  <div class="me-3">
                      <i class="{{ page_icon }} fa-2x text-primary"></i>
                  </div>
              {% endif %}
              <div>
                  <h1 class="h3 mb-1">{{ page_title|default:title|default:"إنشاء طلب تسعير جديد" }}</h1>
                  <p class="text-muted mb-0">إنشاء طلب تسعير جديد مع تفاصيل الطباعة والتشطيب</p>
              </div>
          </div>
          <div>
              <a href="{% url 'pricing:pricing_order_list' %}" class="btn btn-outline-secondary">
                  <i class="fas fa-arrow-right me-2"></i>العودة للقائمة
              </a>
          </div>
      </div>
  </div>

  {% if has_saved_data %}
  {% include "pricing/partials/saved_data_alert.html" %}
  {% endif %}

  <form method="post" id="pricing-form">
      {% csrf_token %}
      
      <!-- عنصر مخفي لتمرير بيانات أوزان الورق إلى JavaScript -->
      <div id="paper_type_weights_data" style="display: none;">{{ paper_type_weights_json|safe }}</div>
      
      <!-- عنصر مخفي لتخزين بيانات الجلسة -->
      {% if session_data %}
      <div id="session_data" style="display: none;">{{ session_data|safe }}</div>
      {% endif %}
      
      <!-- مؤشر الخطوات -->
      {% include "pricing/partials/step_indicator.html" %}

      <!-- البيانات الأساسية -->
      {% include "pricing/sections/section_1_basic_data.html" %}

      <!-- تفاصيل الغلاف -->
      {% include "pricing/sections/section_2_cover_details.html" %}

      <!-- تفاصيل المحتوى الداخلي -->
      {% include "pricing/sections/section_3_internal_content.html" %}

      <!-- التسعير والحسابات -->
      {% include "pricing/sections/section_4_pricing.html" %}
  </form>

  <!-- زر طباعة PDF -->
  {% if form.instance.id %}
  <div class="section-container">
      <div class="d-flex justify-content-end">
          <a href="{% url 'pricing:pricing_pdf' form.instance.id %}" class="btn btn-secondary" target="_blank">
              <i class="fas fa-file-pdf me-2"></i> طباعة PDF
          </a>
      </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- Select2 JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- تحميل ملفات JavaScript المقسمة -->
<script src="{% static 'js/pricing/core.js' %}"></script>
<script src="{% static 'js/pricing/api-services.js' %}"></script>
<script src="{% static 'js/pricing/event-bus.js' %}"></script>
<script src="{% static 'js/pricing/paper-handlers.js' %}"></script>
<script src="{% static 'js/pricing/print-handlers.js' %}"></script>
<script src="{% static 'js/pricing/press-handlers.js' %}"></script>
<script src="{% static 'js/pricing/press-fix.js' %}"></script>
<script src="{% static 'js/pricing/supplier-filter.js' %}"></script>
<script src="{% static 'js/pricing/montage-handlers.js' %}"></script>
<script src="{% static 'js/pricing/ctp-handlers.js' %}"></script>
<script src="{% static 'js/pricing/finishing-handlers.js' %}"></script>
<script src="{% static 'js/pricing/pricing-calculator.js' %}"></script>
<script src="{% static 'js/pricing/session-handlers.js' %}"></script>
<script src="{% static 'js/pricing/ui-handlers.js' %}"></script>
<script src="{% static 'js/pricing/pricing-integration.js' %}"></script>
<script src="{% static 'js/pricing/main.js' %}"></script>

<!-- تفعيل Select2 -->
<script>
$(document).ready(function() {
    // تفعيل Select2 لحقل العميل
    $('#id_client').select2({
        theme: 'bootstrap-5',
        placeholder: 'اختر العميل...',
        allowClear: true,
        dir: 'rtl',
        width: '100%',
        dropdownParent: $('#id_client').parent(),
        language: {
            noResults: function() {
                return "لا توجد نتائج";
            },
            searching: function() {
                return "جاري البحث...";
            },
            loadingMore: function() {
                return "جاري تحميل المزيد...";
            },
            inputTooShort: function() {
                return "أدخل حرف واحد على الأقل للبحث";
            },
            errorLoading: function() {
                return "لا يمكن تحميل النتائج";
            }
        },
        // تحسين الأداء للقوائم الكبيرة
        minimumInputLength: 0,
        // إضافة بحث مخصص
        matcher: function(params, data) {
            // إذا لم يكن هناك نص بحث، أظهر جميع الخيارات
            if ($.trim(params.term) === '') {
                return data;
            }
            
            // البحث في النص العربي والإنجليزي
            var term = params.term.toLowerCase();
            var text = data.text.toLowerCase();
            
            if (text.indexOf(term) > -1) {
                return data;
            }
            
            // لا توجد مطابقة
            return null;
        }
    });
    
    // إضافة تأثير بصري عند التركيز
    $('#id_client').on('select2:open', function() {
        $('.select2-search__field').attr('placeholder', 'ابحث عن العميل...');
    });
    
    // معالجة التغيير في الاختيار
    $('#id_client').on('select2:select', function(e) {
        var selectedData = e.params.data;
        console.log('تم اختيار العميل:', selectedData.text);
        
        // يمكن إضافة منطق إضافي هنا عند اختيار العميل
        // مثل تحديث معلومات العميل أو تحديث الأسعار
    });
    
    // معالجة إزالة الاختيار
    $('#id_client').on('select2:clear', function() {
        console.log('تم إزالة اختيار العميل');
    });
    
    // تحديث قائمة موردي الورق عند تغيير نوع الورق
    $('#id_paper_type').on('change', function() {
        updatePaperSuppliers();
    });
    
    // تحديث مقاسات الورق عند تغيير المورد
    $('#id_paper_supplier').on('change', function() {
        updatePaperSheetSizes();
    });
    
    // تحديث جرامات الورق عند تغيير المقاس
    $('#id_paper_sheet_type').on('change', function() {
        updatePaperWeights();
    });
    
    // تحديث منشأ الورق عند تغيير الوزن
    $('#id_paper_weight').on('change', function() {
        updatePaperOrigins();
    });
    
    // تحديث سعر الورق عند تغيير المنشأ
    $('#id_paper_origin').on('change', function() {
        updatePaperPrice();
    });
    
    // حساب إجمالي تكلفة الورق عند تغيير السعر أو العدد
    $('#id_paper_price, #id_paper_sheets_count').on('input change', function() {
        calculatePaperTotalCost();
    });
    
    // حساب إجمالي خدمات ما بعد الطباعة عند تغيير أي خدمة
    $('#coating_total, #folding_total, #die_cut_total, #spot_uv_total').on('input change', function() {
        calculateFinishingTotalCost();
    });
    
    // مراقبة تفعيل/إلغاء تفعيل خدمات ما بعد الطباعة
    $('.finishing-service-checkbox').on('change', function() {
        setTimeout(function() {
            calculateFinishingTotalCost();
        }, 100); // تأخير بسيط للتأكد من تحديث القيم
    });
    
    // حساب إجمالي كل خدمة عند تغيير السعر أو الكمية
    $(document).on('input change', '#coating_price, #folding_price, #folding_count, #die_cut_price, #spot_uv_price', function() {
        calculateIndividualServiceTotals();
        setTimeout(function() {
            calculateFinishingTotalCost();
        }, 50);
    });
    
});

/**
 * تحديث قائمة موردي الورق بناءً على نوع الورق المختار
 */
function updatePaperSuppliers() {
    const paperTypeId = $('#id_paper_type').val();
    const paperSupplierSelect = $('#id_paper_supplier');
    
    
    if (!paperTypeId) {
        // إذا لم يتم اختيار نوع ورق، أعرض جميع الموردين النشطين
        resetPaperSuppliers();
        return;
    }
    
    // عرض مؤشر التحميل
    paperSupplierSelect.html('<option value="">جاري التحميل...</option>');
    paperSupplierSelect.prop('disabled', true);
    
    // استدعاء API لجلب الموردين المناسبين
    $.ajax({
        url: '/pricing/api/paper-suppliers/',
        method: 'GET',
        data: {
            paper_type_id: paperTypeId
        },
        success: function(response) {
            if (response.success) {
                // مسح القائمة الحالية
                paperSupplierSelect.html('<option value="">-- اختر مورد الورق --</option>');
                
                // إضافة الموردين الجدد
                if (response.suppliers && response.suppliers.length > 0) {
                    $.each(response.suppliers, function(index, supplier) {
                        paperSupplierSelect.append(
                            '<option value="' + supplier.id + '">' + supplier.name + '</option>'
                        );
                    });
                    
                    // اختيار أول مورد تلقائياً
                    paperSupplierSelect.val(response.suppliers[0].id);
                    
                    // إضافة تأثير بصري للإشارة للتحديث
                    paperSupplierSelect.addClass('updated');
                    setTimeout(function() {
                        paperSupplierSelect.removeClass('updated');
                    }, 2000);
                    
                    // تحديث مقاسات الورق بعد اختيار المورد تلقائياً
                    updatePaperSheetSizes();
                } else {
                    paperSupplierSelect.append('<option value="">لا توجد موردين متاحين لهذا النوع</option>');
                }
            } else {
                console.error('خطأ في جلب موردي الورق:', response.error);
                paperSupplierSelect.html('<option value="">خطأ في التحميل</option>');
            }
        },
        error: function(xhr, status, error) {
            console.error('خطأ في الاتصال:', error);
            paperSupplierSelect.html('<option value="">خطأ في الاتصال</option>');
            // التأكد من إعادة تفعيل الحقل في حالة الخطأ
            paperSupplierSelect.prop('disabled', false);
        },
        complete: function() {
            // إعادة تفعيل القائمة دائماً
            paperSupplierSelect.prop('disabled', false);
        }
    });
}

/**
 * إعادة تعيين قائمة موردي الورق لعرض جميع الموردين النشطين
 */
function resetPaperSuppliers() {
    const paperSupplierSelect = $('#id_paper_supplier');
    
    // استدعاء API لجلب جميع موردي الورق النشطين
    $.ajax({
        url: '/pricing/api/paper-suppliers/',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                paperSupplierSelect.html('<option value="">-- اختر مورد الورق --</option>');
                
                if (response.suppliers && response.suppliers.length > 0) {
                    $.each(response.suppliers, function(index, supplier) {
                        paperSupplierSelect.append(
                            '<option value="' + supplier.id + '">' + supplier.name + '</option>'
                        );
                    });
                }
            }
        },
        error: function(xhr, status, error) {
            console.error('خطأ في إعادة تحميل موردي الورق:', error);
        }
    });
}

/**
 * تحديث مقاسات الورق بناءً على نوع الورق والمورد المختارين
 */
function updatePaperSheetSizes() {
    const paperTypeId = $('#id_paper_type').val();
    const paperSupplierId = $('#id_paper_supplier').val();
    const paperSheetSizeSelect = $('#id_paper_sheet_type');
    
    
    if (!paperTypeId || !paperSupplierId) {
        // إذا لم يتم اختيار نوع الورق أو المورد، أفرغ قائمة المقاسات
        paperSheetSizeSelect.html('<option value="">-- اختر مقاس الورق --</option>');
        return;
    }
    
    // عرض مؤشر التحميل
    paperSheetSizeSelect.html('<option value="">جاري التحميل...</option>');
    paperSheetSizeSelect.prop('disabled', true);
    
    // استدعاء API لجلب المقاسات المناسبة
    $.ajax({
        url: '/supplier/api/paper-sheet-sizes/',
        method: 'GET',
        data: {
            paper_type_id: paperTypeId,
            paper_supplier_id: paperSupplierId
        },
        success: function(response) {
            
            if (response.success) {
                // مسح القائمة الحالية
                paperSheetSizeSelect.html('<option value="">-- اختر مقاس الورق --</option>');
                
                // إضافة المقاسات الجديدة
                if (response.sizes && response.sizes.length > 0) {
                    $.each(response.sizes, function(index, size) {
                        paperSheetSizeSelect.append(
                            '<option value="' + size.id + '">' + size.name + '</option>'
                        );
                    });
                    
                    // اختيار أول مقاس تلقائياً
                    paperSheetSizeSelect.val(response.sizes[0].id);
                    
                    // إضافة تأثير بصري للإشارة للتحديث
                    paperSheetSizeSelect.addClass('updated');
                    setTimeout(function() {
                        paperSheetSizeSelect.removeClass('updated');
                    }, 2000);
                    
                    
                    // تحديث جرامات الورق بعد اختيار المقاس تلقائياً
                    updatePaperWeights();
                } else {
                    paperSheetSizeSelect.append('<option value="">لا توجد مقاسات متاحة لهذا المورد ونوع الورق</option>');
                }
            } else {
                console.error('خطأ في جلب مقاسات الورق:', response.error);
                paperSheetSizeSelect.html('<option value="">خطأ في التحميل</option>');
            }
        },
        error: function(xhr, status, error) {
            console.error('خطأ في الاتصال بـ API مقاسات الورق:', error);
            paperSheetSizeSelect.html('<option value="">خطأ في الاتصال</option>');
        },
        complete: function() {
            // إعادة تفعيل القائمة دائماً
            paperSheetSizeSelect.prop('disabled', false);
        }
    });
}

/**
 * تحديث جرامات الورق بناءً على نوع الورق والمورد والمقاس المختارين
 */
function updatePaperWeights() {
    const paperTypeId = $('#id_paper_type').val();
    const paperSupplierId = $('#id_paper_supplier').val();
    const paperSheetSize = $('#id_paper_sheet_type').val();
    const paperWeightSelect = $('#id_paper_weight');
    
    
    if (!paperTypeId || !paperSupplierId || !paperSheetSize) {
        // إذا لم يتم اختيار نوع الورق أو المورد أو المقاس، أفرغ قائمة الجرامات
        paperWeightSelect.html('<option value="">-- اختر وزن الورق --</option>');
        return;
    }
    
    // عرض مؤشر التحميل
    paperWeightSelect.html('<option value="">جاري التحميل...</option>');
    paperWeightSelect.prop('disabled', true);
    
    // استدعاء API لجلب الجرامات المناسبة
    $.ajax({
        url: '/supplier/api/paper-weights/',
        method: 'GET',
        data: {
            paper_type_id: paperTypeId,
            paper_supplier_id: paperSupplierId,
            paper_sheet_size: paperSheetSize
        },
        success: function(response) {
            
            if (response.success) {
                // مسح القائمة الحالية
                paperWeightSelect.html('<option value="">-- اختر وزن الورق --</option>');
                
                // إضافة الجرامات الجديدة
                if (response.weights && response.weights.length > 0) {
                    $.each(response.weights, function(index, weight) {
                        paperWeightSelect.append(
                            '<option value="' + weight.id + '">' + weight.name + '</option>'
                        );
                    });
                    
                    // اختيار أول جرام تلقائياً
                    paperWeightSelect.val(response.weights[0].id);
                    
                    // إضافة تأثير بصري للإشارة للتحديث
                    paperWeightSelect.addClass('updated');
                    setTimeout(function() {
                        paperWeightSelect.removeClass('updated');
                    }, 2000);
                    
                    
                    // تحديث منشأ الورق بعد اختيار الجرام تلقائياً
                    updatePaperOrigins();
                } else {
                    paperWeightSelect.append('<option value="">لا توجد جرامات متاحة لهذا المورد ونوع الورق والمقاس</option>');
                }
            } else {
                console.error('خطأ في جلب جرامات الورق:', response.error);
                paperWeightSelect.html('<option value="">خطأ في التحميل</option>');
            }
        },
        error: function(xhr, status, error) {
            console.error('خطأ في الاتصال بـ API جرامات الورق:', error);
            paperWeightSelect.html('<option value="">خطأ في الاتصال</option>');
        },
        complete: function() {
            // إعادة تفعيل القائمة دائماً
            paperWeightSelect.prop('disabled', false);
        }
    });
}

/**
 * تحديث منشأ الورق بناءً على نوع الورق والمورد والمقاس والوزن المختارين
 */
function updatePaperOrigins() {
    const paperTypeId = $('#id_paper_type').val();
    const paperSupplierId = $('#id_paper_supplier').val();
    const paperSheetSize = $('#id_paper_sheet_type').val();
    const paperWeight = $('#id_paper_weight').val();
    const paperOriginSelect = $('#id_paper_origin');
    
    
    if (!paperTypeId || !paperSupplierId || !paperSheetSize || !paperWeight) {
        // إذا لم يتم اختيار جميع المتطلبات، أفرغ قائمة منشأ الورق
        paperOriginSelect.html('<option value="">-- اختر منشأ الورق --</option>');
        return;
    }
    
    // عرض مؤشر التحميل
    paperOriginSelect.html('<option value="">جاري التحميل...</option>');
    paperOriginSelect.prop('disabled', true);
    
    // استدعاء API لجلب منشأ الورق المناسب
    $.ajax({
        url: '/supplier/api/paper-origins/',
        method: 'GET',
        data: {
            paper_type_id: paperTypeId,
            paper_supplier_id: paperSupplierId,
            paper_sheet_size: paperSheetSize,
            paper_weight: paperWeight
        },
        success: function(response) {
            
            if (response.success) {
                // مسح القائمة الحالية
                paperOriginSelect.html('<option value="">-- اختر منشأ الورق --</option>');
                
                // إضافة منشأ الورق الجديد
                if (response.origins && response.origins.length > 0) {
                    $.each(response.origins, function(index, origin) {
                        paperOriginSelect.append(
                            '<option value="' + origin.id + '">' + origin.name + '</option>'
                        );
                    });
                    
                    // اختيار أول منشأ تلقائياً
                    paperOriginSelect.val(response.origins[0].id);
                    
                    // إضافة تأثير بصري للإشارة للتحديث
                    paperOriginSelect.addClass('updated');
                    setTimeout(function() {
                        paperOriginSelect.removeClass('updated');
                    }, 2000);
                    
                    
                    // تحديث سعر الورق بعد اختيار المنشأ تلقائياً
                    updatePaperPrice();
                } else {
                    paperOriginSelect.append('<option value="">لا توجد منشأ متاحة لهذه المواصفات</option>');
                }
            } else {
                console.error('خطأ في جلب منشأ الورق:', response.error);
                paperOriginSelect.html('<option value="">خطأ في التحميل</option>');
            }
        },
        error: function(xhr, status, error) {
            console.error('خطأ في الاتصال بـ API منشأ الورق:', error);
            paperOriginSelect.html('<option value="">خطأ في الاتصال</option>');
        },
        complete: function() {
            // إعادة تفعيل القائمة دائماً
            paperOriginSelect.prop('disabled', false);
        }
    });
}

/**
 * تحديث سعر الورق بناءً على جميع المواصفات المختارة
 */
function updatePaperPrice() {
    const paperTypeId = $('#id_paper_type').val();
    const paperSupplierId = $('#id_paper_supplier').val();
    const paperSheetSize = $('#id_paper_sheet_type').val();
    const paperWeight = $('#id_paper_weight').val();
    const paperOrigin = $('#id_paper_origin').val();
    const paperPriceInput = $('#id_paper_price');
    const paperPriceInfo = $('#paper-price-info');
    
    if (!paperTypeId || !paperSupplierId || !paperSheetSize || !paperWeight || !paperOrigin) {
        // إذا لم يتم اختيار جميع المتطلبات، امسح السعر والمعلومات
        paperPriceInput.val('');
        paperPriceInfo.html('');
        return;
    }
    
    // عرض مؤشر التحميل
    paperPriceInfo.html('<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> جاري تحميل السعر...</div>');
    
    // استدعاء API لجلب السعر
    $.ajax({
        url: '/supplier/api/paper-price/',
        method: 'GET',
        data: {
            paper_type_id: paperTypeId,
            paper_supplier_id: paperSupplierId,
            paper_sheet_size: paperSheetSize,
            paper_weight: paperWeight,
            paper_origin: paperOrigin
        },
        success: function(response) {
            
            if (response.success) {
                // تحديث حقل السعر
                paperPriceInput.val(response.price_info.price_per_sheet);
                
                // إضافة تأثير بصري للحقل
                paperPriceInput.addClass('updated');
                setTimeout(function() {
                    paperPriceInput.removeClass('updated');
                }, 2000);
                
                // عرض معلومات السعر
                const priceInfoHtml = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-tag"></i> معلومات السعر</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>السعر:</strong> ${response.formatted_price}<br>
                                <strong>المورد:</strong> ${response.price_info.supplier_name}<br>
                                <strong>النوع:</strong> ${response.price_info.paper_type}
                            </div>
                            <div class="col-md-6">
                                <strong>المقاس:</strong> ${response.price_info.sheet_size}<br>
                                <strong>الوزن:</strong> ${response.price_info.weight}<br>
                                <strong>المنشأ:</strong> ${response.price_info.origin}
                            </div>
                        </div>
                        ${response.price_info.brand !== 'غير محدد' ? '<small><strong>الماركة:</strong> ' + response.price_info.brand + '</small>' : ''}
                    </div>
                `;
                paperPriceInfo.html(priceInfoHtml);
                
                
                // حساب إجمالي تكلفة الورق بعد تحديث السعر
                calculatePaperTotalCost();
            } else {
                // عرض رسالة عدم توفر السعر
                paperPriceInput.val('');
                const errorHtml = `
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle"></i> السعر غير متوفر</h6>
                        <p>${response.error}</p>
                        ${response.suggestion ? '<small class="text-muted">' + response.suggestion + '</small>' : ''}
                        ${response.debug_info ? '<details class="mt-2"><summary>معلومات التشخيص</summary><pre>' + JSON.stringify(response.debug_info, null, 2) + '</pre></details>' : ''}
                    </div>
                `;
                paperPriceInfo.html(errorHtml);
                if (response.debug_info) {
                }
            }
        },
        error: function(xhr, status, error) {
            console.error('خطأ في الاتصال بـ API سعر الورق:', error);
            paperPriceInput.val('');
            paperPriceInfo.html(`
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-circle"></i> خطأ في التحميل</h6>
                    <p>حدث خطأ في الاتصال بالخادم</p>
                </div>
            `);
        },
        complete: function() {
        }
    });
}

/**
 * حساب إجمالي كل خدمة على حدة
 */
function calculateIndividualServiceTotals() {
    // حساب إجمالي التغطية (السعر فقط)
    const coatingPrice = parseFloat($('#coating_price').val()) || 0;
    $('#coating_total').val(coatingPrice.toFixed(2));
    
    // حساب إجمالي الطي (السعر × العدد)
    const foldingPrice = parseFloat($('#folding_price').val()) || 0;
    const foldingCount = parseInt($('#folding_count').val()) || 1;
    const foldingTotal = foldingPrice * foldingCount;
    $('#folding_total').val(foldingTotal.toFixed(2));
    
    // حساب إجمالي القص (السعر فقط)
    const dieCutPrice = parseFloat($('#die_cut_price').val()) || 0;
    $('#die_cut_total').val(dieCutPrice.toFixed(2));
    
    // حساب إجمالي UV (السعر فقط)
    const spotUvPrice = parseFloat($('#spot_uv_price').val()) || 0;
    $('#spot_uv_total').val(spotUvPrice.toFixed(2));
    
}

/**
 * حساب إجمالي خدمات ما بعد الطباعة
 */
function calculateFinishingTotalCost() {
    let totalCost = 0;
        
    // خدمة التغطية
    const coatingCheckbox = $('#coating_service_checkbox');
    const coatingTotal = $('#coating_total');
    if (coatingCheckbox.is(':checked') && coatingTotal.length > 0) {
        const coatingValue = parseFloat(coatingTotal.val()) || 0;
        totalCost += coatingValue;
    }
    
    // خدمة الطي
    const foldingCheckbox = $('#folding_service');
    const foldingTotal = $('#folding_total');
    if (foldingCheckbox.is(':checked') && foldingTotal.length > 0) {
        const foldingValue = parseFloat(foldingTotal.val()) || 0;
        totalCost += foldingValue;
    }
    
    // خدمة القص
    const dieCutCheckbox = $('#die_cut_service');
    const dieCutTotal = $('#die_cut_total');
    if (dieCutCheckbox.is(':checked') && dieCutTotal.length > 0) {
        const dieCutValue = parseFloat(dieCutTotal.val()) || 0;
        totalCost += dieCutValue;
    }
    
    // خدمة UV
    const spotUvCheckbox = $('#spot_uv_service');
    const spotUvTotal = $('#spot_uv_total');
    if (spotUvCheckbox.is(':checked') && spotUvTotal.length > 0) {
        const spotUvValue = parseFloat(spotUvTotal.val()) || 0;
        totalCost += spotUvValue;
    }
    
    // تحديث حقل الإجمالي
    const totalFinishingCostField = $('#total_finishing_cost');
    totalFinishingCostField.val(totalCost.toFixed(2));
    
    // إضافة تأثير بصري
    if (totalCost > 0) {
        totalFinishingCostField.addClass('updated');
        setTimeout(function() {
            totalFinishingCostField.removeClass('updated');
        }, 2000);
    }
    
    return totalCost;
}

/**
 * حساب إجمالي تكلفة الورق (السعر × العدد)
 */
function calculatePaperTotalCost() {
    const paperPrice = parseFloat($('#id_paper_price').val()) || 0;
    const paperSheetsCount = parseInt($('#id_paper_sheets_count').val()) || 0;
    const paperTotalCostInput = $('#id_paper_total_cost');
    
    if (paperPrice > 0 && paperSheetsCount > 0) {
        const totalCost = paperPrice * paperSheetsCount;
        paperTotalCostInput.val(totalCost.toFixed(2));
        
        // إضافة تأثير بصري للحقل
        paperTotalCostInput.addClass('updated');
        setTimeout(function() {
            paperTotalCostInput.removeClass('updated');
        }, 2000);
        
        console.log('تم حساب إجمالي التكلفة:', totalCost.toFixed(2));
    } else {
        paperTotalCostInput.val('');
        console.log('لا يمكن حساب التكلفة - بيانات ناقصة');
    }
}

</script>

<!-- إضافة عناصر واجهة للتكامل الجديد -->
<div id="loading-indicator" style="display: none;" class="text-center">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">جاري التحميل...</span>
    </div>
</div>

<div id="paper-price-info" class="mt-2"></div>

<button type="button" id="calculate-cost-btn" class="btn btn-primary mt-3">
    <i class="fas fa-calculator"></i> احسب التكلفة
</button>

<style>
.updated {
    background-color: #d4edda !important;
    border-color: #c3e6cb !important;
    transition: all 0.3s ease;
}

#loading-indicator {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9999;
    background: rgba(255, 255, 255, 0.9);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}
</style>
{% endblock %}
