{% extends "base.html" %}
{% load i18n %}
{% load django_bootstrap5 %}
{% load static %}
{% load custom_filters %}
{% load app_tags %}

{% block title %}{% trans "قائمة عروض الأسعار" %} | نظام تسعير الطباعة{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<link rel="stylesheet" href="{% static 'css/tables.css' %}">
<style>
  /* تصميم عام */
  .section-container {
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    padding: 1.5rem;
    margin-bottom: 1.8rem;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }
  
  .section-title {
    color: #344767;
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 1.2rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #eee;
  }

  /* تصميم كروت الإحصائيات */
  .stat-card {
    transition: all 0.3s ease;
    height: 100%;
  }
  
  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- عنوان الصفحة (مضمن مباشرة) -->
  <div class="mb-4">
      <!-- Breadcrumbs -->
      {% if breadcrumb_items %}
      <div class="mb-2">
          <nav aria-label="breadcrumb">
              <ol class="breadcrumb mb-0">
                  {% for item in breadcrumb_items %}
                      {% if forloop.last or item.active %}
                          <li class="breadcrumb-item active" aria-current="page">
                              {% if item.icon %}<i class="{{ item.icon }} me-1"></i>{% endif %}
                              {{ item.title }}
                          </li>
                      {% else %}
                          <li class="breadcrumb-item">
                              <a href="{{ item.url }}">
                                  {% if item.icon %}<i class="{{ item.icon }} me-1"></i>{% endif %}
                                  {{ item.title }}
                              </a>
                          </li>
                      {% endif %}
                  {% endfor %}
              </ol>
          </nav>
      </div>
      {% endif %}
      
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center bg-white p-3 rounded shadow-sm">
          <div class="d-flex align-items-center">
              {% if page_icon %}
                  <div class="me-3">
                      <i class="{{ page_icon }} fa-2x text-primary"></i>
                  </div>
              {% endif %}
              <div>
                  <h1 class="h3 mb-1">{{ page_title|default:"قائمة عروض الأسعار" }}</h1>
                  <p class="text-muted mb-0">عرض جميع عروض الأسعار المعتمدة والمنفذة</p>
              </div>
          </div>
          <div>
              <a href="{% url 'pricing:pricing_add' %}" class="btn btn-primary">
                  <i class="fas fa-plus me-2"></i>{% trans "إنشاء عرض سعر جديد" %}
              </a>
          </div>
      </div>
  </div>

  <!-- الإحصائيات -->
  {% if quotations %}
  <div class="section-container">
    <h5 class="section-title"><i class="fas fa-chart-bar me-2"></i>{% trans "الإحصائيات العامة" %}</h5>
    <div class="row">
      <div class="col-md-6 col-lg-3 mb-4">
        <div class="stat-card">
          <div class="card bg-primary text-white">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title">إجمالي العروض</h6>
                  <h4>{{ quotations.count }}</h4>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-file-invoice-dollar fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3 mb-4">
        <div class="stat-card">
          <div class="card bg-success text-white">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title">العروض المعتمدة</h6>
                  <h4>{{ quotations|length }}</h4>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-check-circle fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3 mb-4">
        <div class="stat-card">
          <div class="card bg-info text-white">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title">القيمة الإجمالية</h6>
                  <h4>
                    {% if quotations %}
                      {{ quotations.count|default:0 }} عرض
                    {% else %}
                      0 ج.م
                    {% endif %}
                  </h4>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-dollar-sign fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3 mb-4">
        <div class="stat-card">
          <div class="card bg-warning text-white">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h6 class="card-title">هذا الشهر</h6>
                  <h4>{{ quotations.count }}</h4>
                </div>
                <div class="align-self-center">
                  <i class="fas fa-calendar-alt fa-2x"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- تصفية وبحث -->
  <div class="section-container">
    <h5 class="section-title"><i class="fas fa-filter me-2"></i>{% trans "فلترة وبحث" %}</h5>
    <form method="get" class="row g-3">
        <div class="col-md-4">
            <label for="search" class="form-label">{% trans "البحث" %}</label>
            <input type="text" class="form-control" id="search" name="search" 
                   placeholder="البحث في العنوان أو رقم العرض..." 
                   value="{{ request.GET.search|default:'' }}">
        </div>
        <div class="col-md-3">
            <label for="client" class="form-label">{% trans "العميل" %}</label>
            <select name="client" id="client" class="form-select">
                <option value="">{% trans "جميع العملاء" %}</option>
                {% regroup quotations by client as client_list %}
                {% for client_group in client_list %}
                    {% if client_group.grouper %}
                        <option value="{{ client_group.grouper.id }}" 
                                {% if request.GET.client == client_group.grouper.id|stringformat:"i" %}selected{% endif %}>
                            {{ client_group.grouper.name }}
                        </option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label for="date_from" class="form-label">{% trans "من تاريخ" %}</label>
            <input type="date" class="form-control" id="date_from" name="date_from" 
                   value="{{ request.GET.date_from|default:'' }}">
        </div>
        <div class="col-md-2">
            <label for="date_to" class="form-label">{% trans "إلى تاريخ" %}</label>
            <input type="date" class="form-control" id="date_to" name="date_to" 
                   value="{{ request.GET.date_to|default:'' }}">
        </div>
        <div class="col-md-1 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-search me-1"></i>بحث
            </button>
        </div>
    </form>
  </div>

  <!-- قائمة عروض الأسعار -->
  <div class="section-container">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
          <i class="fas fa-list me-2"></i>{% trans "عروض الأسعار" %}
          <span class="badge bg-primary ms-2">{{ quotations.count }}</span>
        </h5>
        <div class="actions-container">
          <a href="{% url 'pricing:pricing_add' %}" class="btn btn-sm btn-primary">
            <i class="fas fa-plus me-1"></i>{% trans "إنشاء عرض" %}
          </a>
        </div>
      </div>
      <div class="card-body">
        {% with table_id=table_id %}
          {% with headers=headers %}
            {% with data=data %}
              {% with empty_message="لا توجد عروض أسعار معتمدة أو منفذة" %}
                {% with table_class="hover" %}
                  {% with action_buttons=action_buttons %}
                    {% with primary_key=primary_key %}
                      {% with clickable_rows=clickable_rows row_click_url=row_click_url %}
                        {% with show_currency=show_currency currency_symbol=currency_symbol %}
                          {% with show_search=True show_length_menu=True length_options="10,25,50,100" sortable=False %}
                            {% include "components/data_table.html" %}
                          {% endwith %}
                        {% endwith %}
                      {% endwith %}
                    {% endwith %}
                  {% endwith %}
                {% endwith %}
              {% endwith %}
            {% endwith %}
          {% endwith %}
        {% endwith %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="{% static 'js/global-table.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // تهيئة الجدول الموحد
    initializeTable('{{ table_id }}', {
        "order": [[7, 'desc']], // ترتيب حسب تاريخ الإنشاء
        "columnDefs": [
            { "className": "text-center", "targets": [0, 4, 7] }, // رقم العرض، الكمية، تاريخ الإنشاء
            { "className": "text-end", "targets": [5] } // سعر البيع
        ]
    });
    
    // تفعيل tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
