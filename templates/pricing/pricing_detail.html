{% extends "base.html" %}
{% load i18n %}
{% load django_bootstrap5 %}

{% block title %}{% trans "تفاصيل طلب التسعير" %} | {{ order.order_number }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2>{% trans "طلب تسعير" %}: {{ order.order_number }}</h2>
    </div>
    <div class="col-auto">
        <div class="btn-group" role="group">
            {% if user.is_admin or user.is_supervisor or user == order.created_by %}
            <a href="{% url 'pricing:pricing_edit' order.pk %}" class="btn btn-warning">
                <i class="fas fa-edit"></i> {% trans "تعديل" %}
            </a>
            {% endif %}
            
            {% if not order.is_approved and user.is_admin or user.is_supervisor %}
            <a href="{% url 'pricing:pricing_approve' order.pk %}" class="btn btn-success">
                <i class="fas fa-check"></i> {% trans "اعتماد" %}
            </a>
            {% endif %}
            
            {% if order.is_approved and not order.is_executed %}
            <form method="post" action="{% url 'pricing:pricing_execute' order.pk %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-check-double"></i> {% trans "تنفيذ" %}
                </button>
            </form>
            {% endif %}
            
            <a href="{% url 'pricing:pricing_pdf' order.pk %}" class="btn btn-secondary" target="_blank">
                <i class="fas fa-file-pdf"></i> {% trans "تصدير PDF" %}
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- معلومات الطلب الأساسية -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">{% trans "معلومات الطلب" %}</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>{% trans "العميل" %}:</strong> {{ order.client.name }}</p>
                        <p><strong>{% trans "العنوان" %}:</strong> {{ order.title }}</p>
                        <p><strong>{% trans "الكمية" %}:</strong> {{ order.quantity }}</p>
                        <p><strong>{% trans "نوع الطلب" %}:</strong> {{ order.get_order_type_display }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>{% trans "الحالة" %}:</strong> 
                            <span class="badge {% if order.status == 'approved' %}bg-success{% elif order.status == 'executed' %}bg-primary{% elif order.status == 'rejected' %}bg-danger{% else %}bg-secondary{% endif %}">
                                {{ order.get_status_display }}
                            </span>
                        </p>
                        <p><strong>{% trans "تاريخ الإنشاء" %}:</strong> {{ order.created_at|date:"Y-m-d H:i" }}</p>
                        <p><strong>{% trans "تم الإنشاء بواسطة" %}:</strong> {{ order.created_by.get_full_name }}</p>
                        {% if order.approved_by %}
                        <p><strong>{% trans "تم الاعتماد بواسطة" %}:</strong> {{ order.approved_by.get_full_name }}</p>
                        <p><strong>{% trans "تاريخ الاعتماد" %}:</strong> {{ order.approved_at|date:"Y-m-d H:i" }}</p>
                        {% endif %}
                    </div>
                </div>
                
                {% if order.description %}
                <div class="row mb-3">
                    <div class="col-12">
                        <p><strong>{% trans "الوصف" %}:</strong></p>
                        <p>{{ order.description }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- معلومات الطباعة -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">{% trans "معلومات الطباعة" %}</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>{% trans "نوع الورق" %}:</strong> {{ order.paper_type.name }}</p>
                        <p><strong>{% trans "حجم الورق" %}:</strong> {{ order.paper_size.name }}</p>
                        <p><strong>{% trans "اتجاه الطباعة" %}:</strong> {{ order.print_direction.name }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>{% trans "جوانب الطباعة" %}:</strong> {{ order.print_sides.name }}</p>
                        <p><strong>{% trans "عدد ألوان الوجه الأمامي" %}:</strong> {{ order.colors_front }}</p>
                        <p><strong>{% trans "عدد ألوان الوجه الخلفي" %}:</strong> {{ order.colors_back }}</p>
                    </div>
                </div>
                
                {% if order.coating_type %}
                <div class="row mb-3">
                    <div class="col-12">
                        <p><strong>{% trans "نوع التغطية" %}:</strong> {{ order.coating_type.name }}</p>
                    </div>
                </div>
                {% endif %}
                
                {% if order.supplier %}
                <div class="row mb-3">
                    <div class="col-12">
                        <p><strong>{% trans "المورد" %}:</strong> {{ order.supplier.name }}</p>
                        {% if order.press %}
                        <p><strong>{% trans "نوع الماكينة" %}:</strong> {{ order.press }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- المحتوى الداخلي -->
        {% if order.has_internal_content %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{% trans "المحتوى الداخلي" %}</h5>
                {% if not internal_content %}
                <a href="{% url 'internal_content_add' order.pk %}" class="btn btn-sm btn-light">
                    <i class="fas fa-plus"></i> {% trans "إضافة محتوى داخلي" %}
                </a>
                {% else %}
                <a href="{% url 'internal_content_edit' internal_content.pk %}" class="btn btn-sm btn-light">
                    <i class="fas fa-edit"></i> {% trans "تعديل المحتوى الداخلي" %}
                </a>
                {% endif %}
            </div>
            {% if internal_content %}
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>{% trans "نوع الورق" %}:</strong> {{ internal_content.paper_type.name }}</p>
                        <p><strong>{% trans "حجم الورق" %}:</strong> {{ internal_content.paper_size.name }}</p>
                        <p><strong>{% trans "عدد الصفحات" %}:</strong> {{ internal_content.page_count }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>{% trans "جوانب الطباعة" %}:</strong> {{ internal_content.print_sides.name }}</p>
                        <p><strong>{% trans "عدد ألوان الوجه الأمامي" %}:</strong> {{ internal_content.colors_front }}</p>
                        <p><strong>{% trans "عدد ألوان الوجه الخلفي" %}:</strong> {{ internal_content.colors_back }}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>{% trans "تكلفة الخامات" %}:</strong> {{ internal_content.material_cost }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>{% trans "تكلفة الطباعة" %}:</strong> {{ internal_content.printing_cost }}</p>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card-body">
                <p class="text-center">{% trans "لم يتم إضافة معلومات المحتوى الداخلي بعد" %}</p>
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        <!-- خدمات مابعد الطباعة -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{% trans "خدمات مابعد الطباعة" %}</h5>
                <a href="{% url 'order_finishing_add' order.pk %}" class="btn btn-sm btn-dark">
                    <i class="fas fa-plus"></i> {% trans "إضافة خدمات مابعد الطباعة" %}
                </a>
            </div>
            <div class="card-body">
                {% if finishing_services %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>{% trans "نوع خدمات مابعد الطباعة" %}</th>
                                <th>{% trans "الكمية" %}</th>
                                <th>{% trans "سعر الوحدة" %}</th>
                                <th>{% trans "السعر الإجمالي" %}</th>
                                <th>{% trans "الإجراءات" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for service in finishing_services %}
                            <tr>
                                <td>{{ service.finishing_type.name }}</td>
                                <td>{{ service.quantity }}</td>
                                <td>{{ service.unit_price }}</td>
                                <td>{{ service.total_price }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{% url 'order_finishing_edit' service.pk %}" class="btn btn-warning" title="{% trans 'تعديل' %}">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'order_finishing_delete' service.pk %}" class="btn btn-danger" title="{% trans 'حذف' %}">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center">{% trans "لا توجد خدمات مابعد الطباعة" %}</p>
                {% endif %}
            </div>
        </div>
        
        <!-- المصاريف الإضافية -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{% trans "المصاريف الإضافية" %}</h5>
                <a href="{% url 'extra_expense_add' order.pk %}" class="btn btn-sm btn-light">
                    <i class="fas fa-plus"></i> {% trans "إضافة مصروف إضافي" %}
                </a>
            </div>
            <div class="card-body">
                {% if extra_expenses %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>{% trans "المصروف" %}</th>
                                <th>{% trans "الوصف" %}</th>
                                <th>{% trans "المبلغ" %}</th>
                                <th>{% trans "الإجراءات" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in extra_expenses %}
                            <tr>
                                <td>{{ expense.name }}</td>
                                <td>{{ expense.description|default:"-" }}</td>
                                <td>{{ expense.amount }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{% url 'extra_expense_edit' expense.pk %}" class="btn btn-warning" title="{% trans 'تعديل' %}">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'extra_expense_delete' expense.pk %}" class="btn btn-danger" title="{% trans 'حذف' %}">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center">{% trans "لا توجد مصاريف إضافية" %}</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- ملخص التكاليف -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">{% trans "ملخص التكاليف" %}</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <th>{% trans "تكلفة الخامات" %}</th>
                            <td class="text-end">{{ order.material_cost }}</td>
                        </tr>
                        <tr>
                            <th>{% trans "تكلفة الطباعة" %}</th>
                            <td class="text-end">{{ order.printing_cost }}</td>
                        </tr>
                        <tr>
                            <th>{% trans "تكلفة خدمات مابعد الطباعة" %}</th>
                            <td class="text-end">{{ order.finishing_cost }}</td>
                        </tr>
                        <tr>
                            <th>{% trans "تكاليف إضافية" %}</th>
                            <td class="text-end">{{ order.extra_cost }}</td>
                        </tr>
                        <tr class="table-secondary">
                            <th>{% trans "إجمالي التكلفة" %}</th>
                            <td class="text-end"><strong>{{ order.total_cost }}</strong></td>
                        </tr>
                        <tr>
                            <th>{% trans "هامش الربح (%)" %}</th>
                            <td class="text-end">{{ order.profit_margin }}%</td>
                        </tr>
                        <tr class="table-success">
                            <th>{% trans "سعر البيع" %}</th>
                            <td class="text-end"><strong>{{ order.sale_price }}</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- التعليقات -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">{% trans "التعليقات" %}</h5>
            </div>
            <div class="card-body">
                {% if comments %}
                <div class="comments-list">
                    {% for comment in comments %}
                    <div class="comment mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %}">
                        <div class="d-flex justify-content-between mb-2">
                            <div><strong>{{ comment.user.get_full_name }}</strong></div>
                            <small class="text-muted">{{ comment.created_at|date:"Y-m-d H:i" }}</small>
                        </div>
                        <div>{{ comment.comment }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-center">{% trans "لا توجد تعليقات" %}</p>
                {% endif %}
                
                <form method="post" action="{% url 'order_comment_add' order.pk %}" class="mt-3">
                    {% csrf_token %}
                    {% bootstrap_form comment_form %}
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-comment"></i> {% trans "إضافة تعليق" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %} 