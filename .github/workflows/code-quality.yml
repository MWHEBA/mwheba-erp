name: ğŸ¯ Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-quality-${{ hashFiles('**/requirements.txt') }}

    - name: ğŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 black isort mypy pylint radon

    - name: ğŸ¨ Code formatting check (Black)
      run: |
        echo "ğŸ¨ Checking code formatting..."
        black --check --diff --color .
      continue-on-error: true

    - name: ğŸ“¦ Import sorting check (isort)
      run: |
        echo "ğŸ“¦ Checking import sorting..."
        isort --check-only --diff --color .
      continue-on-error: true

    - name: ğŸ” Linting (flake8)
      run: |
        echo "ğŸ” Running flake8 linting..."
        flake8 . --statistics --tee --output-file=flake8-report.txt
      continue-on-error: true

    - name: ğŸ”¬ Type checking (mypy)
      run: |
        echo "ğŸ”¬ Running type checking..."
        mypy . --ignore-missing-imports --show-error-codes || true
      continue-on-error: true

    - name: ğŸ“Š Code complexity (radon)
      run: |
        echo "ğŸ“Š Analyzing code complexity..."
        radon cc . --min B --show-complexity
        radon mi . --min B
      continue-on-error: true

    - name: ğŸ† Code quality score (pylint)
      run: |
        echo "ğŸ† Calculating code quality score..."
        find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" | head -20 | xargs pylint --output-format=text --reports=yes || true
      continue-on-error: true

    - name: ğŸ“ˆ Upload quality reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: quality-reports
        path: |
          flake8-report.txt

  django-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ”§ Install Django
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: âœ… Django system check
      run: |
        echo "âœ… Running Django system checks..."
        python manage.py check --deploy

    - name: ğŸ” Check for missing migrations
      run: |
        echo "ğŸ” Checking for missing migrations..."
        python manage.py makemigrations --check --dry-run

    - name: ğŸ›¡ï¸ Security check
      run: |
        echo "ğŸ›¡ï¸ Running Django security checks..."
        python manage.py check --deploy --fail-level WARNING

  documentation:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ“š Install documentation tools
      run: |
        pip install pydocstyle interrogate

    - name: ğŸ“– Check docstring coverage
      run: |
        echo "ğŸ“– Checking docstring coverage..."
        interrogate . --ignore-init-method --ignore-init-module --ignore-magic --ignore-nested-functions --fail-under=50 || true

    - name: ğŸ“ Check docstring style
      run: |
        echo "ğŸ“ Checking docstring style..."
        pydocstyle . --count || true
