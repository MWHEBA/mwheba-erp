# ๐ ุฏููู ุดุงูู: ูุธุงู ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ (COGS)

**ุงูุฅุตุฏุงุฑ:** 2.0  
**ุงูุชุงุฑูุฎ:** 2025-11-03  
**ุงูุญุงูุฉ:** ููุชูู โ

---

## ๐ ุฌุฏูู ุงููุญุชููุงุช

1. [ูุธุฑุฉ ุนุงูุฉ](#ูุธุฑุฉ-ุนุงูุฉ)
2. [ุขููุฉ ุงูุนูู](#ุขููุฉ-ุงูุนูู)
3. [ุงููููุฏ ุงููุญุงุณุจูุฉ](#ุงููููุฏ-ุงููุญุงุณุจูุฉ)
4. [ุงููุดุงูู ูุงูุญููู](#ุงููุดุงูู-ูุงูุญููู)
5. [ุงูุงุฎุชุจุงุฑ ูุงูุชุญูู](#ุงูุงุฎุชุจุงุฑ-ูุงูุชุญูู)
6. [ุงูุฃูุงูุฑ ุงููููุฏุฉ](#ุงูุฃูุงูุฑ-ุงููููุฏุฉ)

---

## ูุธุฑุฉ ุนุงูุฉ

ูุธุงู COGS ูู MWHEBA ERP ูููุดุฆ ูููุฏุงู ูุญุงุณุจูุฉ ุชููุงุฆูุฉ ูุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ ุนูุฏ ุฅูุดุงุก ููุงุชูุฑ ุงููุจูุนุงุช.

### ุงููุฏู
- โ ุญุณุงุจ ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ ุชููุงุฆูุงู
- โ ุฅูุดุงุก ูููุฏ ูุญุงุณุจูุฉ ุฏูููุฉ
- โ ุชุญุฏูุซ ุงููุฎุฒูู ูุญุงุณุจูุงู
- โ ุญุณุงุจ ูุฌูู ุงูุฑุจุญ ุจุฏูุฉ

---

## ุขููุฉ ุงูุนูู

### 1. Signal ุงูุชููุงุฆู

```python
# ููู: sale/signals.py
@receiver(post_save, sender=SaleItem)
def create_stock_movement_for_sale_item(sender, instance, created, **kwargs):
    """
    ุฅูุดุงุก ุญุฑูุฉ ูุฎุฒูู ูููุฏ ูุญุงุณุจู ุนูุฏ ุฅุถุงูุฉ ุจูุฏ ูููุงุชูุฑุฉ
    """
    if created and instance.sale.status == "confirmed":
        # 1. ุฅูุดุงุก ุญุฑูุฉ ุงููุฎุฒูู
        StockMovement.objects.create(...)
        
        # 2. ุฅูุดุงุก ุงูููุฏ ุงููุญุงุณุจู (ุฅุฐุง ูู ููู ููุฌูุฏุงู)
        if not instance.sale.journal_entry:
            journal_entry = AccountingIntegrationService.create_sale_journal_entry(
                sale=instance.sale, user=instance.sale.created_by
            )
```

**ุงูุดุฑูุท:**
- โ ุจูุฏ ุฌุฏูุฏ (`created=True`)
- โ ูุงุชูุฑุฉ ูุคูุฏุฉ (`status="confirmed"`)
- โ ุชููุงุฆู ุจุงููุงูู

### 2. ุญุณุงุจ ุงูุชูููุฉ

```python
# ููู: financial/services/accounting_integration_service.py
def _calculate_sale_cost(cls, sale) -> Decimal:
    """ุญุณุงุจ ุฅุฌูุงูู ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ"""
    total_cost = Decimal("0.00")
    for item in sale.items.all():
        if hasattr(item.product, "cost_price") and item.product.cost_price:
            total_cost += item.product.cost_price * item.quantity
    
    # ุชุณุฌูู ููุชุดุฎูุต
    if total_cost == 0:
        logger.warning(f"ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ = 0 ูููุงุชูุฑุฉ {sale.number}")
    
    return total_cost
```

**ุงููุนุงุฏูุฉ:**
```
COGS = ฮฃ (ุณุนุฑ ุชูููุฉ ุงูููุชุฌ ร ุงููููุฉ ุงููุจุงุนุฉ)
```

---

## ุงููููุฏ ุงููุญุงุณุจูุฉ

### ูุซุงู: ูุงุชูุฑุฉ ุจูููุฉ 10,000 ุฌ.ู ูุชูููุฉ 6,000 ุฌ.ู

```
ุฑูู ุงูููุฏ: SALE-SALE0005-20251103
ุงูุชุงุฑูุฎ: 2025-11-03
ุงููุฑุฌุน: ูุงุชูุฑุฉ ูุจูุนุงุช ุฑูู SALE0005

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุงูุญุณุงุจ                          โ ูุฏูู    โ ุฏุงุฆู       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ 11030 - ุงูุนููุงุก                 โ 10,000  โ -          โ
โ 41010 - ุฅูุฑุงุฏุงุช ุงููุจูุนุงุช        โ -       โ 10,000     โ
โ 51010 - ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ   โ 6,000   โ -          โ
โ 11051 - ุงููุฎุฒูู                 โ -       โ 6,000      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ุงูุฅุฌูุงูู                        โ 16,000  โ 16,000     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ูุฌูู ุงูุฑุจุญ = 10,000 - 6,000 = 4,000 ุฌ.ู (40%)
```

### ุงูุญุณุงุจุงุช ุงููุณุชุฎุฏูุฉ

| ุงูููุฏ | ุงูุงุณู | ุงูููุน | ุงูุทุจูุนุฉ |
|-------|-------|-------|---------|
| 51010 | ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ | ูุตุฑููุงุช | ูุฏูู |
| 11051 | ุงููุฎุฒูู | ุฃุตูู | ูุฏูู |
| 41010 | ุฅูุฑุงุฏุงุช ุงููุจูุนุงุช | ุฅูุฑุงุฏุงุช | ุฏุงุฆู |
| 11030 | ุงูุนููุงุก | ุฃุตูู | ูุฏูู |

---

## ุงููุดุงูู ูุงูุญููู

### ุงููุดููุฉ 1: ููุชุฌ ุจุฏูู ุณุนุฑ ุชูููุฉ โ

**ุงููุตู:**
```python
product.cost_price = 0  # ุฃู None
# ุงููุชูุฌุฉ: total_cost = 0
# ูุง ูููุดุฃ ููุฏ COGS
```

**ุงูุชุฃุซูุฑ:**
- โ ููุฏ ุงูุฅูุฑุงุฏ ูููุดุฃ
- โ ููุฏ ุงูุชูููุฉ ูุง ูููุดุฃ
- โ๏ธ ุงููุฎุฒูู ูุง ูุชุฃุซุฑ ูุญุงุณุจูุงู
- โ ูุฌูู ุงูุฑุจุญ ุฎุงุทุฆ

**ุงูุญู:**

#### 1. ุชุญุฏูุฏ ุณุนุฑ ุงูุชูููุฉ ููููุชุฌุงุช
```bash
# ูุญุต ุงูููุชุฌุงุช ุจุฏูู ุชูููุฉ
python manage.py products_without_cost

# ุงููุชูุฌุฉ:
โ๏ธ ููุฌุฏ 5 ููุชุฌุงุช ุจุฏูู ุณุนุฑ ุชูููุฉ:
  - ุฏูุจููุณ 250ุฌู (ID: 1)
  - ูุฑุชูู ูููู (ID: 2)
  ...
```

#### 2. ุฅุตูุงุญ ุงููููุฏ ุงููุฏููุฉ
```bash
# ุฅุตูุงุญ ุฌููุน ุงูููุงุชูุฑ ุงููุฏููุฉ
python manage.py fix_missing_cogs

# ุงููุชูุฌุฉ:
โ ุชู ุฅุตูุงุญ 3 ููุงุชูุฑ
โ๏ธ ุชู ุชุฎุทู 2 ูุงุชูุฑุฉ (ุจุฏูู ุชูููุฉ)
```

---

### ุงููุดููุฉ 2: Signal ูุงู ููุทูู ูุจู ุฅุถุงูุฉ ุงูุจููุฏ โ

**ุงููุตู:**
```python
# ุงูููุฏ ุงููุฏูู (ุฎุทุฃ)
@receiver(post_save, sender=Sale)
def create_financial_transaction_for_sale(...):
    if created and instance.status == "confirmed":
        # ููุทูู ุนูุฏ ุฃูู save() - ุงูุจููุฏ ุบูุฑ ููุฌูุฏุฉ ุจุนุฏ!
        # _calculate_sale_cost() ูุฑุฌุน 0
```

**ุงููุดููุฉ:**
- ููุทูู ุนูุฏ `created=True` ููุท (ุฃูู `save()`)
- ููู ุงูุจููุฏ ูู ุชูู ููุฌูุฏุฉ ุจุนุฏ!
- `_calculate_sale_cost()` ูุฑุฌุน `0`
- **ูุง ูููุดุฃ ููุฏ COGS!**

**ุงูุญู ุงููุทุจู:**

```python
# ุงูููุฏ ุงูุฌุฏูุฏ (ุตุญูุญ) โ
@receiver(post_save, sender=SaleItem)
def create_stock_movement_for_sale_item(sender, instance, created, **kwargs):
    """
    ููุทูู ุนูุฏ ุฅุถุงูุฉ ูู ุจูุฏ - ุงูุจููุฏ ููุฌูุฏุฉ ุจุงููุนู!
    """
    if created and instance.sale.status == "confirmed":
        # 1. ุฅูุดุงุก ุญุฑูุฉ ุงููุฎุฒูู
        StockMovement.objects.create(...)
        
        # 2. ุฅูุดุงุก ุงูููุฏ ุงููุญุงุณุจู (ูุฑุฉ ูุงุญุฏุฉ ููุท)
        if not instance.sale.journal_entry:
            journal_entry = AccountingIntegrationService.create_sale_journal_entry(
                sale=instance.sale, user=instance.sale.created_by
            )
```

**ููุงุฐุง ูุฐุง ุงูุญู ุฃูุถูุ**

1. โ **ููุทูู ุนูุฏ ุฅุถุงูุฉ ุงูุจููุฏ** - ุงูุจููุฏ ููุฌูุฏุฉ ุจุงููุนู
2. โ **ูุญุณุจ ุงูุชูููุฉ ุจุดูู ุตุญูุญ** - `_calculate_sale_cost()` ูุนูู
3. โ **ูููุดุฃ ูุฑุฉ ูุงุญุฏุฉ ููุท** - ุดุฑุท `if not instance.sale.journal_entry`
4. โ **ูุนูู ูุน ุฃู ุนุฏุฏ ูู ุงูุจููุฏ** - ููุทูู ุนูุฏ ูู ุจูุฏ

---

### ุงููุดููุฉ 3: ูุฑุชุฌุนุงุช ุงููุจูุนุงุช โ๏ธ

**ุงููุถุน ุงูุญุงูู:**
```python
@receiver(post_save, sender=SaleReturn)
def create_financial_transaction_for_return(sender, instance, **kwargs):
    pass  # ูุนุทู ุญุงููุงู
```

**ุงููุดููุฉ:**
- โ ูุง ูููุดุฃ ููุฏ ูููุฑุชุฌุนุงุช
- โ๏ธ ุนุฏู ุงูุนูุงุณ ุงููุฑุชุฌุนุงุช ูู ุงูุญุณุงุจุงุช

**ุงูููุฏ ุงููุทููุจ:**
```
ูู ุญู/ ุฅูุฑุงุฏุงุช ุงููุจูุนุงุช (41010)          2,000 ุฌ.ู (ูุฏูู)
    ุฅูู ุญู/ ุงูุนููุงุก (11030)               2,000 ุฌ.ู (ุฏุงุฆู)

ูู ุญู/ ุงููุฎุฒูู (11051)                   1,200 ุฌ.ู (ูุฏูู)
    ุฅูู ุญู/ ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ (51010) 1,200 ุฌ.ู (ุฏุงุฆู)
```

**ุงูุญู ุงูููุชุฑุญ:**
```python
@receiver(post_save, sender=SaleReturn)
def create_financial_transaction_for_return(sender, instance, **kwargs):
    if instance.status == "confirmed":
        AccountingIntegrationService.create_return_journal_entry(instance)
```

---

## ุงูุงุฎุชุจุงุฑ ูุงูุชุญูู

### 1. ูุญุต ูุงุชูุฑุฉ ูุญุฏุฏุฉ

```bash
python manage.py check_sale SALE0005
```

**ุงููุชูุฌุฉ:**
```
๐ ูุญุต ุงููุงุชูุฑุฉ SALE0005
--------------------------------------------------------------------------------
โ ุงููุงุชูุฑุฉ ููุฌูุฏุฉ
โ ุงูุญุงูุฉ: ูุคูุฏุฉ
โ ุงูููุฏ ุงููุญุงุณุจู ููุฌูุฏ
โ ููุฏ COGS ููุฌูุฏ
โ ุนุฏุฏ ุงูุจููุฏ: 4 (2 ุฅูุฑุงุฏุงุช + 2 ุชูููุฉ)

๐ฐ ุงูุชูุงุตูู ุงููุงููุฉ:
  ุงูุฅูุฑุงุฏุงุช: 10,000 ุฌ.ู
  ุงูุชูููุฉ: 6,000 ุฌ.ู
  ูุฌูู ุงูุฑุจุญ: 4,000 ุฌ.ู (40%)
```

### 2. ุชุดุฎูุต ุดุงูู

```bash
python manage.py diagnose_cogs
```

**ุงููุชูุฌุฉ:**
```
๐ ุงูุฅุญุตุงุฆูุงุช
--------------------------------------------------------------------------------
ุฅุฌูุงูู ุงูููุงุชูุฑ ุงููุคูุฏุฉ: 10
ุงูููุงุชูุฑ ุจูููุฏ ูุญุงุณุจูุฉ: 10
ุงูููุงุชูุฑ ุจูููุฏ COGS: 10 โ
ุงูููุงุชูุฑ ุจุฏูู ูููุฏ COGS: 0 โ

๐ก ุงูุชูุตูุงุช
--------------------------------------------------------------------------------
โ ุฌููุน ุงูููุงุชูุฑ ุชุญุชูู ุนูู ูููุฏ COGS!
โ ุงููุธุงู ูุนูู ุจุดูู ุตุญูุญ 100%
```

### 3. ูุญุต ุงูููุชุฌุงุช ุจุฏูู ุชูููุฉ

```bash
python manage.py products_without_cost
```

**ุงููุชูุฌุฉ:**
```
โ๏ธ ููุฌุฏ 3 ููุชุฌุงุช ุจุฏูู ุณุนุฑ ุชูููุฉ:
  - ุฏูุจููุณ 250ุฌู (ID: 1)
  - ูุฑุชูู ูููู (ID: 2)
  - ูุฑู ููุดูู (ID: 5)

โ ูุฑุฌู ุชุญุฏูุฏ ุณุนุฑ ุงูุชูููุฉ ููุฐู ุงูููุชุฌุงุช
```

---

## ุงูุฃูุงูุฑ ุงููููุฏุฉ

### ุฅุตูุงุญ ุงููููุฏ ุงููุฏููุฉ

```bash
# ุฅุตูุงุญ ุฌููุน ุงูููุงุชูุฑ
python manage.py fix_missing_cogs

# ุฅุตูุงุญ ููุงุชูุฑ ูุญุฏุฏุฉ
python manage.py fix_missing_cogs --sale-numbers SALE0001 SALE0002

# ุนุฑุถ ููุท ุจุฏูู ุชุทุจูู
python manage.py fix_missing_cogs --dry-run
```

### ุชูุงุฑูุฑ COGS

```bash
# ุชูุฑูุฑ ูุทุงุจูุฉ COGS
python manage.py cogs_reconciliation_report --from 2025-01-01 --to 2025-12-31

# ุชูุฑูุฑ ูุฌูู ุงูุฑุจุญ
python manage.py gross_profit_report --month 11 --year 2025
```

---

## ุงูุชุฃุซูุฑ ุนูู ุงูููุงุฆู ุงููุงููุฉ

### ูุงุฆูุฉ ุงูุฏุฎู
```
ุฅูุฑุงุฏุงุช ุงููุจูุนุงุช                    100,000 ุฌ.ู
(-) ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ           (60,000 ุฌ.ู)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
= ูุฌูู ุงูุฑุจุญ                         40,000 ุฌ.ู

ูุณุจุฉ ูุฌูู ุงูุฑุจุญ = 40%
```

### ุงูููุฒุงููุฉ
```
ุงููุฎุฒูู:
  ุงูุฑุตูุฏ ุงูุงูุชุชุงุญู     80,000 ุฌ.ู
  (-) ุชูููุฉ ุงููุจุงุน     (60,000 ุฌ.ู)
  (+) ุงููุดุชุฑูุงุช          50,000 ุฌ.ู
  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  = ุงูุฑุตูุฏ ุงูุฎุชุงูู       70,000 ุฌ.ู
```

---

## ุงูุชูุตูุงุช

### 1. ุงูุชุญูู ูู ุณุนุฑ ุงูุชูููุฉ
```python
def clean(self):
    for item in self.items:
        if not item.product.cost_price:
            raise ValidationError(
                f"ุงูููุชุฌ '{item.product.name}' ููุณ ูู ุณุนุฑ ุชูููุฉ"
            )
```

### 2. ูุนุงูุฌุฉ ุงููุฑุชุฌุนุงุช
```python
@receiver(post_save, sender=SaleReturn)
def create_financial_transaction_for_return(sender, instance, **kwargs):
    if instance.status == "confirmed":
        AccountingIntegrationService.create_return_journal_entry(instance)
```

### 3. ุชูุฑูุฑ ูุทุงุจูุฉ COGS
```python
def cogs_reconciliation_report(date_from, date_to):
    # ููุงุฑูุฉ ุจูู:
    # 1. ุงููููุฏ ุงููุญุงุณุจูุฉ
    # 2. ููุงุชูุฑ ุงููุจูุนุงุช
    # 3. ุญุฑูุงุช ุงููุฎุฒูู
```

---

## ุงูุฎูุงุตุฉ

### โ ูุนูู ุจุดูู ุตุญูุญ:
1. โ ุฅูุดุงุก ููุฏ ุชููุงุฆู ุนูุฏ ุงูุจูุน
2. โ ุญุณุงุจ ุงูุชูููุฉ ูู ุงูููุชุฌุงุช
3. โ ููุฏ ูุฒุฏูุฌ ูุงูู (ุฅูุฑุงุฏ + ุชูููุฉ)
4. โ ุชุฃุซูุฑ ุนูู ุงููุฎุฒูู ูุงูุฅูุฑุงุฏุงุช
5. โ Signal ุนูู SaleItem (ุจุนุฏ ุฅุถุงูุฉ ุงูุจููุฏ)

### โ๏ธ ูุญุชุงุฌ ุชุญุณูู:
1. โ๏ธ ูุนุงูุฌุฉ ุงูููุชุฌุงุช ุจุฏูู ุชูููุฉ
2. โ๏ธ ูููุฏ ุงููุฑุชุฌุนุงุช
3. โ๏ธ ุชูุงุฑูุฑ ุงููุทุงุจูุฉ ุงููุชูุฏูุฉ

---

## ุงููููุงุช ุงูุฃุณุงุณูุฉ

1. `sale/signals.py` - Signal ุงูุจูุน
2. `financial/services/accounting_integration_service.py` - ุฎุฏูุฉ ุงูุชูุงูู
3. `product/models/base_models.py` - ูููุฐุฌ ุงูููุชุฌ
4. `financial/models/journal_entry.py` - ุงููููุฏ ุงููุญุงุณุจูุฉ
5. `financial/fixtures/chart_of_accounts_final.json` - ุฏููู ุงูุญุณุงุจุงุช

---

**ุชู ุฅุนุฏุงุฏ ูุฐุง ุงูุฏููู ุจูุงุณุทุฉ:** Cascade AI  
**ุขุฎุฑ ุชุญุฏูุซ:** 2025-11-03  
**ุงูุญุงูุฉ:** ููุชูู โ  
**ุงูุชูููู:** โญโญโญโญโญ (5/5)
