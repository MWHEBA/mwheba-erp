# ุชุญููู ุดุงูู: ููุฏ ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ (COGS)

## ๐ ุงููุธุงู ุงูุญุงูู

### ุขููุฉ ุงูุนูู ุงูุชููุงุฆูุฉ

```python
# ููู: sale/signals.py
@receiver(post_save, sender=Sale)
def create_financial_transaction_for_sale(sender, instance, created, **kwargs):
    """ุฅูุดุงุก ููุฏ ูุญุงุณุจู ุชููุงุฆู ุนูุฏ ุชุฃููุฏ ูุงุชูุฑุฉ ุงููุจูุนุงุช"""
    if created and instance.status == "confirmed":
        journal_entry = AccountingIntegrationService.create_sale_journal_entry(
            sale=instance, user=instance.created_by
        )
```

**ุงูุดุฑูุท:**
- โ ูุงุชูุฑุฉ ุฌุฏูุฏุฉ (`created=True`)
- โ ุญุงูุฉ ูุคูุฏุฉ (`status="confirmed"`)
- โ ุชููุงุฆู ุจุงููุงูู

---

## ๐ ุงููููุฏ ุงููุญุงุณุจูุฉ

### ูุซุงู: ูุงุชูุฑุฉ ุจูููุฉ 10,000 ุฌ.ู ูุชูููุฉ 6,000 ุฌ.ู

```
ูู ุญู/ ุงูุนููุงุก (11030)                    10,000 ุฌ.ู (ูุฏูู)
    ุฅูู ุญู/ ุฅูุฑุงุฏุงุช ุงููุจูุนุงุช (41010)      10,000 ุฌ.ู (ุฏุงุฆู)

ูู ุญู/ ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ (51010)      6,000 ุฌ.ู (ูุฏูู)
    ุฅูู ุญู/ ุงููุฎุฒูู (11051)                6,000 ุฌ.ู (ุฏุงุฆู)
```

---

## ๐ฐ ุญุณุงุจ ุงูุชูููุฉ

```python
# ููู: financial/services/accounting_integration_service.py
def _calculate_sale_cost(cls, sale) -> Decimal:
    total_cost = Decimal("0.00")
    for item in sale.items.all():
        if hasattr(item.product, "cost_price") and item.product.cost_price:
            total_cost += item.product.cost_price * item.quantity
    return total_cost
```

**ุงููุนุงุฏูุฉ:**
```
COGS = ฮฃ (ุณุนุฑ ุชูููุฉ ุงูููุชุฌ ร ุงููููุฉ ุงููุจุงุนุฉ)
```

---

## ๐ ุงูุญุณุงุจุงุช ุงููุณุชุฎุฏูุฉ

| ุงูููุฏ | ุงูุงุณู | ุงูููุน | ุงูุทุจูุนุฉ |
|-------|-------|-------|---------|
| 51010 | ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ | ูุตุฑููุงุช | ูุฏูู |
| 11051 | ุงููุฎุฒูู | ุฃุตูู | ูุฏูู |
| 41010 | ุฅูุฑุงุฏุงุช ุงููุจูุนุงุช | ุฅูุฑุงุฏุงุช | ุฏุงุฆู |
| 11030 | ุงูุนููุงุก | ุฃุตูู | ูุฏูู |

---

## โ๏ธ ุงููุดุงูู ุงููุญุชููุฉ

### 1. ููุชุฌ ุจุฏูู ุณุนุฑ ุชูููุฉ

**ุงููุดููุฉ:**
```python
product.cost_price = 0  # ุฃู None
# ุงููุชูุฌุฉ: total_cost = 0
# ูุง ูููุดุฃ ููุฏ COGS
```

**ุงูุชุฃุซูุฑ:**
- โ ููุฏ ุงูุฅูุฑุงุฏ ูููุดุฃ
- โ ููุฏ ุงูุชูููุฉ ูุง ูููุดุฃ
- โ๏ธ ุงููุฎุฒูู ูุง ูุชุฃุซุฑ ูุญุงุณุจูุงู

**ุงูุญู:**
```python
# ูุณุฌู ุชุญุฐูุฑ ูู logs
logger.warning(f"ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ = 0 ูููุงุชูุฑุฉ {sale.number}")
```

**ุงูุชูุตูุฉ:**
- ุฅุถุงูุฉ validation ูู ูููุฐุฌ ุงูุจูุน
- ุชูุจูู ุงููุณุชุฎุฏู ูุจู ุงูุจูุน
- ุชูุฑูุฑ ุฏูุฑู ุจุงูููุชุฌุงุช ุจุฏูู ุชูููุฉ

---

### 2. ุชุนุฏูู ุงููุงุชูุฑุฉ ุจุนุฏ ุงูุฅูุดุงุก

**ุงููุดููุฉ:**
```python
sale.items.add(new_item)  # ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ
sale.save()
# Signal ูุง ูุนูู (created=False)
```

**ุงูุชุฃุซูุฑ:**
- โ ุงูููุฏ ุงููุญุงุณุจู ูุง ูุชุญุฏุซ
- โ๏ธ ุนุฏู ุชุทุงุจู ุจูู ุงููุงุชูุฑุฉ ูุงูููุฏ

**ุงูุชูุตูุงุช:**
1. ููุน ุงูุชุนุฏูู ุจุนุฏ ุงูุชุฃููุฏ
2. ุฅุถุงูุฉ signal ููุชุญุฏูุซ
3. ุฅูุบุงุก ุงูููุฏ ุงููุฏูู ูุฅูุดุงุก ุฌุฏูุฏ

---

### 3. ูุฑุชุฌุนุงุช ุงููุจูุนุงุช

**ุงููุถุน ุงูุญุงูู:**
```python
@receiver(post_save, sender=SaleReturn)
def create_financial_transaction_for_return(sender, instance, **kwargs):
    pass  # ูุนุทู ุญุงููุงู
```

**ุงููุดููุฉ:**
- โ ูุง ูููุดุฃ ููุฏ ูููุฑุชุฌุนุงุช
- โ๏ธ ุนุฏู ุงูุนูุงุณ ุงููุฑุชุฌุนุงุช ูู ุงูุญุณุงุจุงุช

**ุงูููุฏ ุงููุทููุจ:**
```
ูู ุญู/ ุฅูุฑุงุฏุงุช ุงููุจูุนุงุช (41010)          2,000 ุฌ.ู (ูุฏูู)
    ุฅูู ุญู/ ุงูุนููุงุก (11030)               2,000 ุฌ.ู (ุฏุงุฆู)

ูู ุญู/ ุงููุฎุฒูู (11051)                   1,200 ุฌ.ู (ูุฏูู)
    ุฅูู ุญู/ ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ (51010) 1,200 ุฌ.ู (ุฏุงุฆู)
```

---

## ๐ ุงูุชุฃุซูุฑ ุนูู ุงูููุงุฆู ุงููุงููุฉ

### ูุงุฆูุฉ ุงูุฏุฎู
```
ุฅูุฑุงุฏุงุช ุงููุจูุนุงุช                    100,000 ุฌ.ู
(-) ุชูููุฉ ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ           (60,000 ุฌ.ู)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
= ูุฌูู ุงูุฑุจุญ                         40,000 ุฌ.ู

ูุณุจุฉ ูุฌูู ุงูุฑุจุญ = 40%
```

### ุงูููุฒุงููุฉ
```
ุงููุฎุฒูู:
  ุงูุฑุตูุฏ ุงูุงูุชุชุงุญู     80,000 ุฌ.ู
  (-) ุชูููุฉ ุงููุจุงุน     (60,000 ุฌ.ู)
  (+) ุงููุดุชุฑูุงุช          50,000 ุฌ.ู
  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  = ุงูุฑุตูุฏ ุงูุฎุชุงูู       70,000 ุฌ.ู
```

---

## ๐ฏ ุงูุชูุตูุงุช

### 1. ุงูุชุญูู ูู ุณุนุฑ ุงูุชูููุฉ
```python
def clean(self):
    for item in self.items:
        if not item.product.cost_price:
            raise ValidationError(
                f"ุงูููุชุฌ '{item.product.name}' ููุณ ูู ุณุนุฑ ุชูููุฉ"
            )
```

### 2. ูุนุงูุฌุฉ ุงููุฑุชุฌุนุงุช
```python
@receiver(post_save, sender=SaleReturn)
def create_financial_transaction_for_return(sender, instance, **kwargs):
    if instance.status == "confirmed":
        AccountingIntegrationService.create_return_journal_entry(instance)
```

### 3. ุชูุฑูุฑ ูุทุงุจูุฉ COGS
```python
def cogs_reconciliation_report(date_from, date_to):
    # ููุงุฑูุฉ ุจูู:
    # 1. ุงููููุฏ ุงููุญุงุณุจูุฉ
    # 2. ููุงุชูุฑ ุงููุจูุนุงุช
    # 3. ุญุฑูุงุช ุงููุฎุฒูู
```

---

## โ ุงูุฎูุงุตุฉ

### ูุนูู ุจุดูู ุตุญูุญ:
1. โ ุฅูุดุงุก ููุฏ ุชููุงุฆู ุนูุฏ ุงูุจูุน
2. โ ุญุณุงุจ ุงูุชูููุฉ ูู ุงูููุชุฌุงุช
3. โ ููุฏ ูุฒุฏูุฌ ูุงูู (ุฅูุฑุงุฏ + ุชูููุฉ)
4. โ ุชุฃุซูุฑ ุนูู ุงููุฎุฒูู ูุงูุฅูุฑุงุฏุงุช

### ูุญุชุงุฌ ุชุญุณูู:
1. โ๏ธ ูุนุงูุฌุฉ ุงูููุชุฌุงุช ุจุฏูู ุชูููุฉ
2. โ๏ธ ุชุนุฏูู ุงูููุงุชูุฑ ุจุนุฏ ุงูุฅูุดุงุก
3. โ๏ธ ูููุฏ ุงููุฑุชุฌุนุงุช
4. โ๏ธ ุชูุงุฑูุฑ ุงููุทุงุจูุฉ

---

## ๐ ุงููููุงุช ุงูุฃุณุงุณูุฉ

1. `sale/signals.py` - Signal ุงูุจูุน
2. `financial/services/accounting_integration_service.py` - ุฎุฏูุฉ ุงูุชูุงูู
3. `product/models/base_models.py` - ูููุฐุฌ ุงูููุชุฌ
4. `financial/models/journal_entry.py` - ุงููููุฏ ุงููุญุงุณุจูุฉ
5. `financial/fixtures/chart_of_accounts_final.json` - ุฏููู ุงูุญุณุงุจุงุช
